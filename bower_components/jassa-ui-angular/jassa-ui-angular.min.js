/*
 * jassa-ui-angular
 * https://github.com/GeoKnow/Jassa-UI-Angular

 * Version: 0.0.1-SNAPSHOT - 2014-05-02
 * License: MIT
 */
angular.module("ui.jassa",["ui.jassa.constraint-list","ui.jassa.facet-tree","ui.jassa.facet-value-list","ui.jassa.sparql-table","ui.jassa.template-list"]),angular.module("ui.jassa.constraint-list",[]).controller("ConstraintListCtrl",["$scope","$rootScope",function(a){var b=this,c=function(){var b=a.facetTreeConfig;a.constraintManager=b?a.facetTreeConfig.getFacetConfig().getConstraintManager():null},d=function(){c(),b.refresh()};a.ObjectUtils=Jassa.util.ObjectUtils;var e="[ObjectUtils.hashCode(sparqlService), ObjectUtils.hashCode(facetTreeConfig)]";a.$watch(e,function(){d()},!0);var f=function(a){var b,c=a.getName();switch(c){case"equal":var d=""+a.getDeclaredPath();""===d&&(d="()"),b=d+" = "+a.getValue();break;default:b=a}return b};b.refresh=function(){var b,c=a.constraintManager;if(c){var d=c.getConstraints();b=_(d).map(function(a){var b={constraint:a,label:""+f(a)};return b})}else b=[];a.constraints=b},a.removeConstraint=function(b){a.constraintManager.removeConstraint(b.constraint)}}]).directive("constraintList",function(){return{restrict:"EA",replace:!0,templateUrl:"template/constraint-list/constraint-list.html",transclude:!1,require:"constraintList",scope:{sparqlService:"=",facetTreeConfig:"=",onSelect:"&select"},controller:"ConstraintListCtrl"}}),angular.module("ui.jassa.facet-tree",[]).controller("FacetTreeDirContentCtrl",["$rootScope","$scope","$q",function(){}]).directive("facetTreeDirContent",function(){return{restrict:"EA",replace:!0,templateUrl:"template/facet-tree/facet-tree-content.html",transclude:!1,require:"facetTree",scope:{sparqlService:"=",facetTreeConfig:"=",plugins:"=",onSelect:"&select"},controller:"FacetTreeDirContentCtrl",compile:function(){return function(){}}}}),angular.module("ui.jassa.facet-tree",["ui.jassa.template-list"]).controller("FacetTreeCtrl",["$rootScope","$scope","$q",function(a,b,c){var d=this,e=function(){var a=b.sparqlService&&b.facetTreeConfig;b.facetTreeService=a?Jassa.facete.FaceteUtils.createFacetTreeService(b.sparqlService,b.facetTreeConfig,null):null},f=function(){e(),d.refresh()};b.setFacetHover=function(a,b){a.isHovered=b,a.incoming&&(a.incoming.isHovered=b),a.outgoing&&(a.outgoing.isHovered=b)},b.ObjectUtils=Jassa.util.ObjectUtils;var g="[ObjectUtils.hashCode(sparqlService), ObjectUtils.hashCode(facetTreeConfig)]";b.$watch(g,function(){f()},!0),b.doFilter=function(a,c){b.facetTreeConfig.getPathToFilterString().put(a,c),d.refresh()},d.refresh=function(){var d=b.facet,e=d?d.item.getPath():new Jassa.facete.Path;if(b.facetTreeService){var f=Jassa.facete.FaceteUtils.createFacetTreeTagger(b.facetTreeConfig.getPathToFilterString()),g=b.facetTreeService.fetchFacetTree(e);Jassa.sponate.angular.bridgePromise(g,c.defer(),a).then(function(a){f.applyTags(a),b.facet=a})}else b.facet=null},b.toggleCollapsed=function(a){Jassa.util.CollectionUtils.toggleItem(b.facetTreeConfig.getExpansionSet(),a);var c=b.facetTreeConfig.getExpansionMap().get(a);null==c&&b.facetTreeConfig.getExpansionMap().put(a,1),d.refresh()},b.selectIncoming=function(a){if(console.log("Incoming selected at path "+a),b.facetTreeConfig){var c=b.facetTreeConfig.getExpansionMap().get(a);2!=c&&(b.facetTreeConfig.getExpansionMap().put(a,2),d.refresh())}},b.selectOutgoing=function(a){if(console.log("Outgoing selected at path "+a),b.facetTreeConfig){var c=b.facetTreeConfig.getExpansionMap().get(a);1!=c&&(b.facetTreeConfig.getExpansionMap().put(a,1),d.refresh())}},b.selectFacetPage=function(a,c){var e=c.item.getPath(),f=b.facetTreeConfig.getFacetStateProvider().getFacetState(e),g=f.getResultRange();console.log("Facet state for path "+e+": "+f);var h=g.getLimit()||0,i=h?(a-1)*h:null;g.setOffset(i),d.refresh()},b.toggleSelected=function(a){b.onSelect({path:a})},b.toggleTableLink=function(a){tableMod.togglePath(a),b.$emit("facete:refresh")}}]).directive("facetTree",function(){return{restrict:"EA",replace:!0,templateUrl:"template/facet-tree/facet-tree-item.html",transclude:!1,require:"facetTree",scope:{sparqlService:"=",facetTreeConfig:"=",plugins:"=",pluginContext:"=",onSelect:"&select"},controller:"FacetTreeCtrl",compile:function(){return function(){}}}}),angular.module("ui.jassa.facet-value-list",[]).controller("FacetValueListCtrl",["$rootScope","$scope","$q",function(a,b,c){b.filterText="",b.pagination={totalItems:0,currentPage:1,maxSize:5};var d=null,e=this,f=function(){var a=b.sparqlService&&b.facetTreeConfig&&b.path;d=a?new Jassa.facete.FacetValueService(b.sparqlService,b.facetTreeConfig):null},g=function(){f(),e.refresh()};b.ObjectUtils=Jassa.util.ObjectUtils;var h='[ObjectUtils.hashCode(sparqlService), ObjectUtils.hashCode(facetTreeConfig), "" + path, pagination.currentPage]';b.$watch(h,function(){g()},!0),b.toggleConstraint=function(a){var b=d.getFacetTreeConfig().getFacetConfig().getConstraintManager(),c=new facete.ConstraintSpecPathValue("equal",a.path,a.node);b.toggleConstraint(c)},e.refresh=function(){var a=b.path;if(!d||!a)return b.totalItems=0,void(b.facetValues=[]);var e=d.createFacetValueFetcher(b.path,b.filterText),f=e.fetchCount(),g=10,h=(b.pagination.currentPage-1)*g,i=e.fetchData(h,g);Jassa.sponate.angular.bridgePromise(f,c.defer(),b.$root,function(a){b.pagination.totalItems=a}),Jassa.sponate.angular.bridgePromise(i,c.defer(),b.$root,function(a){b.facetValues=a})},b.filterTable=function(a){b.filterText=a,g()}}]).directive("facetValueList",function(){return{restrict:"EA",replace:!0,templateUrl:"template/facet-value-list/facet-value-list.html",transclude:!1,require:"facetValueList",scope:{sparqlService:"=",facetTreeConfig:"=",path:"=",onSelect:"&select"},controller:"FacetValueListCtrl"}}),angular.module("ui.jassa.sparql-table",[]).controller("SparqlTableCtrl",["$scope","$rootScope","$q",function(a,b,c){var d=(Jassa.rdf,Jassa.sparql,Jassa.service),e=Jassa.util,f=(Jassa.sponate,function(a,b){e.ArrayUtils.clear(b.getSortConditions());for(var c=0;c<a.fields.length;++c){var d=a.fields[c],f=a.directions[c],g=0;if("asc"===f?g=1:"desc"===f&&(g=-1),0!==g){var h=new facete.SortCondition(d,g);b.getSortConditions().push(h)}}}),g=function(){var b=a.config,c=a.sparqlService,e=b?b.queryFactory:null,f=e?e.createQuery():null,g=new d.SparqlTableService(c,f);return g};a.$watch("gridOptions.sortInfo",function(b){var c=a.config,d=c?c.tableMod:null;null!=d&&f(b,d),a.refreshData()},!0),a.$watch("[pagingOptions, filterOptions]",function(){a.refreshData()},!0),a.ObjectUtils=e.ObjectUtils,a.$watch("[ObjectUtils.hashCode(sparqlService), ObjectUtils.hashCode(config)]",function(){a.refresh()},!0),a.totalServerItems=0,a.pagingOptions={pageSizes:[10,50,100],pageSize:10,currentPage:1},a.refresh=function(){var b=g();a.refreshSchema(b),a.refreshPageCount(b),a.refreshData(b)},a.refreshSchema=function(b){b=b||g(),a.colDefs=b.getSchema()},a.refreshPageCount=function(b){b=b||g();var d=b.fetchCount();Jassa.sponate.angular.bridgePromise(d,c.defer(),a,function(b){a.totalServerItems=b.count})},a.refreshData=function(b){b=b||g();var d=a.pagingOptions.currentPage,e=a.pagingOptions.pageSize,f=(d-1)*e,h=b.fetchData(e,f);Jassa.sponate.angular.bridgePromise(h,c.defer(),a,function(b){a.myData=b})};var h=[];if(ngGridFlexibleHeightPlugin){var i=ngGridFlexibleHeightPlugin;h.push(new i(30))}a.myData=[],a.gridOptions={data:"myData",enablePaging:!0,useExternalSorting:!0,showFooter:!0,totalServerItems:"totalServerItems",enableHighlighting:!0,sortInfo:{fields:[],directions:[],columns:[]},pagingOptions:a.pagingOptions,filterOptions:a.filterOptions,plugins:h,columnDefs:"colDefs"},a.refresh()}]).directive("sparqlTable",["$parse",function(){return{restrict:"EA",replace:!0,templateUrl:"template/sparql-table/sparql-table.html",controller:"SparqlTableCtrl",scope:{sparqlService:"=",config:"=",onSelect:"&select",onUnselect:"&unselect"},link:function(){}}}]),angular.module("ui.jassa.template-list",[]).controller("TemplateListCtrl",["$scope",function(){}]).directive("templateList",["$compile",function(a){return{restrict:"EA",replace:!0,templateUrl:"template/template-list/template-list.html",transclude:!0,scope:{templates:"=",data:"=",context:"="},controller:"TemplateListCtrl",compile:function(){return{pre:function(b,c){angular.forEach(b.templates,function(d){var e=a('<li style="display: inline;"></li>')(b),f=a(d)(b);e.append(f),c.append(e)})}}}}}]);