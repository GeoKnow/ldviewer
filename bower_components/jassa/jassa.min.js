var JSONCanonical;(function(){function g(f){return f<10?"0"+f:f}var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,k,c,m={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},l;function b(f){j.lastIndex=0;return j.test(f)?'"'+f.replace(j,function(n){var o=m[n];return typeof o==="string"?o:"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function h(w,r){var p,o,x,f,s=k,q,u=r[w];if(u&&typeof u==="object"&&typeof u.toJSON==="function"){u=u.toJSON(w)}if(typeof l==="function"){u=l.call(r,w,u)}switch(typeof u){case"string":return b(u);case"number":return isFinite(u)?String(u):"null";case"boolean":case"null":return String(u);case"object":if(!u){return"null"}k+=c;q=[];if(Object.prototype.toString.apply(u)==="[object Array]"){f=u.length;for(p=0;p<f;p+=1){q[p]=h(p,u)||"null"}x=q.length===0?"[]":k?"[\n"+k+q.join(",\n"+k)+"\n"+s+"]":"["+q.join(",")+"]";k=s;return x}if(l&&typeof l==="object"){f=l.length;for(p=0;p<f;p+=1){if(typeof l[p]==="string"){o=l[p];x=h(o,u);if(x){q.push(b(o)+(k?": ":":")+x)}}}}else{var n=Object.keys(u).sort();for(p in n){o=n[p];if(Object.prototype.hasOwnProperty.call(u,o)){x=h(o,u);if(x){q.push(b(o)+(k?": ":":")+x)}}}}x=q.length===0?"{}":k?"{\n"+k+q.join(",\n"+k)+"\n"+s+"}":"{"+q.join(",")+"}";k=s;return x}}var e=function(p,n,o){var f;k="";c="";if(typeof o==="number"){for(f=0;f<o;f+=1){c+=" "}}else{if(typeof o==="string"){c=o}}l=n;if(n&&typeof n!=="function"&&(typeof n!=="object"||typeof n.length!=="number")){throw new Error("JSON.stringify")}return h("",{"":p})};JSONCanonical={stringify:e}})();var Class=(function(){function n(q){if(!q){return[]}if("toArray" in Object(q)){return q.toArray()}var p=q.length||0,o=new Array(p);while(p--){o[p]=q[p]}return o}var g=function(){};var c="[object Function]";var h=Object.prototype.toString;function f(o){return h.call(o)===c}function m(o){var p=o.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return p.length==1&&!p[0]?[]:p}function k(r,o){var q=r.length,p=o.length;while(p--){r[q+p]=o[p]}return r}function e(o,p){return function(){var q=k([o.bind(this)],arguments);return p.apply(this,q)}}var d=(function(){for(var o in {toString:1}){if(o==="toString"){return false}}return true})();function j(){}function l(){var r=null,q=n(arguments);if(f(q[0])){r=q.shift()}function o(){this.initialize.apply(this,arguments)}_.extend(o,Class.Methods);o.superclass=r;o.subclasses=[];if(r){j.prototype=r.prototype;o.prototype=new j;r.subclasses.push(o)}for(var p=0,s=q.length;p<s;p++){o.addMethods(q[p])}if(!o.prototype.initialize){o.prototype.initialize=g}o.prototype.constructor=o;return o}function b(v){var q=this.superclass&&this.superclass.prototype,p=Object.keys(v);if(d){if(v.toString!=Object.prototype.toString){p.push("toString")}if(v.valueOf!=Object.prototype.valueOf){p.push("valueOf")}}for(var o=0,r=p.length;o<r;o++){var u=p[o],s=v[u];if(q&&f(s)&&m(s)[0]=="$super"){var w=s;s=e((function(x){return function(){return q[x].apply(this,arguments)}})(u),w);s.valueOf=(function(x){return function(){return x.valueOf.call(x)}})(w);s.toString=(function(x){return function(){return x.toString.call(x)}})(w)}this.prototype[u]=s}return this}return{create:l,Methods:{addMethods:b}}})();"use strict";var Jassa={vocab:{util:{},xsd:{},rdf:{},rdfs:{},owl:{},wgs84:{}},rdf:{},sparql:{},service:{},i18n:{},sponate:{},facete:{},util:{},client:{},geo:{openlayers:{},leaflet:{}}};var module;if(!module){module={}}module.exports=Jassa;(function(){var b=Jassa.util;b.MapUtils={indexBy:function(d,e,c){c=c||new b.HashMap();var f;if(_(e).isString()){f=function(g){return g[e]}}else{f=e}_(d).each(function(h){var g=f(h);c.put(g,h)});return c}};b.MultiMapUtils={get:function(d,c){return(c in d)?d[c]:[]},put:function(e,d,f){var c;if(d in e){c=e[d]}else{c=[];e[d]=c}c.push(value)},clear:function(d){var c=_(d).keys();_(c).each(function(e){delete d[e]})}};b.MultiMapObjectArray=Class.create({initialize:function(){this.entries={}},clone:function(){var c=new b.MultiMapObjectArray();c.addMultiMap(this);return c},clear:function(){var c=_(this.entries).keys();_(c).each(function(d){delete this.entries[d]})},addMultiMap:function(c){for(var f in c.entries){var d=c.entries[f];for(var e=0;e<d.length;++e){var g=d[e];this.put(f,g)}}},get:function(c){return(c in this.entries)?this.entries[c]:[]},put:function(d,e){var c;if(d in this.entries){c=this.entries[d]}else{c=[];this.entries[d]=c}c.push(e)},removeKey:function(c){delete this.entries[c]}});b.ArrayUtils={clear:function(c){while(c.length>0){c.pop()}},replace:function(d,c){this.clear(d);d.push.apply(d,c)},filter:function(c,e){var d=_(c).filter(e);this.replace(c,d);return c}};b.Iterator=Class.create({next:function(){throw"Not overridden"},hasNext:function(){throw"Not overridden"}});b.IteratorAbstract=Class.create(b.Iterator,{initialize:function(){this.current=null;this.advance=true;this.finished=false},finish:function(){this.finished=true;this.close();return null},$prefetch:function(){this.current=this.prefetch()},hasNext:function(){if(this.advance){this.$prefetch();this.advance=false}return this.finished==false},next:function(){if(this.finished){throw"No more elments"}if(this.advance){this.$prefetch()}this.advance=true;return this.current},prefetch:function(){throw"Not overridden"}});b.Entry=Class.create({initialize:function(c,d){this.key=c;this.value=d},getKey:function(){return this.key},getValue:function(){return this.value},toString:function(){return this.key+"->"+this.value}});b.IteratorArray=Class.create(b.Iterator,{initialize:function(d,c){this.array=d;this.offset=c?c:0},getArray:function(){return this.array},hasNext:function(){var c=this.offset<this.array.length;return c},next:function(){var d=this.hasNext();var c;if(d){c=this.array[this.offset];++this.offset}else{c=null}return c}});b.ObjectMap=Class.create({initialize:function(c){this.data=c?c:{}},get:function(c){return this.data[c]},put:function(c,d){this.data[c]=d},remove:function(c){delete this.data[c]},entries:function(){throw"Not implemented"},toString:function(){return JSON.stringify(this.data)}});b.defaultEquals=function(e,d){var c;if(e&&e.equals){c=e.equals(d)}else{if(d&&d.equals){c=d.equals(e)}else{c=_.isEqual(e,d)}}return c};b.defaultHashCode=function(d){var c;if(d&&d.hashCode){c=d.hashCode()}else{c=""+d}return c};b.ListMap=Class.create({initialize:function(c,d){this.map=new b.HashMap(c,d);this.keys=[]},put:function(d,e){var c=map.get(d);if(c){throw"Key "+c+" already inserted"}this.keys.push(d);map.put(d,e)},get:function(d){var c=this.map.get(d);return c},getByIndex:function(d){var e=this.keys[d];var c=this.map.get(e);return c},entries:function(){var d=this;var c=this.keys.map(function(e){var g=d.map.get(e);var f={key:e,val:g};return f});return c},remove:function(c){throw"Implement me"},removeByIndex:function(c){var d=this.keys[c];this.remove(d)},keyList:function(){return this.keys},size:function(){return this.keys.length}});b.HashMap=Class.create({initialize:function(c,d){this.fnEquals=c?c:b.defaultEquals;this.fnHash=d?d:b.defaultHashCode;this.hashToBucket={}},put:function(d,g){var f=this.fnHash(d);var h=this.hashToBucket[f];if(h==null){h=[];this.hashToBucket[f]=h}var c=this._indexOfKey(h,d);if(c>=0){h[c].val=g;return}var e={key:d,val:g};h.push(e)},_indexOfKey:function(g,e){if(g!=null){for(var d=0;d<g.length;++d){var f=g[d];var c=f.key;if(this.fnEquals(c,e)){return d}}}return -1},get:function(e){var f=this.fnHash(e);var g=this.hashToBucket[f];var d=this._indexOfKey(g,e);var c=d>=0?g[d].val:null;return c},remove:function(e){var f=this.fnHash(e);var g=this.hashToBucket[f];var d=this._indexOfKey(g,e);var c=d>=0;if(c){g.splice(d,1)}return c},containsKey:function(d){var e=this.fnHash(d);var f=this.hashToBucket[e];var c=this._indexOfKey(f,d)>=0;return c},keyList:function(){var c=[];_.each(this.hashToBucket,function(e){var d=_(e).pluck("key");c.push.apply(c,d)});return c},entries:function(){var c=[];_(this.hashToBucket).each(function(d){c.push.apply(c,d)});return c},toString:function(){var d=this.entries();var e=d.map(function(f){return f.key+": "+f.val});var c="{"+e.join(", ")+"}";return c}});b.HashBidiMap=Class.create({initialize:function(d,e,c){this.forward=new b.HashMap(d,e);this.inverse=c?c:new b.HashBidiMap(d,e,this)},getInverse:function(){return this.inverse},put:function(c,d){this.remove(c);this.forward.put(c,d);this.inverse.forward.put(d,c)},remove:function(d){var c=this.get(d);this.inverse.forward.remove(c);this.forward.remove(d)},getMap:function(){return this.forward},get:function(d){var c=this.forward.get(d);return c},keyList:function(){var c=this.forward.keyList();return c}});b.HashSet=Class.create({initialize:function(c,d){this.map=new b.HashMap(c,d)},add:function(c){this.map.put(c,true)},contains:function(d){var c=this.map.containsKey(d);return c},remove:function(c){this.map.remove(c)},entries:function(){var c=_(this.map.entries()).map(function(d){return d.key});return c},toString:function(){var d=this.entries();var c="{"+d.join(", ")+"}";return c}});b.NestedList=Class.create({classLabel:"jassa.util.NestedList",initialize:function(){this.subLists=[]},getArray:function(){var d=_(this.subLists).each(function(e){return e.getArray()});var c=_(d).flatten(true);return c},contains:function(d){var e=_(this.subLists).find(function(f){var g=f.contains(d);return g});var c=!!e;return c},});b.ArrayList=Class.create({initialize:function(c){this.items=[];this.fnEquals=c||b.defaultEquals},setItems:function(c){this.items=c},getArray:function(){return this.items},get:function(d){var c=this.items[d];return c},add:function(c){this.items.push(c)},indexesOf:function(f){var e=this.items;var d=this.fnEquals;var c=[];_(e).each(function(h,g){var j=d(f,h);if(j){c.push(g)}});return c},contains:function(e){var d=this.indexesOf(e);var c=d.length>0;return c},firstIndexOf:function(e){var d=this.indexesOf(e);var c=(d.length>0)?d[0]:-1;return c},lastIndexOf:function(e){var d=this.indexesOf(e);var c=(d.length>0)?d[d.length-1]:-1;return c},remove:function(d){var c=this.firstIndexOf(d);if(c>=0){this.removeByIndex(c)}},removeByIndex:function(c){this.items.splice(c,1)},size:function(){return this.items.length}});b.CollectionUtils={toggleItem:function(e,d){var c;if(e.contains(d)){e.remove(d);c=false}else{e.add(d);c=true}return c}}})();(function(){var b=Jassa.util;b.TreeUtils={visitDepthFirst:function(e,c,g){var f=g(e);if(f){var d=c(e);_(d).each(function(h){b.TreeUtils.visitDepthFirst(h,c,g)})}},flattenTree:function(f,g,c){if(c==null){c=[]}if(f){c.push(f)}var e=f[g];var d=this;if(e){_(e).each(function(h){d.flattenTree(h,g,c)})}return c}}})();(function(){var b=Jassa.util;b.JsonUtils={stringifyCyclic:function(f,e){var d=[];var c=JSONCanonical.stringify(f,function(g,h){if(_(h).isObject()){if(d.indexOf(h)>=0){return}d.push(h);if(e){h=e(g,h)}}return h});return c}};b.ObjectUtils={hashCode:function(e,d){var c=b.JsonUtils.stringifyCyclic(e,function(h,k){var j=null;if(!d&&_(k).isObject()){var g=_(b.ObjectUtils.defaultHashFnNames).find(function(l){return _(k[l]).isFunction()});var f=k[g];if(f){j=f.apply(k)}else{j=k}}else{j=k}if(d){d=false}return j});return c}};b.ObjectUtils.defaultHashFnNames=["hashCode"]})();(function(){var b=Jassa.util;b.SerializationContext=Class.create({initialize:function(){this._nextId=1;this.objToId=new b.HashMap(function(d,c){return d==c},function(c){return b.ObjectUtils.hashCode(c)});this.idToState={}},nextId:function(){var c=""+this._nextId++;return c},getIdToState:function(){return this.idToState},getObjToId:function(){return this.objToId}});b.Serializer=Class.create({initialize:function(){this.classNameToClass={};this.classNameToFnSerialize={};this.classNameToFnDeserialize={};this.classNameToPrototype={}},registerOverride:function(d,e,c){this.classNameToFnSerialize[d]=e;this.classNameToFnDeserialize[d]=c},indexClasses:function(d){var c=this.findClasses(d);_(this.classNameToClass).extend(c);return c},findClasses:function(d){var c={};_(d).each(function(e){var f=e.classLabel||(e.prototype?e.prototype.classLabel:null);if(f){c[f]=e}});return c},getLabelForClass:function(e){var d=Object.getPrototypeOf(e);var c;_(this.classNameToClass).find(function(g,f){if(d==g.prototype){c=f;return true}});return c},getClassForLabel:function(d){var c;_(this.classNameToClass).find(function(f,e){if(e===d){c=f;return true}});return c},serialize:function(f,d){d=d||new b.SerializationContext();var e=this.serializeRec(f,d);var c={root:e,idToState:d.getIdToState()};return c},serializeRec:function(l,h){var u;var p=h.getObjToId();var g=p.get(l);if(!g){g=h.nextId();p.put(l,g)}var d=h.getIdToState();var c=d[g];if(c){u={ref:g}}else{if(_(l).isFunction()){u=undefined}else{if(_(l).isObject()){u={};var j=this.getLabelForClass(l);var f=function(v){var e=_(v).isUndefined()||_(v).isNull()||_(v).isBoolean()||_(v).isNumber()||_(v).isDate()||_(v).isString()||_(v).isRegExp();return e};var r=function(x){var w=x.prototype||x.__proto__;var v=_(x).isObject&&!f(x);var e=v&&(w==null||w==Object.__proto__.__proto__);return e};var q=f(l)||r(l)||_(l).isArray();if(j==null&&!q){console.log("Failed to serialize instance without class label",l);throw"Failed to serialize instance without class label"}var m;if(j){var m=this.classNameToPrototype[j];if(!m){var n=this.getClassForLabel(j);if(n){try{m=new n();this.classNameToPrototype[j]=m}catch(o){console.log("[WARN] Failed to create a prototype instance of class "+j,o)}}}}if(!m){m={}}var k=this.serializeAttrs(l,h,m);var s={};if(j){s.classLabel=j}if(_(k).keys().length>0){s.attrs=k.attrs;if(k.parent!=null){s.parent=k.parent}}if(_(l).isArray()){s.length=l.length}d[g]=s;u={ref:g}}else{u={value:l}}}}return u},serializeAttrs:function(d,c,f){var g=d;var l={};var h=l;var e=h.attrs={};var k=this;var j=_(d).keys();_(j).each(function(n){var m=d[n];var p=k.serializeRec(m,c);var q=f[n];var o=_(p).isEqual(q)||(p==null&&q==null);if(o){return}if(!_(p).isUndefined()){e[n]=p}});return l},deserialize:function(g,e){var f=g.root;var d=g.idToState;var h={};var c=this.deserializeRef(f,d,h);return c},deserializeRef:function(e,d,j){var f=e.ref;var h=e.value;var c;if(f!=null){var g=f in j;if(g){c=j[f]}else{c=this.deserializeState(f,d,j)}}else{c=h}return c},deserializeState:function(e,d,j){var n;var c=d[e];if(c==null||!_(c).isObject()){console.log("State must be an object, was: ",c);throw"Deserialization error"}var k=c.attrs;var f=c.classLabel;var g=c.length;if(f){var h=this.getClassForLabel(f);if(!h){throw"Unknown class label encountered in deserialization: "+f}n=new h()}else{if(g!=null){n=[]}else{n={}}}j[e]=n;var m=this;if(k!=null){var l=_(k).keys();_(l).each(function(o){var p=k[o];var q=m.deserializeRef(p,d,j);n[o]=q})}if(g!=null){n.length=g}return n}});b.Serializer.singleton=new b.Serializer()})();(function(){var b=Jassa.rdf;b.Node=Class.create({classLabel:"Node",getUri:function(){throw"not a URI node"},getName:function(){throw" is not a variable node"},getBlankNodeId:function(){throw" is not a blank node"},getBlankNodeLabel:function(){return this.getBlankNodeId().getLabelString()},getLiteral:function(){throw" is not a literal node"},getLiteralValue:function(){throw" is not a literal node"},getLiteralLexicalForm:function(){throw" is not a literal node"},getLiteralDatatype:function(){throw" is not a literal node"},getLiteralDatatypeUri:function(){throw" is not a literal node"},isBlank:function(){return false},isUri:function(){return false},isLiteral:function(){return false},isVariable:function(){return false},equals:function(e){var c=false;if(e==null){c=false}else{if(this.isLiteral()){if(e.isLiteral()){var g=this.getLiteralLexicalForm()===e.getLiteralLexicalForm();var d=this.getLiteralDatatypeUri()===e.getLiteralDatatypeUri();var f=this.getLiteralLanguage()===e.getLiteralLanguage();c=g&&d&&f}}else{if(this.isUri()){if(e.isUri()){c=this.getUri()===e.getUri()}}else{if(this.isVariable()){if(e.isVariable()){c=this.getName()===e.getName()}}else{if(this.isBlank()){if(e.isBlank()){c=this.getBlankNodeLabel()===e.getBlankNodeLabel()}}else{throw"not implemented yet"}}}}}return c}});b.Node_Concrete=Class.create(b.Node,{classLabel:"Node_Concrete",isConcrete:function(){return true}});b.Node_Uri=Class.create(b.Node_Concrete,{classLabel:"Node_Uri",initialize:function(c){this.uri=c},isUri:function(){return true},getUri:function(){return this.uri},toString:function(){return"<"+this.uri+">"}});b.Node_Blank=Class.create(b.Node_Concrete,{classLabel:"Node_Blank",initialize:function(c){this.anonId=c},isBlank:function(){return true},getBlankNodeId:function(){return this.anonId},toString:function(){return"_:"+this.anonId}});b.Node_Fluid=Class.create(b.Node,{isConcrete:function(){return false}});b.Node_Variable=Class.create(b.Node_Fluid,{classLabel:"Node_Variable",isVariable:function(){return true}});b.Var=Class.create(b.Node_Variable,{classLabel:"Var",initialize:function(c){this.name=c},getName:function(){return this.name},toString:function(){return"?"+this.name}});b.Node_Literal=Class.create(b.Node_Concrete,{classLabel:"Node_Literal",initialize:function(c){this.literalLabel=c},isLiteral:function(){return true},getLiteral:function(){return this.literalLabel},getLiteralValue:function(){return this.literalLabel.getValue()},getLiteralLexicalForm:function(){return this.literalLabel.getLexicalForm()},getLiteralDatatype:function(){return this.literalLabel.getDatatype()},getLiteralDatatypeUri:function(){var d=this.getLiteralDatatype();var c=d?d.getUri():null;return c},getLiteralLanguage:function(){return this.literalLabel.getLanguage()},toString:function(){return this.literalLabel.toString()}});b.escapeLiteralString=function(c){return c};b.LiteralLabel=Class.create({classLabel:"LiteralLabel",initialize:function(f,d,e,c){this.val=f;this.lex=d;this.lang=e;this.dtype=c},getValue:function(){return this.val},getLexicalForm:function(){return this.lex},getLanguage:function(){return this.lang},getDatatype:function(){return this.dtype},toString:function(){var d=this.dtype?this.dtype.getUri():null;var e=b.escapeLiteralString(this.lex);var c;if(d){c='"'+e+'"^^<'+d+">"}else{c='"'+e+'"'+(this.lang?"@"+this.lang:"")}return c}});b.AnonId=Class.create({getLabelString:function(){throw"not implemented"}});b.AnonIdStr=Class.create(b.AnonId,{classLabel:"AnonIdStr",initialize:function(c){this.label=c},getLabelString:function(){return this.label},toString:function(){return this.label}});b.DatatypeLabel=Class.create({parse:function(c){throw"Not implemented"},unparse:function(c){throw"Not implemented"}});b.DatatypeLabelInteger=Class.create(b.DatatypeLabel,{classLabel:"DatatypeLabelInteger",parse:function(d){var c=parseInt(d,10);return c},unparse:function(c){return""+c}});b.DatatypeLabelFloat=Class.create(b.DatatypeLabel,{classLabel:"DatatypeLabelFloat",parse:function(d){var c=parseFloat(d);return c},unparse:function(c){return""+c}});b.DatatypeLabelString=Class.create(b.DatatypeLabel,{classLabel:"DatatypeLabelString",parse:function(c){return c},unparse:function(c){return c}});b.RdfDatatype=Class.create({classLabel:"RdfDatatype",getUri:function(){throw"Not implemented"},unparse:function(c){throw"Not implemented"},parse:function(c){throw"Not implemented"}});b.RdfDatatypeBase=Class.create(b.RdfDatatype,{classLabel:"RdfDatatypeBase",initialize:function(c){this.uri=c},getUri:function(){return this.uri}});b.RdfDatatype_Label=Class.create(b.RdfDatatypeBase,{classLabel:"RdfDatatype_Label",initialize:function($super,d,c){$super(d);this.datatypeLabel=c},parse:function(d){var c=this.datatypeLabel.parse(d);return c},unparse:function(d){var c=this.datatypeLabel.unparse(d);return c}});b.strRegex=/"([^"\\]*(\\.[^"\\]*)*)"/;b.parseUri=function(e,d){var c;if(e.charAt(0)=="<"){c=e.slice(1,-1)}else{console.log("[ERROR] Cannot deal with "+e);throw"Not implemented"}return c};b.JenaParameters={enableSilentAcceptanceOfUnknownDatatypes:true};b.TypedValue=Class.create({initialize:function(c,d){this.lexicalValue=c;this.datatypeUri=d},getLexicalValue:function(){return this.lexicalValue},getDatatypeUri:function(){return this.datatypeUri}});b.BaseDatatype=Class.create(b.RdfDatatype,{initialize:function(c){this.datatypeUri=c},getUri:function(){return this.datatypeUri},unparse:function(d){var c;if(d instanceof b.TypedValue){c=d.getLexicalValue()}else{c=""+d}return c},parse:function(d){var c=new b.TypedValue(d,this.datatypeUri);return c},toString:function(){return"Datatype ["+this.datatypeUri+"]"}});b.TypeMapper=Class.create({initialize:function(c){this.uriToDt=c},getSafeTypeByName:function(e){var d=this.uriToDt;var c=d[e];if(c==null){if(e==null){return null}else{if(b.JenaParameters.enableSilentAcceptanceOfUnknownDatatypes){c=new b.BaseDatatype(e);this.registerDatatype(c)}else{console.log("Attempted to created typed literal using an unknown datatype - "+e);throw"Bailing out"}}}return c},registerDatatype:function(c){var d=c.getUri();this.uriToDt[d]=c}});b.TypeMapper.staticInstance=null;b.TypeMapper.getInstance=function(){var c=b.TypeMapper;if(c.staticInstance==null){c.staticInstance=new b.TypeMapper(b.RdfDatatypes)}return c.staticInstance};b.NodeFactory={createAnon:function(c){return new b.Node_Blank(c)},createUri:function(c){return new b.Node_Uri(c)},createVar:function(c){return new b.Var(c)},createPlainLiteral:function(e,f){if(f==null){f=""}var d=new b.LiteralLabel(e,e,f);var c=new b.Node_Literal(d);return c},createTypedLiteralFromValue:function(j,f){var d=b.RdfDatatypes[f];if(!d){var k=b.TypeMapper.getInstance();d=k.getSafeTypeByName(f)}var e=d.unparse(j);var h=null;var g=new b.LiteralLabel(j,e,h,d);var c=new b.Node_Literal(g);return c},createTypedLiteralFromString:function(h,f){var l=b.RdfDatatypes[f];if(!l){var j=b.TypeMapper.getInstance();l=j.getSafeTypeByName(f)}var e=l.parse(h);var c=h;var d="";var g=new b.LiteralLabel(e,c,d,l);var k=new b.Node_Literal(g);return k},createFromTalisRdfJson:function(e){if(!e||typeof(e.type)==="undefined"){throw"Invalid node: "+JSON.stringify(e)}var c;switch(e.type){case"bnode":var d=new b.AnonIdStr(e.value);c=new b.NodeFactory.createAnon(d);break;case"uri":c=b.NodeFactory.createUri(e.value);break;case"literal":var f=e.lang||e["xml:lang"];c=b.NodeFactory.createPlainLiteral(e.value,f);break;case"typed-literal":c=b.NodeFactory.createTypedLiteralFromString(e.value,e.datatype);break;default:console.log("Unknown type: '"+e.type+"'");throw"Bailing out"}return c},parseRdfTerm:function(r,h){if(!r){console.log("[ERROR] Null Pointer Exception");throw"Bailing out"}r=r.trim();if(r.length==0){console.log("[ERROR] Empty string");throw"Bailing out"}var q=r.charAt(0);var u;switch(q){case"<":var g=r.slice(1,-1);u=b.NodeFactory.createUri(g);break;case"_":var j=new b.AnonIdStr(q);u=b.NodeFactory.createAnon(j);break;case'"':var k=b.strRegex.exec(r);var m=k[0];var e=m.slice(1,-1);var f=m.length;var n=r.charAt(f);if(!n){var u=b.NodeFactory.createTypedLiteralFromString(e,"http://www.w3.org/2001/XMLSchema#string")}switch(n){case"":case"@":var s=r.substr(f+1);var u=b.NodeFactory.createPlainLiteral(e,s);break;case"^":var p=r.substr(f+2);var o=b.parseUri(p);var u=b.NodeFactory.createTypedLiteralFromString(e,o);break;default:console.log("[ERROR] Excepted @ or ^^");throw"Bailing out"}break;default:console.log("Could not parse "+r);throw"Not implemented"}return u}};_.extend(b.Node,{uri:b.NodeFactory.createUri,v:b.NodeFactory.createVar});b.getSubstitute=function(e,d){var c=d(e);if(!c){c=e}return c};b.Triple=Class.create({classLabel:"jassa.rdf.Triple",initialize:function(c,d,e){this.s=c;this.p=d;this.o=e},toString:function(){return this.s+" "+this.p+" "+this.o},copySubstitute:function(d){var c=new b.Triple(b.getSubstitute(this.s,d),b.getSubstitute(this.p,d),b.getSubstitute(this.o,d));return c},getSubject:function(){return this.s},getProperty:function(){return this.p},getObject:function(){return this.o},getVarsMentioned:function(){var c=[];b.Triple.pushVar(c,this.s);b.Triple.pushVar(c,this.p);b.Triple.pushVar(c,this.o);return c}});b.Triple.pushVar=function(f,d){if(d.isVariable()){var e=_(f).some(function(c){return d.equals(c)});if(!e){f.push(d)}}return f}})();(function(){var b=Jassa.rdf;var c=Jassa.vocab.util;c.initNodes=function(e,d){if(d==null){d=e.str;if(d==null){console.log("No source from where to init nodes");throw"Bailing out"}}_.each(d,function(g,f){e[f]=b.Node.uri(g)})}})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.xsd;var d="http://www.w3.org/2001/XMLSchema#";c.str={xboolean:d+"boolean",xint:d+"int",xinteger:d+"integer",xlong:d+"long",decimal:d+"decimal",xfloat:d+"float",xdouble:d+"double",xstring:d+"string",date:d+"date",dateTime:d+"dateTime"};b.initNodes(c)})();(function(){var b=Jassa.vocab.xsd;var d=b.str;var c=Jassa.rdf;c.DatatypeLabels={xinteger:new c.DatatypeLabelInteger(),xfloat:new c.DatatypeLabelFloat(),xdouble:new c.DatatypeLabelFloat(),xstring:new c.DatatypeLabelString(),decimal:new c.DatatypeLabelFloat()};c.RdfDatatypes={};c.registerRdfDatype=function(f,e){c.RdfDatatypes[f]=new c.RdfDatatype_Label(f,e)};c.registerRdfDatype(b.str.xint,c.DatatypeLabels.xinteger);c.registerRdfDatype(b.str.xlong,c.DatatypeLabels.xinteger);c.registerRdfDatype(b.str.xinteger,c.DatatypeLabels.xinteger);c.registerRdfDatype(b.str.xstring,c.DatatypeLabels.xstring);c.registerRdfDatype(b.str.xfloat,c.DatatypeLabels.xfloat);c.registerRdfDatype(b.str.xdouble,c.DatatypeLabels.xdouble);c.registerRdfDatype(b.str.decimal,c.DatatypeLabels.xfloat)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.rdf;var d="http://www.w3.org/1999/02/22-rdf-syntax-ns#";c.str={type:d+"type",Property:d+"Property"};b.initNodes(c)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.rdfs;var d="http://www.w3.org/2000/01/rdf-schema#";c.str={label:d+"label",subClassOf:d+"subClassOf"};b.initNodes(c)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.owl;var d="http://www.w3.org/2002/07/owl#";c.str={Class:d+"Class",DatatypeProperty:d+"DatatypeProperty",ObjectProperty:d+"ObjectProperty",AnnotationProperty:d+"AnnotationProperty"};b.initNodes(c)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.wgs84;var d="http://www.w3.org/2003/01/geo/wgs84_pos#";c.str={lon:d+"long",lat:d+"lat",};b.initNodes(c)})();(function(){var b=Jassa.sparql;b.Node=Jassa.rdf.Node;b.PrefixMappingImpl=Class.create({initialize:function(c){this.prefixes=c?c:{}},expandPrefix:function(c){throw"Not implemented yet - sorry"},getNsPrefixMap:function(){return this.prefixes},getNsPrefixURI:function(c){return this.prefixes[c]},getNsURIPrefix:function(e){var c=null;var d=null;_(this.prefixes).each(function(f,g){if(_(e).startsWith(f)){if(!d||(f.length>d.length)){c=g;d=f}}});return c},qnameFor:function(c){},removeNsPrefix:function(c){delete this.prefixes[c]},samePrefixMappingAs:function(c){throw"Not implemented yet - Sorry"},setNsPrefix:function(d,c){this.prefixes[d]=c;return this},setNsPrefixes:function(e){var d=_(e.getNsPrefixMap).isFunction()?e.getNsPrefixMap():e;var c=this;_(d).each(function(f,g){c.setNsPrefix(g,f)});return this},shortForm:function(e){var f=this.getNsPrefixURI(e);var c;if(f){var d=this.prefixes[d];var g=e.substring(d.length);c=f+":"+g}else{c=e}return resul;t},addPrefix:function(d,c){this.prefixes[d]=c},getPrefix:function(d){var c=this.prefixes[d];return c},addJson:function(c){_.extend(this.prefixes,c)},getJson:function(){return this.prefixes}})})();(function(){var rdf=Jassa.rdf;var xsd=Jassa.vocab.xsd;var ns=Jassa.sparql;ns.SparqlString=Class.create({classLabel:"jassa.sparql.SparqlString",initialize:function(value,varsMentioned){this.value=value;this.varsMentioned=varsMentioned?varsMentioned:[]},toString:function(){return this.value},getString:function(){return this.value},copySubstitute:function(fnNodeMap){var str=this.value;var newVarsMentioned=[];var placeholder="@@@@";var reAllPlaceholders=new RegExp(placeholder,"g");_(this.varsMentioned).each(function(v){var reStr="\\?"+v.getName()+"([^\\w])?";var re=new RegExp(reStr,"g");var node=fnNodeMap(v);if(node){var replacement;if(node.isVariable()){replacement=placeholder+node.getName();newVarsMentioned.push(node)}else{replacement=node.toString()}str=str.replace(re,replacement+"$1")}else{newVarsMentioned.push(v)}});str=str.replace(reAllPlaceholders,"?");return new ns.SparqlString(str,newVarsMentioned)},getVarsMentioned:function(){return this.varsMentioned}});ns.SparqlString.classLabel="SparqlString";ns.SparqlString.create=function(str,varNames){var vars;if(varNames!=null){vars=varNames.map(function(varName){return rdf.NodeFactory.createVar(varName)})}else{vars=ns.extractSparqlVars(str)}var result=new ns.SparqlString(str,vars);return result};ns.Expr=Class.create({isFunction:function(){return false},isVar:function(){return false},isConstant:function(){return false},getFunction:function(){throw"Override me"},getExprVar:function(){throw"Override me"},getConstant:function(){throw"Override me"},copySubstitute:function(fnNodeMap){throw"Override me"}});ns.ExprVar=Class.create(ns.Expr,{classLabel:"ExprVar",initialize:function(v){this.v=v},copySubstitute:function(fnNodeMap){var node=fnNodeMap(this.v);var result;if(node==null){result=this}else{if(node.isVariable()){result=new ns.ExprVar(node)}else{result=sparql.NodeValue.makeNode(node)}}return result},getArgs:function(){return[]},copy:function(args){if(args&&args.length>0){throw"Invalid argument"}var result=new ns.ExprVar(this.v);return result},isVar:function(){return true},getExprVar:function(){return this},asVar:function(){return this.v},getVarsMentioned:function(){return[this.v]},toString:function(){return""+this.v}});ns.ExprFunction=Class.create(ns.Expr,{isFunction:function(){return true},getFunction:function(){return this}});ns.ExprFunction0=Class.create(ns.ExprFunction,{getArgs:function(){return[]},copy:function(args){if(args&&args.length>0){throw"Invalid argument"}var result=this.$copy(args);return result}});ns.ExprFunction1=Class.create(ns.ExprFunction,{initialize:function(subExpr){this.subExpr=subExpr},getArgs:function(){return[this.subExpr]},copy:function(args){if(args.length!=1){throw"Invalid argument"}var result=this.$copy(args);return result},getSubExpr:function(){return this.subExpr}});ns.ExprFunction2=Class.create(ns.ExprFunction,{initialize:function(left,right){this.left=left;this.right=right},getArgs:function(){return[this.left,this.right]},copy:function(args){if(args.length!=2){throw"Invalid argument"}var result=this.$copy(args[0],args[1]);return result},getLeft:function(){return this.left},getRight:function(){return this.right},getVarsMentioned:function(){var result=ns.PatternUtils.getVarsMentioned(this.getArgs());return result}});ns.E_OneOf=Class.create(ns.Expr,{initialize:function(lhsExpr,nodes){this.lhsExpr=lhsExpr;this.nodes=nodes},getVarsMentioned:function(){var result=this.lhsExpr.getVarsMentioned();return result},copySubstitute:function(fnNodeMap){var newElements=_.map(this.nodes,function(x){return rdf.getSubstitute(x,fnNodeMap)});return new ns.E_OneOf(this.lhsExpr.copySubstitute(fnNodeMap),newElements)},toString:function(){if(!this.nodes||this.nodes.length===0){return"FALSE"}else{return"("+this.lhsExpr+" In ("+this.nodes.join(", ")+"))"}}});ns.E_Str=Class.create(ns.ExprFunction1,{copySubstitute:function(fnNodeMap){return new ns.E_Str(this.subExpr.copySubstitute(fnNodeMap))},getVarsMentioned:function(){return this.subExpr.getVarsMentioned()},$copy:function(args){return new ns.E_Str(args[0])},toString:function(){return"str("+this.subExpr+")"}});ns.E_Regex=function(expr,pattern,flags){this.expr=expr;this.pattern=pattern;this.flags=flags};ns.E_Regex.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Regex(this.expr.copySubstitute(fnNodeMap),this.pattern,this.flags)},getVarsMentioned:function(){return this.expr.getVarsMentioned()},getArgs:function(){return[this.expr]},copy:function(args){if(args.length!=1){throw"Invalid argument"}var newExpr=args[0];var result=new ns.E_Regex(newExpr,this.pattern,this.flags);return result},toString:function(){var patternStr=this.pattern.replace("'","\\'");var flagsStr=this.flags?", '"+this.flags.replace("'","\\'")+"'":"";return"Regex("+this.expr+", '"+patternStr+"'"+flagsStr+")"}};ns.E_Like=function(expr,pattern){this.expr=expr;this.pattern=pattern};ns.E_Like.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Like(this.expr.copySubstitute(fnNodeMap),this.pattern)},getVarsMentioned:function(){return this.expr.getVarsMentioned()},getArgs:function(){return[this.expr]},copy:function(args){var result=newUnaryExpr(ns.E_Like,args);return result},toString:function(){var patternStr=this.pattern.replace("'","\\'");return"("+this.expr+" Like '"+patternStr+"')"}};ns.E_Function=Class.create(ns.Expr,{initialize:function(functionIri,args){this.functionIri=functionIri;this.args=args},copySubstitute:function(fnNodeMap){var newArgs=_(this.args).map(function(arg){var r=arg.copySubstitute(fnNodeMap);return r});return new ns.E_Function(this.functionIri,newArgs)},getArgs:function(){return this.args},copy:function(newArgs){return new ns.E_Function(this.functionIri,newArgs)},toString:function(){var argStr=this.args.join(", ");var iri=""+this.functionIri;var fnName=(iri.indexOf(":")<0)?"<"+iri+">":iri;var result=fnName+"("+argStr+")";return result},getVarsMentioned:function(){var result=ns.PatternUtils.getVarsMentioned(this.getArgs());return result}});ns.E_Equals=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super(left,right)},copySubstitute:function(fnNodeMap){return new ns.E_Equals(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},$copy:function(left,right){return new ns.E_Equals(left,right)},toString:function(){return"("+this.left+" = "+this.right+")"},eval:function(binding){}});ns.E_LangMatches=function(left,right){this.left=left;this.right=right};ns.E_LangMatches.prototype={copySubstitute:function(fnNodeMap){return new ns.E_LangMatches(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},getArgs:function(){return[this.left,this.right]},copy:function(args){return ns.newBinaryExpr(ns.E_LangMatches,args)},toString:function(){return"langMatches("+this.left+", "+this.right+")"},getVarsMentioned:function(){var result=ns.PatternUtils.getVarsMentioned(this.getArgs());return result}};ns.E_Lang=function(expr){this.expr=expr};ns.E_Lang.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Lang(this.expr.copySubstitute(fnNodeMap))},getArgs:function(){return[this.expr]},copy:function(args){var result=newUnaryExpr(ns.E_Lang,args);return result},toString:function(){return"lang("+this.expr+")"},getVarsMentioned:function(){return this.expr.getVarsMentioned()}};ns.E_Bound=function(expr){this.expr=expr};ns.E_Bound.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Bound(fnNodeMap(this.expr))},getArgs:function(){return[this.expr]},copy:function(args){var result=newUnaryExpr(ns.E_Bound,args);return result},toString:function(){return"bound("+this.expr+")"}};ns.E_GreaterThan=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super(left,right)},copySubstitute:function(fnNodeMap){return new ns.E_GreaterThan(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},copy:function(args){return ns.newBinaryExpr(ns.E_GreaterThan,args)},toString:function(){return"("+this.left+" > "+this.right+")"}});ns.E_LessThan=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super(left,right)},copySubstitute:function(fnNodeMap){return new ns.E_LessThan(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},copy:function(args){return ns.newBinaryExpr(ns.E_LessThan,args)},toString:function(){return"("+this.left+" < "+this.right+")"}});ns.E_LogicalAnd=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super(left,right)},copySubstitute:function(fnNodeMap){return new ns.E_LogicalAnd(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},copy:function(args){return ns.newBinaryExpr(ns.E_LogicalAnd,args)},toString:function(){return"("+this.left+" && "+this.right+")"}});ns.E_LogicalOr=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super(left,right)},copySubstitute:function(fnNodeMap){return new ns.E_LogicalOr(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},getArgs:function(){return[this.left,this.right]},copy:function(args){return ns.newBinaryExpr(ns.E_LogicalOr,args)},toString:function(){return"("+this.left+" || "+this.right+")"}});ns.E_LogicalNot=function(expr){this.expr=expr};ns.E_LogicalNot.prototype={copySubstitute:function(fnNodeMap){return new ns.E_LogicalNot(this.expr.copySubstitute(fnNodeMap))},getArgs:function(){return[this.left,this.right]},copy:function(args){return ns.newBinaryExpr(ns.E_LogicalOr,args)},toString:function(){return"(!"+this.expr+")"}};ns.E_Count=function(subExpr,isDistinct){this.subExpr=subExpr;this.isDistinct=isDistinct?isDistinct:false};ns.E_Count.prototype.copySubstitute=function(fnNodeMap){var subExprCopy=this.subExpr?this.subExpr.copySubstitute(fnNodeMap):null;return new ns.E_Count(subExprCopy,this.isDistinct)};ns.E_Count.prototype.toString=function(){return"Count("+(this.isDistinct?"Distinct ":"")+(this.subExpr?this.subExpr:"*")+")"};ns.E_Min=function(subExpr){this.subExpr=subExpr};ns.E_Min.prototype.copySubstitute=function(fnNodeMap){var subExprCopy=this.subExpr?this.subExpr.copySubstitute(fnNodeMap):null;return new ns.E_Min(subExprCopy)};ns.E_Min.prototype.getArgs=function(){return[this.subExpr]};ns.E_Min.prototype.copy=function(args){if(args.length!=1){throw"Invalid argument"}var newSubExpr=args[0];var result=new ns.E_Min(newSubExpr)};ns.E_Min.prototype.toString=function(){return"Min("+this.subExpr+")"};ns.E_Max=function(subExpr){this.subExpr=subExpr};ns.E_Max.prototype.copySubstitute=function(fnNodeMap){var subExprCopy=this.subExpr?this.subExpr.copySubstitute(fnNodeMap):null;return new ns.E_Min(subExprCopy)};ns.E_Max.prototype.getArgs=function(){return[this.subExpr]};ns.E_Max.prototype.copy=function(args){if(args.length!=1){throw"Invalid argument"}var newSubExpr=args[0];var result=new ns.E_Max(newSubExpr)};ns.E_Max.prototype.toString=function(){return"Max("+this.subExpr+")"};ns.ExprString=Class.create(ns.Expr,{classLabel:"jassa.sparql.ExprString",initialize:function(sparqlString){this.sparqlString=sparqlString},copySubstitute:function(fnNodeMap){var newSparqlString=this.sparqlString.copySubstitute(fnNodeMap);return new ns.ExprString(newSparqlString)},getVarsMentioned:function(){return this.sparqlString.getVarsMentioned()},getArgs:function(){return[]},copy:function(args){if(args.length!=0){throw"Invalid argument"}return this},toString:function(){return"(!"+this.expr+")"}});ns.ExprString.create=function(str,varNames){var result=new ns.ExprString(ns.SparqlString.create(str,varNames));return result};ns.NodeValue=Class.create(ns.Expr,{initialize:function(node){this.node=node},isConstant:function(){return true},getConstant:function(){return this},getArgs:function(){return[]},getVarsMentioned:function(){return[]},asNode:function(){throw"makeNode is not overridden"},copySubstitute:function(fnNodeMap){return this},toString:function(){var node=this.node;var result;if(node.isLiteral()){if(node.getLiteralDatatypeUri()===xsd.xstring.getUri()){result='"'+node.getLiteralLexicalForm()+'"'}else{if(node.datatype===xsd.xdouble.value){return parseFloat(this.node.value)}}}else{result=node.toString()}return result}});_.extend(ns.NodeValue,{createLiteral:function(val,typeUri){var node=rdf.NodeFactory.createTypedLiteralFromValue(val,typeUri);var result=new ns.NodeValueNode(node);return result},makeString:function(str){return ns.NodeValue.createLiteral(str,xsd.str.xstring)},makeInteger:function(val){return new ns.NodeValue.createLiteral(val,xsd.str.xint)},makeDecimal:function(val){return new ns.NodeValue.createLiteral(val,xsd.str.decimal)},makeFloat:function(val){return new ns.NodeValue.createLiteral(val,xsd.str.xfloat)},makeNode:function(node){var result=new ns.NodeValueNode(node);return result}});ns.NodeValueNode=Class.create(ns.NodeValue,{initialize:function(node){this.node=node},asNode:function(){return this.node},toString:function(){var node=this.node;var result=null;if(node.isLiteral()){if(node.getLiteralDatatypeUri()===xsd.xstring.getUri()){result='"'+node.getLiteralLexicalForm()+'"'}}if(result==null){result=node.toString()}return result}});ns.NodeValue.nvNothing=ns.NodeValue.makeNode(rdf.NodeFactory.createAnon(new rdf.AnonIdStr("node value nothing")));ns.valueFragment=function(node){return'"'+node.value.toString().replace('"','\\"')+'"'};ns.languageFragment=function(node){return node.language?"@"+node.language:""};ns.datatypeFragment=function(node){return node.datatype?"^^<"+node.datatype+">":""}})();(function(){var d=Jassa.rdf;var c=Jassa.vocab.xsd;var b=Jassa.util;var e=Jassa.sparql;e.Binding=function(f){this.varNameToEntry=f?f:{}};e.Binding.create=function(g){var h={};_.map(g,function(k,j){h[j]={v:e.Node.v(j),node:k}});var f=new e.Binding(h);return f};e.Binding.fromTalisJson=function(g){var h={};_.each(g,function(m,j){var l=d.NodeFactory.createFromTalisRdfJson(m);h[j]=l});var f=e.Binding.create(h);return f};e.Binding.prototype={put:function(f,g){this.varNameToEntry[f.getName()]={v:f,node:g}},get:function(g){if(!(g instanceof d.Var)){throw"var not an instance of Var"}var j=g.getName();var h=this.varNameToEntry[j];var f=h?h.node:null;return f},entries:function(){var g=_.values(this.varNameToEntry);var f=_.sortBy(g,function(h){return h.v.getName()});return f},toString:function(){var h=this.entries();var g=_.map(h,function(j){return'"'+j.v.getName()+'": "'+j.node+'"'});var f="{"+g.join(", ")+"}";return f},getVars:function(){var f=[];_(this.varNameToEntry).each(function(g){f.push(g.v)});return f}};e.orify=function(g){var f=e.opify(g,e.E_LogicalOr);return f};e.andify=function(g){var f=e.opify(g,e.E_LogicalAnd);return f};e.opify=function(l,o){var k=l;var j=[];while(k.length>1){for(var h=0;h<k.length;h+=2){var n=k[h];if(h+1==k.length){j.push(n);break}var m=k[h+1];var f=o(n,m);j.push(f)}var g=k;k=j;j=[]}return k};e.uniqTriples=function(g){var f=_.uniq(g,false,function(h){return h.toString()});return f};e.mergeTriples=function(h,g){var j=h.concat(g);var f=e.uniqTriples(j);return f};e.varPattern=/\?(\w+)/g;e.prefixPattern=/((\w|-)+):(\w|-)+/g;e.extractVarNames=function(j){var f=[];for(var h=0;h<j.length;++h){var g=j[h];f.push(g.getName())}return f};e.extractSparqlVars=function(k){var g=e.extractAll(e.varPattern,k,1);var f=[];for(var j=0;j<g.length;++j){var l=g[j];var h=e.Node.v(l);f.push(h)}return f};e.extractPrefixes=function(f){return e.extractAll(e.prefixPattern,f,1)};e.expandPrefixes=function(m,n){var k=e.extractPrefixes(n);var f=n;for(var h=0;h<k.length;++h){var l=k[h];var g=m[l];if(!g){continue}var j=new RegExp(l+":(\\w+)","g");f=f.replace(j,"<"+g+"$1>")}return f};e.extractAll=function(j,k,h){var g;var f=[];while(g=j.exec(k)){f.push(g[h])}f=_.uniq(f);return f};e.BasicPattern=function(f){this.triples=f?f:[]};e.BasicPattern.prototype.copySubstitute=function(g){var f=_.map(this.triples,function(h){return h.copySubstitute(g)});return new e.BasicPattern(f)};e.BasicPattern.prototype.toString=function(){return this.triples.join(" . ")};e.Template=function(f){this.bgp=f};e.Template.prototype.copySubstitute=function(f){return new e.Template(this.bgp.copySubstitute(f))};e.Template.prototype.toString=function(){return"{ "+this.bgp+" }"};e.Element=Class.create({});e.ElementNamedGraph=Class.create(e.Element,{classLabel:"jassa.sparql.ElementNamedGraph",initialize:function(g,f){this.element=g;this.namedGraphNode=f},getArgs:function(){return[this.element]},copy:function(g){if(g.length!=1){throw"Invalid argument"}var h=g[0];var f=new e.ElementNamedGraph(h,this.namedGraphNode);return f},toString:function(){return"Graph "+this.namedGraphNode+" { "+this.element+" }"},copySubstitute:function(f){return new e.ElementNamedGraph(this.element.copySubstitute(f),this.namedGraphNode.copySubstitute(f))},getVarsMentioned:function(){var f=this.element.getVarsMentioned();if(this.namedGraphNode.isVar()){_.union(f,[this.namedGraphNode])}return f},flatten:function(){return new e.ElementNamedGraph(this.element.flatten(),this.namedGraphNode)}});e.ElementString=Class.create(e.Element,{classLabel:"jassa.sparql.ElementString",initialize:function(f){this.sparqlString=f},getArgs:function(){return[]},copy:function(f){if(f.length!=0){throw"Invalid argument"}return this},toString:function(){return this.sparqlString.getString()},copySubstitute:function(f){var g=this.sparqlString.copySubstitute(f);return new e.ElementString(g)},getVarsMentioned:function(){return this.sparqlString.getVarsMentioned()},flatten:function(){return this}});e.ElementString.create=function(h,g){var f=new e.ElementString(e.SparqlString.create(h,g));return f};e.ElementSubQuery=Class.create(e.Element,{classLabel:"jassa.sparql.ElementSubQuery",initialize:function(f){this.query=f},getArgs:function(){return[]},copy:function(g){if(g.length!=0){throw"Invalid argument"}var f=new e.ElementSubQuery(query);return f},toString:function(){return"{ "+this.query+" }"},copySubstitute:function(f){return new e.ElementSubQuery(this.query.copySubstitute(f))},flatten:function(){return new e.ElementSubQuery(this.query.flatten())},getVarsMentioned:function(){return this.query.getVarsMentioned()}});e.ElementFilter=Class.create(e.Element,{classLabel:"jassa.sparql.ElementFilter",initialize:function(f){if(_(f).isArray()){console.log("[WARN] Array argument for filter is deprecated");f=e.andify(f)}this.expr=f},getArgs:function(){return[]},copy:function(g){if(g.length!=0){throw"Invalid argument"}var f=new e.ElemenFilter(this.expr);return f},copySubstitute:function(f){var g=this.expr.copySubstitute(f);return new e.ElementFilter(g)},getVarsMentioned:function(){return this.expr.getVarsMentioned()},flatten:function(){return this},toString:function(){return"Filter("+this.expr+")"}});e.ElementOptional=Class.create(e.Element,{classLabel:"jassa.sparql.ElementOptional",initialize:function(f){this.optionalPart=f},getArgs:function(){return[this.optionalPart]},copy:function(g){if(g.length!=1){throw"Invalid argument"}var f=new e.ElementOptional(this.expr);return f},getVarsMentioned:function(){return this.optionalPart.getVarsMentioned()},copySubstitute:function(f){return new e.ElementOptional(this.optionalPart.copySubstitute(f))},flatten:function(){return new e.ElementOptional(this.optionalPart.flatten())},toString:function(){return"Optional {"+this.optionalPart+"}"}});e.ElementUnion=Class.create(e.Element,{classLabel:"jassa.sparql.ElementUnion",initialize:function(f){this.elements=f?f:[]},getArgs:function(){return this.elements},copy:function(g){var f=new e.ElementUnion(g);return f},getVarsMentioned:function(){var f=[];for(var g in this.elements){f=_.union(f,this.elements[g].getVarsMentioned())}return f},copySubstitute:function(g){var f=_.map(this.elements,function(h){return h.copySubstitute(g)});return new e.ElementUnion(f)},flatten:function(){var f=_.map(this.elements,function(g){return g.flatten()});return new e.ElementUnion(f)},toString:function(){return"{"+this.elements.join("} Union {")+"}"}});e.ElementTriplesBlock=Class.create(e.Element,{classLabel:"jassa.sparql.ElementTriplesBlock",initialize:function(f){this.triples=f?f:[]},getArgs:function(){return[]},copy:function(g){if(g.length!=0){throw"Invalid argument"}var f=new e.ElementTriplesBlock(this.triples);return f},getTriples:function(){return this.triples},addTriples:function(f){this.triples=this.triples.concat(f)},uniq:function(){this.triples=e.uniqTriples(this.triples)},copySubstitute:function(g){var f=_.map(this.triples,function(h){return h.copySubstitute(g)});return new e.ElementTriplesBlock(f)},getVarsMentioned:function(){var f=[];_.each(this.triples,function(g){f=_.union(f,g.getVarsMentioned())});return f},flatten:function(){return this},toString:function(){return this.triples.join(" . ")}});e.ElementGroup=Class.create(e.Element,{classLabel:"jassa.sparql.ElementGroup",initialize:function(f){this.elements=f?f:[]},getArgs:function(){return this.elements},copy:function(g){var f=new e.ElementTriplesBlock(g);return f},copySubstitute:function(g){var f=_.map(this.elements,function(h){return h.copySubstitute(g)});return new e.ElementGroup(f)},getVarsMentioned:function(){var f=e.PatternUtils.getVarsMentioned(this.elements);return f},toString:function(){return e.joinElements(" . ",this.elements)},flatten:function(){var f=e.ElementUtils.flatten(this.elements);if(f.length===1){return f[0]}else{return new e.ElementGroup(e.ElementUtils.flattenElements(f))}}});e.joinElements=function(j,h){var g=_.map(h,function(k){return""+k});var f=_.filter(g,function(k){return k.length!=0});return f.join(j)};e.newUnaryExpr=function(j,g){if(g.length!=1){throw"Invalid argument"}var h=g[0];var f=new j(h);return f};e.newBinaryExpr=function(k,g){if(g.length!=2){throw"Invalid argument"}var j=g[0];var h=g[1];var f=new k(j,h);return f};e.QueryType={};e.QueryType.Unknown=-1;e.QueryType.Select=0;e.QueryType.Construct=1;e.QueryType.Ask=2;e.QueryType.Describe=3;e.VarExprList=Class.create({classLabel:"jassa.sparql.VarExprList",initialize:function(){this.vars=[];this.varToExpr={}},getVarList:function(){return this.vars},getVars:function(){return this.vars},getExprMap:function(){return this.varToExpr},add:function(f,g){if(this.contains(f)){console.log("VarExprList already contained "+f);throw"Bailing out"}this.vars.push(f);if(g){this.varToExpr[f.getName()]=g}},contains:function(g){var f=_(this.vars).some(function(j){var h=g.equals(j);return h});return f},getExpr:function(g){var h=g.getName();var f=this.varToExpr[h];return f},addAll:function(g){var h=g.getVars();var f=this;_(h).each(function(j){var k=g.getExpr(j);f.add(j,k)})},entries:function(){var g=this;var f=_(this.vars).map(function(h){var j=g.varToExpr[h.getName()];return{v:h,expr:j}});return f},copySubstitute:function(j){var g=new e.VarExprList();var f=this.entries();for(var h=0;h<f.length;++h){var l=f[h];var m=j(l.v);var k=l.expr?l.expr.copySubstitute(j):null;g.add(m,k)}return g},toString:function(){var g=[];var l=this.entries();for(var j=0;j<l.length;++j){var k=l[j];var h=k.v;var m=k.expr;if(m){g.push("("+m+" As "+h+")")}else{g.push(""+h)}}var f=g.join(" ");return f}});e.SortCondition=Class.create({classLabel:"jassa.sparql.SortCondition",initialize:function(g,f){this.expr=g;this.direction=f},getExpr:function(){return this.expr},getDirection:function(){return this.direction},toString:function(){var f;if(this.direction>=0){f="Asc("+this.expr+")"}else{if(this.direction<0){f="Desc("+this.expr+")"}}return f},copySubstitute:function(h){var g=this.expr.copySubstitute(h);var f=new e.SortCondition(g,this.direction);return f}});e.Query=Class.create({classLabel:"jassa.sparql.Query",initialize:function(){this.type=0;this.distinct=false;this.reduced=false;this.resultStar=false;this.projectVars=new e.VarExprList();this.groupBy=[];this.orderBy=[];this.elements=[];this.constructTemplate=null;this.limit=null;this.offset=null},isResultStar:function(){return this.resultStar},setResultStar:function(f){this.resultStar=(f===true)?true:false},getQueryPattern:function(){return this.elements[0]},setQueryPattern:function(f){b.ArrayUtils.clear(this.elements);this.elements.push(f)},getElements:function(){return this.elements},getProjectVars:function(){var f=this.projectVars?this.projectVars.getVars():null;return f},setProjectVars:function(f){this.projectVars=f},getProject:function(){return this.projectVars},getGroupBy:function(){return this.groupBy},getOrderBy:function(){return this.orderBy},getLimit:function(){return this.limit},getOffset:function(){return this.offset},setLimit:function(f){this.limit=f},setOffset:function(f){this.offset=f},toStringOrderBy:function(){var f=(this.orderBy&&this.orderBy.length>0)?"Order By "+this.orderBy.join(" ")+" ":"";return f},toStringGroupBy:function(){var f=(this.groupBy&&this.groupBy.length>0)?"Group By "+this.groupBy.join(" ")+" ":"";return f},clone:function(){return this.copySubstitute(e.fnIdentity)},flatten:function(){var f=this.clone();var h=_.map(f.elements,function(j){return j.flatten()});var g=e.ElementUtils.flattenElements(h);f.elements=g;return f},getVarsMentioned:function(){console.log("sparql.Query.getVarsMentioned(): Not implemented properly yet. Things may break!");var f=_(this.elements).reduce(function(h,j){var g=j.getVarsMentioned();var k=_(h).union(g);return k},[]);return f},copySubstitute:function(g){var f=new e.Query();f.type=this.type;f.distinct=this.distinct;f.reduced=this.reduced;f.resultStar=this.resultStar;f.limit=this.limit;f.offset=this.offset;f.projectVars=this.projectVars.copySubstitute(g);if(this.constructTemplate){f.constructTemplate=this.constructTemplate.copySubstitute(g)}f.orderBy=this.orderBy==null?null:_.map(this.orderBy,function(h){return h.copySubstitute(g)});f.groupBy=this.groupBy==null?null:_.map(this.groupBy,function(h){return h.copySubstitute(g)});f.elements=_(this.elements).map(function(h){var j=h.copySubstitute(g);return j});return f},setOptions:function(f){if(typeof f==="undefined"){return}if(typeof f.limit!=="undefined"){this.setLimit(f.limit)}if(typeof(f.offset)!=="undefined"){this.setOffset(f.offset)}if(typeof(f.distinct)!=="undefined"){this.setDistinct(f.distinct)}},setOffset:function(f){this.offset=f?f:null},setLimit:function(f){if(f===0){this.limit=0}else{this.limit=f?f:null}},isDistinct:function(){return this.distinct},setDistinct:function(f){this.distinct=(f===true)?true:false},isReduced:function(){return this.reduced},setReduced:function(f){this.reduced=(f===true)?true:false},toString:function(){switch(this.type){case e.QueryType.Select:return this.toStringSelect();case e.QueryType.Construct:return this.toStringConstruct()}},toStringProjection:function(){if(this.resultStar){return"*"}return""+this.projectVars},toStringLimitOffset:function(){var f="";if(this.limit!=null){f+=" Limit "+this.limit}if(this.offset!=null){f+=" Offset "+this.offset}return f},toStringSelect:function(){var g=this.distinct?"Distinct ":"";var f="Select "+g+this.toStringProjection()+" {"+e.joinElements(" . ",this.elements)+"} "+this.toStringGroupBy()+this.toStringOrderBy()+this.toStringLimitOffset();return f},toStringConstruct:function(){var f="Construct "+this.constructTemplate+" {"+e.joinElements(" . ",this.elements)+"}"+this.toStringOrderBy()+this.toStringLimitOffset();return f}});e.fnIdentity=function(f){return f};e.opifyBalanced=function(n,l){if(n.length===0){return null}var h=n;while(h.length>1){var k=[];for(var j=0;j<h.length;j+=2){var m=j+1<h.length;var g=h[j];if(m){var f=h[j+1];k.push(new l(g,f))}else{k.push(g)}}h=k}return h[0]};e.opify=e.opifyBalanced})();(function(){var c=Jassa.rdf;var b=Jassa.util;var d=Jassa.sparql;d.VarGenerator=Class.create({initialize:function(e){this.generator=e},next:function(){var f=this.generator.next();var e=c.NodeFactory.createVar(f);return e}});d.VarUtils={createVars:function(f){var e=f.map(function(g){return c.NodeFactory.createVar(g)});return e},getVarNames:function(f){var e=f.map(function(g){return g.getName()});return e},createVarGen:function(j,g){if(!j){j="v"}var h=this.getVarNames(g);var k=d.GenSym.create(j);var f=new sparql.GeneratorBlacklist(k,h);var e=new d.VarGenerator(f);return e}};d.Generator=Class.create({next:function(){throw"Override me"}});d.GenSym=Class.create(d.Generator,{initialize:function(e,f){this.prefix=e?e:"v";this.nextValue=f?f:0},next:function(){++this.nextValue;var e=this.prefix+"_"+this.nextValue;return e}});d.GenSym.create=function(f){var e=new d.GenSym(f,0);return e};d.GeneratorBlacklist=Class.create(d.Generator,{initialize:function(f,e){this.generator=f;this.blacklist=e},next:function(){var e;do{e=this.generator.next()}while(_.contains(this.blacklist,e));return e}});d.fnToString=function(e){return e.toString()};d.fnGetVarName=function(e){return e.getName()};d.PatternUtils={getVarsMentioned:function(f){var e=_(f).reduce(function(g,h){var j=h.getVarsMentioned;if(!j||!_(j).isFunction()){console.log("[ERROR] .getVarsMentioned not found on object ",h)}var l=h.getVarsMentioned();var k=_(g).union(l);return k},[]);return e},};d.ElementFactory=Class.create({createElement:function(){throw"Not overridden"}});d.ElementFactoryConst=Class.create(d.ElementFactory,{initialize:function(e){this.element=e},createElement:function(){return this.element}});d.ElementFactoryCombine=Class.create(d.ElementFactory,{initialize:function(e,g,f){this.simplify=e;this.elementFactories=g;this.forceGroup=f},isSimplify:function(){return this.simplify},getElementFactories:function(){return this.elementFactories},isForceGroup:function(){return this.forceGroup},createElement:function(){var g=_(this.elementFactories).chain().map(function(h){var j=h.createElement();return j}).filter(function(h){return h!=null}).value();var e=new sparql.ElementGroup(g);if(this.simplify){e=e.flatten()}if(!this.forceGroup){var f=e.getArgs();if(f.length===1){e=f[0]}}return e}});d.ElementFactoryJoin=Class.create(d.ElementFactory,{initialize:function(j,g,f,e,h){this.elementFactoryA=j;this.elementFactoryB=g;this.joinVarsA=f;this.joinVarsB=e;this.joinType=h?h:d.JoinType.INNER_JOIN},createElement:function(){var g=this.elementFactoryA.createElement();var f=this.elementFactoryB.createElement();var j=g.getVarsMentioned();var h=f.getVarsMentioned();var k=d.ElementUtils.createJoinVarMap(h,j,this.joinVarsB,this.joinVarsA);g=d.ElementUtils.createRenamedElement(g,k);if(this.joinType==d.JoinType.LEFT_JOIN){f=new d.ElementOptional(f)}var e=new d.ElementGroup([g,f]);return e}});d.ElementFactoryJoinConcept=Class.create(d.ElementFactory,{initialize:function(f,e,g){this.conceptFactoryA=f;this.conceptFactoryB=e;this.joinType=g||d.JoinType.INNER_JOIN},createElement:function(){var j=this.conceptFactoryA.createConcept();var h=this.conceptFactoryB.createConcept();var g=j.getElement();var f=h.getElement();if(h.isSubjectConcept()){return g}var n=[j.getVar()];var m=[h.getVar()];var o=d.JoinBuilderElement.create(g);var l=o.joinAny(this.joinType,n,f,m);var k=l.getJoinBuilder();var e=k.getElements();var p=new sparql.ElementGroup(e);return p}});d.ElementUtils={createFilterElements:function(f){var e=_(f).map(function(h){var g=new sparql.ElementFilter(h);return g});return e},createElementsTriplesBlock:function(g){var e=[];if(g.length>0){var f=new sparql.ElementTriplesBlock(g);e.push(f)}return e},flatten:function(f){var e=_.map(f,function(g){return g.flatten()});return e},flattenElements:function(h){var e=[];var j=[];var g=[];_.each(h,function(k){if(k instanceof d.ElementGroup){g.push.apply(g,k.elements)}else{g.push(k)}});_.each(g,function(k){if(k instanceof d.ElementTriplesBlock){j.push.apply(j,k.getTriples())}else{e.push(k)}});if(j.length>0){var f=d.uniqTriples(j);e.unshift(new d.ElementTriplesBlock(f))}return e},createDistinctVarMap:function(h,j,m){var f=h.map(d.fnGetVarName);var l=j.map(d.fnGetVarName);if(m==null){var k=new d.GenSym("v");m=new d.GeneratorBlacklist(k,f)}var e=new b.HashBidiMap(d.fnNodeEquals);_(j).each(function(n){var p=n.getName();var o;if(_(f).contains(p)){var g=m.next();o=d.Node.v(g)}else{o=n}e.put(n,o)});return e},createJoinVarMap:function(h,m,j,k,g){if(j.length!=k.length){console.log("[ERROR] Cannot join on different number of columns");throw"Bailing out"}var n=d.ElementUtils.createDistinctVarMap(h,m,g);for(var e=0;e<j.length;++e){var f=j[e];var l=k[e];n.put(l,f)}return n},createRenamedElement:function(f,g){var e=function(k){var j=g.get(k);return j};var h=f.copySubstitute(e);return h},};d.ExprUtils={copySubstitute:function(g,h){var f=(function(l){var j=null;if(l.isVar()){var k=h.get(l);if(k!=null){j=k}}if(j==null){j=l}return j});var e=g.copySubstitute(f);return e},bindingToExprs:function(g,f){if(f==null){f=g.getVars()}var e=_(f).each(function(j){var h=new sparql.ExprVar(j);var l=g.get(j);var k=sparql.NodeValue.makeNode(l);var m=new sparql.E_Equal(h,k);return m});return e}}})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.sparql;c.JoinType={INNER_JOIN:"inner_join",LEFT_JOIN:"left_join"};c.JoinNode=Class.create({initialize:function(g,e,f){this.joinBuilder=g;this.alias=e;this.targetJoinVars},getJoinBuilder:function(){return this.joinBuilder},getJoinVars:function(){return this.targetJoinVars},getElement:function(){return this.joinBuilder.getElement(this.alias)},getVarMap:function(){return this.joinBuilder.getVarMap(this.alias)},getJoinNodeInfos:function(){var g=this.joinBuilder.getState(this.alias);var h=this.joinBuilder;var f=this;var e=_(g.getJoinInfos()).map(function(j){var l=j.getAlias();var k=f.joinBuilder.getJoinNode(l);var m=new c.JoinNodeInfo(k,j.getJoinType());return m});return e},joinAny:function(k,h,g,j,f){var e=this.joinBuilder.addJoin(k,this.alias,h,g,j,f);return e},join:function(h,g,j,f){var e=this.joinAny(c.JoinType.INNER_JOIN,h,g,j,f);return e},leftJoin:function(h,g,j,f){var e=this.joinAny(c.JoinType.LEFT_JOIN,h,g,j,f);return e},joinTree:function(e){},leftJoinTree:function(e){},joinTreeAny:function(e){}});c.JoinNodeInfo=Class.create({initialize:function(f,e){this.joinNode=f;this.joinType=e},getJoinNode:function(){return this.joinNode},getJoinType:function(){return this.joinType},toString:function(){return this.joinType+" "+this.joinNode}});c.JoinInfo=Class.create({initialize:function(e,f){this.alias=e;this.joinType=f},getAlias:function(){return this.alias},getJoinType:function(){return this.joinType},toString:function(){return this.joinType+" "+this.alias}});c.JoinTargetState=Class.create({initialize:function(g,h,e,f){this.varMap=g;this.joinNode=h;this.element=e;this.elementVars=f;this.joinInfos=[]},getVarMap:function(){return this.varMap},getJoinNode:function(){return this.joinNode},getElement:function(){return this.element},getElementVars:function(){return this.elementVars},getJoinInfos:function(){return this.joinInfos}});c.JoinBuilderElement=Class.create({initialize:function(f,e,h,g){if(f==null){console.log("[Error] Root element must not be null");throw"Bailing out"}this.usedVarNames=[];this.usedVars=[];this.aliasGenerator=new c.GenSym("a");this.varNameGenerator=new c.GeneratorBlacklist(new c.GenSym("v"),this.usedVarNames);this.aliasToState={};this.rootAlias=h?h:this.aliasGenerator.next();if(g==null){g=[]}var j=this.createTargetState(this.rootAlias,new b.HashBidiMap(),g,f,e,g);this.aliasToState[this.rootAlias]=j;this.rootNode=j.getJoinNode()},getRootNode:function(){return this.rootNode},getJoinNode:function(f){var g=this.aliasToState[f];var e=g?g.getJoinNode():null;return e},getState:function(e){return this.aliasToState[e]},getElement:function(f){var g=this.aliasToState[f];var e=g?g.getElement():null;return e},addVars:function(f){var e=this;_(f).each(function(g){var j=g.getName();var h=_(e.usedVarNames).contains(j);if(!h){e.usedVarNames.push(j);e.usedVars.push(g)}})},createTargetState:function(e,g,l,h,f,n){var q=l.map(function(r){var s=g.get(r);return s});var m=c.ElementUtils.createJoinVarMap(this.usedVars,f,q,n,this.varGenerator);var o=null;if(h!=null){o=c.ElementUtils.createRenamedElement(h,m)}var k=m.getInverse().keyList();this.addVars(k);var p=new c.JoinNode(this,e,n);var j=new c.JoinTargetState(m,p,o,k);return j},addJoin:function(p,k,n,l,o,g){var f=this.aliasToState[k];var j=f.getVarMap();if(!g){g=this.aliasGenerator.next()}var e=l.getVarsMentioned();var m=this.createTargetState(g,j,n,l,e,o);var h=new c.JoinInfo(g,p);f.getJoinInfos().push(h);this.aliasToState[g]=m;var q=m.getJoinNode();return q},getElementsRec:function(h){var j=[];var g=h.getElement();if(g!=null){j.push(g)}var f=h.getJoinNodeInfos();var e=this;_(f).each(function(o){var l=o.getJoinNode();var n=e.getElementsRec(l);var k=new c.ElementGroup(n);var m=o.getJoinType();switch(m){case c.JoinType.LEFT_JOIN:k=new c.ElementOptional(k);break;case c.JoinType.INNER_JOIN:break;default:console.log("[ERROR] Unsupported join type: "+m);throw"Bailing out"}j.push(k)});return j},getElements:function(){var f=this.getRootNode();var e=this.getElementsRec(f);return e;return e},getAliasToVarMap:function(){var e={};_(this.aliasToState).each(function(g,f){e[f]=g.varMap});return e}});c.JoinBuilderUtils={getChildren:function(e){return e.getJoinNodes()}};c.JoinBuilderElement.create=function(g,h,f){var j=g.getVarsMentioned();var k=new c.JoinBuilderElement(g,j,h,f);var e=k.getRootNode();return e};c.JoinBuilderElement.createWithEmptyRoot=function(f,g){var h=d.VarUtils.varNamesToNodes(f);var j=new c.JoinBuilderElement(null,h,g);var e=j.getRootNode();return e}})();(function(){var b=Jassa.util;var c=Jassa.service;c.ResultSet=Class.create(b.Iterator,{getVarNames:function(){throw"Override me"}});c.ResultSetArrayIteratorBinding=Class.create(c.ResultSet,{initialize:function(e,d){this.itBinding=e;this.varNames=d},hasNext:function(){return this.itBinding.hasNext()},next:function(){return this.nextBinding()},nextBinding:function(){return this.itBinding.next()},getVarNames:function(){return this.varNames},getBindings:function(){return this.itBinding.getArray()},getIterator:function(){return this.itBinding}})})();(function(d){var b=Jassa.util;var c=Jassa.service;c.SparqlService=Class.create({getServiceId:function(){console.log("[ERROR] Method not overridden");throw"[ERROR] Method not overridden"},getStateHash:function(){console.log("[ERROR] Method not overridden");throw"[ERROR] Method not overridden"},createQueryExecution:function(e){console.log("[ERROR] Method not overridden");throw"[ERROR] Method not overridden"}});c.SparqlServiceBaseString=Class.create(c.SparqlService,{createQueryExecution:function(f){var e;if(_(f).isString()){e=this.createQueryExecutionStr(f)}else{e=this.createQueryExecutionObj(f)}return e},createQueryExecutionObj:function(f){var g=""+f;var e=this.createQueryExecutionStr(g);return e},createQueryExecutionStr:function(e){throw"Not implemented"}});c.SparqlServiceHttp=Class.create(c.SparqlServiceBaseString,{initialize:function(e,h,f,g){this.serviceUri=e;this.defaultGraphUris=h;this.ajaxOptions=f;this.httpArgs=g},getServiceId:function(){return this.serviceUri},getStateHash:function(){var e=JSONCanonical.stringify(this.defaultGraphUris);e+=JSONCanonical.stringify(this.httpArgs);return e},hashCode:function(){return this.getServiceId()+"/"+this.getStateHash()},setDefaultGraphs:function(e){this.defaultGraphUris=e},getDefaultGraphs:function(){return this.defaultGraphUris},createQueryExecutionStr:function(g){var f=_({}).defaults(this.ajaxOptions);var e=new c.QueryExecutionHttp(g,this.serviceUri,this.defaultGraphUris,f,this.httpArgs);return e},createQueryExecutionObj:function($super,g){if(true){if(g.flatten){var f=g;g=f.flatten()}}var e=$super(g);return e}});c.RequestCache=Class.create({initialize:function(e,f){this.executionCache=e?e:{};this.resultCache=f?f:new Cache()},getExecutionCache:function(){return this.executionCache},getResultCache:function(){return this.resultCache}});c.SparqlServiceCache=Class.create(c.SparqlServiceBaseString,{initialize:function(e,g,f){this.qef=e;this.requestCache=new c.RequestCache()},getServiceId:function(){return this.qef.getServiceId()},getStateHash:function(){return this.qef.getStateHash()},hashCode:function(){return"cached:"+this.qef.hashCode()},createQueryExecutionStr:function(k){var h=this.qef.getServiceId();var f=this.qef.getStateHash();var j=h+"-"+f+k;var g=this.qef.createQueryExecution(k);var e=new c.QueryExecutionCache(g,j,this.requestCache);return e}})})(jQuery);(function(){var util=Jassa.util;var sparql=Jassa.sparql;var ns=Jassa.service;ns.QueryCacheNodeFactory=Class.create({createQueryCache:function(sparqlService,query,indexExpr){throw"Not overridden"}});ns.QueryCacheNodeFactoryImpl=Class.create(ns.QueryCacheNodeFactory,{initialize:function(){this.keyToCache=new Cache()},createQueryCache:function(sparqlService,query,indexExpr){var key="cache:/"+sparqlService.getServiceId()+"/"+sparqlService.getServiceState()+"/"+query+"/"+indexExpr;console.log("cache requested with id: "+key);var cache=this.keyToCache.getItem(key);if(cache==null){cache=new ns.QueryCacheBindingHashSingle(sparqlService,query,indexExpr);this.keyToCache.addItem(key,cache)}return cache}});ns.QueryCacheBindingHashSingle=Class.create({initialize:function(sparqlService,query,indexExpr){this.sparqlService=sparqlService;this.query=query;this.indexExpr=indexExpr;this.maxChunkSize=50;this.exprEvaluator=new sparql.ExprEvaluatorImpl();this.nodeToBindings=new Cache();this.nodeMisses=new Cache()},fetchResultSet:function(nodes){var self=this;var nodeToBindings=this.nodeToBindings;var stats=this.analyze(nodes);var resultBindings=[];_(stats.cachedNodes).each(function(node){var bindings=nodeToBindings.getItem(node.toString());resultBindings.push.apply(resultBindings,bindings)});var fetchTasks=_(stats.nonCachedChunks).map(function(chunk){var promise=self.fetchChunk(chunk);return promise});var masterTask=$.when.apply(window,fetchTasks);var exprEvaluator=this.exprEvaluator;var indexExpr=this.indexExpr;var result=masterTask.pipe(function(){var seenKeys={};for(var i=0;i<arguments.length;++i){var rs=arguments[i];while(rs.hasNext()){var binding=rs.nextBinding();resultBindings.push(binding);var keyNode=exprEvaluator.eval(indexExpr,binding);var hashKey=keyNode.toString();seenKeys[hashKey]=keyNode;var cacheEntry=nodeToBindings.getItem(hashKey);if(cacheEntry==null){cacheEntry=[];nodeToBindings.setItem(hashKey,cacheEntry)}cacheEntry.push(binding)}}var itBinding=new util.IteratorArray(resultBindings);var r=new ns.ResultSetArrayIteratorBinding(itBinding);return r});return result},fetchChunk:function(nodes){var query=this.query.clone();var filterExpr=new sparql.E_OneOf(this.indexExpr,nodes);var filterElement=new sparql.ElementFilter([filterExpr]);query.getElements().push(filterElement);var qe=this.sparqlService.createQueryExecution(query);var result=qe.execSelect();return result},analyze:function(nodes){var nodeToBindings=this.nodeToBindings;var cachedNodes=[];var nonCachedNodes=[];_(nodes).each(function(node){var nodeStr=node.toString();var entry=nodeToBindings.getItem(node.toString());if(entry==null){nonCachedNodes.push(node)}else{cachedNodes.push(node)}});var maxChunkSize=this.maxChunkSize;var nonCachedChunks=[];for(var i=0;i<nonCachedNodes.length;i+=maxChunkSize){var chunk=nodes.slice(i,i+maxChunkSize);nonCachedChunks.push(chunk)}var result={cachedNodes:cachedNodes,nonCachedNodes:nonCachedNodes,nonCachedChunks:nonCachedChunks,maxChunkSize:maxChunkSize};return result}})})();(function(d){var b=Jassa.util;var c=Jassa.service;c.QueryExecution=Class.create({execSelect:function(){throw"Not overridden"},execAsk:function(){throw"Not overridden"},execDescribeTriples:function(){throw"Not overridden"},execConstructTriples:function(){throw"Not overridden"},setTimeout:function(e){throw"Not overridden"}});c.QueryExecutionHttp=Class.create(c.QueryExecution,{initialize:function(j,e,h,f,g){this.queryString=j;this.serviceUri=e;this.defaultGraphUris=h;this.ajaxOptions=f||{};this.httpArgs=g},execSelect:function(){var e=this.execAny().pipe(c.ServiceUtils.jsonToResultSet);return e},execAsk:function(){var e=this.execAny().pipe(function(f){return f["boolean"]});return e},execConstructTriples:function(){throw"Not implemented yet"},execDescribeTriples:function(){throw"Not implemented yet"},setTimeout:function(e){this.ajaxOptions.timeout=e},getTimeout:function(){return this.ajaxOptions.timeout},execAny:function(){var f=c.ServiceUtils.createSparqlRequestAjaxSpec(this.serviceUri,this.defaultGraphUris,this.queryString,this.httpArgs,this.ajaxOptions);var e=d.ajax(f);return e}});c.QueryExecutionCache=Class.create(c.QueryExecution,{initialize:function(g,f,e){this.queryExecution=g;this.cacheKey=f;this.requestCache=e},setTimeout:function(e){this.queryExecution.setTimeout(e)},execSelect:function(){var j=this.cacheKey;var e=this.requestCache;var f=e.getResultCache();var k=e.getExecutionCache();var l=k[j];if(!l){var n=f.getItem(j);if(n){var m=d.Deferred();m.resolve(n);l=m.promise()}else{var h=this.queryExecution.execSelect();var p=h.pipe(function(r){var q={bindings:r.getBindings(),varNames:r.getVarNames()};return q});var g=false;l=p.pipe(function(q){g=true;delete k[j];f.setItem(j,q);return q});if(!g){k[j]=l}}}else{console.log("[INFO] Joined query execution for: "+j)}var o=l.pipe(function(q){var r=c.QueryExecutionCache.createResultSetFromCacheData(q);return r});return o}});c.QueryExecutionCache.createResultSetFromCacheData=function(f){var h=new b.IteratorArray(f.bindings);var e=f.varNames;var g=new c.ResultSetArrayIteratorBinding(h,e);return g}})(jQuery);(function(){var b=Jassa.util;var c=Jassa.service;c.QueryPaginator=Class.create({initialize:function(f,d){this.query=f;var e=f.getOffset();var g=f.getLimit();this.nextOffset=e||0;this.nextRemaining=g==null?null:g;this.pageSize=d},getPageSize:function(){return this.pageSize},next:function(){var e=this.nextOffset===0?null:this.nextOffset;this.query.setOffset(e);if(this.nextRemaining==null){this.query.setLimit(this.pageSize);this.nextOffset+=this.pageSize}else{var d=Math.min(this.pageSize,this.nextRemaining);this.nextOffset+=d;this.nextRemaining-=d;if(d===0){return null}this.query.setLimit(d)}return this.query}});c.QueryExecutionPaginate=Class.create(c.QueryExecution,{initialize:function(e,f,d){this.sparqlService=e;this.query=f;this.pageSize=d;this.timeoutInMillis=null},executeSelectRec:function(j,h,e){var g=j.next();console.log("Query Pagination: "+g);if(!g){e.resolve(h);return}var d=this;var f=this.sparqlService.createQueryExecution(g);f.setTimeout(this.timeoutInMillis);f.execSelect().done(function(n){if(!n){throw"Null result set for query: "+g}var k;if(!h){k=n}else{var o=h.getIterator().getArray();var p=n.getIterator().getArray();var r=o.concat(p);var m=new b.IteratorArray(r);k=new c.ResultSetArrayIteratorBinding(m)}var q=n.getIterator().getArray().length;var l=j.getPageSize();if(q===0||q<l){e.resolve(k)}else{return d.executeSelectRec(j,k,e)}}).fail(function(){e.fail()})},execSelect:function(){var g=this.query.clone();var d=this.pageSize||c.QueryExecutionPaginate.defaultPageSize;var f=new c.QueryPaginator(g,d);var e=$.Deferred();this.executeSelectRec(f,null,e);return e.promise()},setTimeout:function(d){this.timeoutInMillis=d;if(!this.timeoutMsgShown){console.log("[WARN] Only preliminary timeout implementation for paginated query execution");this.timeoutMsgShown=true}}});c.QueryExecutionPaginate.defaultPageSize=1000;c.SparqlServicePaginate=Class.create(c.SparqlService,{initialize:function(e,d){this.sparqlService=e;this.pageSize=d},getServiceId:function(){return this.sparqlService.getServiceId()},getStateHash:function(){return this.sparqlService.getStateHash()},hashCode:function(){return"paginate:"+this.sparqlService.hashCode()},createQueryExecution:function(e){var d=new c.QueryExecutionPaginate(this.sparqlService,e,this.pageSize);return d}})})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.service;c.SparqlServiceVirtFix=Class.create(c.SparqlService,{initialize:function(e){this.sparqlService=e},getServiceId:function(){return this.sparqlService.getServiceId()},getStateHash:function(){return this.sparqlService.getStateHash()},hashCode:function(){return"virtfix:"+this.sparqlService.hashCode()},createQueryExecution:function(m){var n=m.getOrderBy();var g=m.getLimit();var h=m.getOffset();var k=n.length>0&&(g||h);var f;if(k){var j=m.clone();j.setLimit(null);j.setOffset(null);f=new d.Query();var l=new d.ElementSubQuery(j);f.getElements().push(l);f.setLimit(g);f.setOffset(h);f.setResultStar(true)}else{f=m}var o=this.sparqlService.createQueryExecution(f);return o}})})();(function(e){var b=Jassa.util;var d=Jassa.sparql;var f=Jassa.facete;var c=Jassa.service;c.ServiceUtils={consumeResultSet:function(g){while(g.hasNext()){g.nextBinding()}},resultSetToList:function(h,j){var g=[];while(h.hasNext()){var l=h.nextBinding();var k=l.get(j);g.push(k)}return g},resultSetToInt:function(h,j){var g=null;if(h.hasNext()){var l=h.nextBinding();var k=l.get(j);g=k.getLiteralValue()}return g},fetchList:function(k,j){var h=this;var g=k.execSelect().pipe(function(l){var m=h.resultSetToList(l,j);return m});return g},fetchInt:function(k,j){var h=this;var g=k.execSelect().pipe(function(l){var m=h.resultSetToInt(l,j);return m});return g},fetchCountQuery:function(h,p,n,k){var g=[new d.ElementSubQuery(p)];var m=p.getVarsMentioned();var o=d.VarUtils.createVarGen("c",m);var u=o.next();var l=f.QueryUtils.createQueryCount(g,null,null,u,null,null,null);var j=h.createQueryExecution(l);j.setTimeout(n);var r=jQuery.Deferred();var q=c.ServiceUtils.fetchInt(j,u);q.done(function(v){r.resolve({count:v,limit:null,hasMoreItems:false})}).fail(function(){var w=f.QueryUtils.createQueryCount(g,k,null,u,null,null,null);var v=h.createQueryExecution(w);var x=c.ServiceUtils.fetchInt(v,u);x.done(function(y){r.resolve({count:y,limit:k,hasMoreItems:y>=k})}).fail(function(){r.fail()})});var s=r.promise();return s},createSparqlRequestAjaxSpec:function(k,j,n,h,m){var l={query:n,"default-graph-uri":j,};var g={url:k,dataType:"json",crossDomain:true,traditional:true,data:l};_(l).defaults(h);_(g).defaults(m);return g},jsonToResultSet:function(l){var h=l.head.vars;var m=l.results.bindings;var k=m.map(function(n){var o=d.Binding.fromTalisJson(n);return o});var j=new b.IteratorArray(k);var g=new c.ResultSetArrayIteratorBinding(j,h);return g}}})(jQuery);(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.service;c.Buffer=Class.create({isFull:function(){throw"Not overridden"}});c.BufferSet=Class.create(c.Buffer,{initialize:function(f){this.data=new b.SetList();this.maxItemCount=f},add:function(f){if(this.isFull()){throw"Buffer was full with "+this.maxItemCount+" items; Could not add item "+f}this.data.add(f)},isFull:function(){var f=this.data.size()>=this.maxItemCount;return f},clear:function(){this.data.clear()},entries:function(){}});c.BindingLookup=Class.create({initialize:function(g,h,f){this.sparqlService=g;this.element=h},lookupByIterator:function(k){var f=[];while(k.hasNext()){var m=k.nextBinding();var l=d.ExprUtils.bindingToExprs(m);var g=l.join(", ");f.push({binding:m,exprs:l,exprsKey:g})}var n=new d.ElementFilter(expr);var j=this.query.clone();j.getElements().push(n);var h=this.sparqlService.execSelect(j)}});c.ResultSetHashJoin=Class.create(b.IteratorAbstract,{initialize:function(g,j,f,h){this.rsA=g;this.serviceB=j;this.elementB=f;this.expr=h;g.getVarsMentioned();h.getVarsMentioned()},$prefetch:function(){var g=20;var f=[];while(rsA.hasNext()){}if(f.isFull()||!rsa.hasNext()){}}});var e={createResultSetJoinHash:function(g,j,f,h){},execJoin:function(h,g,f,j){}}})();(function(){var b=Jassa.service;b.SparqlServiceFactory=Class.create({createSparqlService:function(){throw"Not overridden"}});b.SparqlServiceFactoryConst=Class.create({initialize:function(c){this.sparqlService=c},createSparqlService:function(){var c=this.sparqlService;if(c==null){console.log("[ERROR] Creation of a SPARQL service requested, but none was provided");throw"Bailing out"}return c},setSparqlService:function(c){this.sparqlService=c}});b.SparqlServiceFactoryDefault=Class.create({initialize:function(){this.hashToCache={}},createSparqlService:function(f,d){var e=new b.SparqlServiceHttp(f,d);e=new b.SparqlServiceCache(e);var g=e.getStateHash();var h=this.hashToCache[g];var c;if(h){c=h}else{this.hashToCache[g]=e;c=e}return c}})})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.service;c.createNgGridOptionsFromQuery=function(g){if(!g){return[]}var h=g.getProjectVars();var f=d.VarUtils.getVarNames(h);var e=_(f).map(function(k){var j={field:k,displayName:k};return j});return e};c.bindingToJson=function(f,g){var e={};_(f).each(function(h){var j=h.getName();e[j]=""+g.get(h)});return e};c.SparqlTableService=Class.create({initialize:function(f,h,e,g){this.sparqlService=f;this.query=h;this.timeoutInMillis=e||3000;this.secondaryCountLimit=g||1000},fetchCount:function(){if(!this.query){var f=jQuery.Deferred();f.resolve(0);return f.promise()}var g=this.query.clone();g.setLimit(null);g.setOffset(null);var e=c.ServiceUtils.fetchCountQuery(this.sparqlService,this.query,this.timeoutInMillis,this.secondaryCountLimit);return e},fetchData:function(h,j){if(!this.query){var m=jQuery.Deferred();var e=new b.IteratorArray([]);var l=[];var g=new c.ResultSetArrayIteratorBinding(e,l);m.resolve(g);return m.promise()}var k=this.query.clone();k.setLimit(h);k.setOffset(j);var f=this.sparqlService.createQueryExecution(k);var n=f.execSelect().pipe(function(p){var q=[];var u=k.getProjectVars();while(p.hasNext()){var s=p.next();var r=c.bindingToJson(u,s);q.push(r)}return q});return n},getSchema:function(){var f=this.query;var e=c.createNgGridOptionsFromQuery(f);return e}})})();(function(){var ns=Jassa.sparql;ns.evaluators={"&&":function(){}};ns.ExprEvaluator=Class.create({eval:function(expr,binding){throw"Not overridden"}});ns.ExprEvaluatorImpl=Class.create(ns.ExprEvaluator,{eval:function(expr,binding){var result;if(expr.isVar()){var e=expr.getExprVar();result=this.evalExprVar(e,binding)}else{if(expr.isFunction()){var e=expr.getFunction();result=this.evalExprFunction(e,binding)}else{if(expr.isConstant()){var e=expr.getConstant();result=this.evalConstant(e,binding)}else{throw"Unsupported expr type"}}}return result},evalExprVar:function(expr,binding){var v=expr.asVar();var node=binding.get(v);var result;if(node==null){return ns.NodeValue.nvNothing}else{result=ns.NodeValue.makeNode(node)}return result},evalExprFunction:function(expr,binding){},evalNodeValue:function(expr,binding){}})})();(function(d){var b=Jassa.service;var c=Jassa.client;c.ConceptPathFinderApi=Class.create({initialize:function(j,g,e,f,h){this.apiUrl=j;this.sparqlServiceIri=g;this.defaultGraphIris=e;this.joinSummaryServiceIri=f;this.joinSummaryGraphIris=h},createAjaxConfig:function(g,f){var e={"service-uri":this.sparqlServiceIri,"default-graph-uri":this.defaultGraphIris,"source-element":g.getElement().toString(),"source-var":g.getVar().getName(),"target-element":f.getElement().toString(),"target-var":f.getVar().getName(),"js-service-uri":this.joinSummaryServiceIri,"js-graph-uri":this.joinSummaryGraphIris};return e},createSparqlService:function(g,f){var h=this.createAjaxConfig(g,f);var e=new b.SparqlServiceHttp(this.apiUrl,[],null,h);return e},findPaths:function(g,f){var j=this.createAjaxConfig(g,f);var h={url:this.apiUrl,dataType:"json",crossDomain:true,traditional:true,data:j};var e=d.ajax(h).pipe(function(o){var k=[];for(var l=0;l<o.length;++l){var m=o[l];var n=facete.Path.parse(m);k.push(n)}return k});return e},findPathsOldApi:function(g,f){var j={service:{serviceIri:this.sparqlServiceIri,defaultGraphIris:this.defaultGraphIris},sourceConcept:{elementStr:g.getElement().toString(),varName:g.getVar().value},targetConcept:{elementStr:f.getElement().toString(),varName:f.getVar().value}};var h={url:this.apiUrl,dataType:"json",data:{query:JSON.stringify(j)}};var e=d.ajax(h).pipe(function(o){var k=[];for(var l=0;l<o.length;++l){var m=o[l];var n=facete.Path.parse(m);k.push(n)}return k});return e}})})(jQuery);(function(){var b=Jassa.sponate;b.MapList=Class.create({initialize:function(){this.items=[];this.keyToIndex={}},put:function(d,e){if(d==null){console.log("key must not be null");throw"Bailing out"}var c=this.keyToIndex[d];if(c){console.log("Index already existed");throw"Bailing out"}c=this.items.length;this.items.push(e);this.keyToIndex[d]=c},get:function(e){var d=this.keyToIndex[e];var c=(d==null)?null:this.items[d];return c},getByIndex:function(c){return this.items[c]},getItems:function(){return this.items},getKeyToIndex:function(){return this.keyToIndex}})})();(function(){var rdf=Jassa.rdf;var sparql=Jassa.sparql;var util=Jassa.util;var ns=Jassa.sponate;ns.AccumulatorFactoryFn=Class.create({classLabel:"AccumulatorFactoryFn",initialize:function(fn,referencedVars){this.fn=fn;this.referencedVars=referencedVars},createAggregator:function(){var result=new ns.AccumulatorFn(this.fn,this.referencedVars);return result},getVarsMentioned:function(){return this.referencedVars}});ns.AccumulatorFn=Class.create({classLabel:"AccumulatorFn",initialize:function(fn){this.fn=fn;this.node=null},processBinding:function(binding){var val=this.fn(binding);this.node=val},getJson:function(retainRdfNodes){return this.node},toNode:function(){return this.node}});ns.AttrPath=Class.create({classLabel:"AttrPath",initialize:function(steps){this.steps=steps?steps:[]},getSteps:function(){return this.steps},toString:function(){return this.steps.join(".")},slice:function(start,end){var result=this.steps.slice(start,end);return result},first:function(){return this.steps[0]},at:function(index){return this.steps[index]},isEmpty:function(){return this.steps.length==0},size:function(){return this.steps.length},concat:function(that){var tmp=this.steps.concat(that.getSteps());var result=new ns.AttrPath(tmp);return result},find:function(doc){var result=doc;var steps=this.steps;for(var i=0;i<steps.length;++i){var attr=steps[i];if(!_(result).isObject()){console.log("[ERROR] Cannot access attribute of non-object",this.steps,doc,result);throw"Bailing out"}result=result[attr]}return result}});ns.AttrPath.parse=function(str){var steps=str.split(".");return new ns.AttrPath(steps)};ns.callVisitor=function(name,self,args){var visitor=args[0];var fn=visitor[name];if(!fn){console.log("[ERROR] No visitor with name "+name+" in ",self);throw"Bailing out"}var tmp=Array.prototype.slice.call(args,1);var xargs=[self].concat(tmp);var result=fn.apply(visitor,xargs);return result};ns.Pattern=Class.create({classLabel:"Pattern",callVisitor:function(name,self,args){var result=ns.callVisitor(name,self,args);return result},getClassName:function(){throw"override me"},toString:function(){return"override me"},getVarsMentioned:function(){throw"override me"},getSubPatterns:function(){throw"override me"},$getReferences:function(result){throw"override me"},findPattern:function(rawAttrPath,start){var attrPath;if(_(attrPath).isString()){attrPath=ns.AttrPath.parse(rawAttrPath)}else{attrPath=rawAttrPath}start=start?start:0;var result;var pathLength=attrPath.size();if(start>pathLength){console.log("[ERROR] Start in path "+start+" greater than path length "+pathLength)}else{if(start==pathLength){result=this}else{result=this.$findPattern(attrPath,start)}}return result},$findPattern:function(attrPath,start){console.log('[ERROR] "findPattern" for path "'+attrPath+'" is not supported on this kind of object: '+JSON.stringify(this));throw"Bailing out"}});ns.PatternUtils={getRefs:function(pattern){var result=[];var fn=function(pattern){var proceed=true;if(pattern instanceof ns.PatternRef){result.push(pattern);proceed=false}return proceed};util.TreeUtils.visitDepthFirst(pattern,ns.PatternUtils.getChildren,fn);return result},getChildren:function(pattern){return pattern.getSubPatterns()}};ns.PatternCustomAgg=Class.create(ns.Pattern,{classLabel:"PatternCustomAgg",initialize:function(customAggFactory){this.customAggFactory=customAggFactory},getCustomAggFactory:function(){return this.customAggFactory},getClassName:function(){return"PatternCustomAgg"},getVarsMentioned:function(){var result=this.customAggFactory.getVarsMentioned();return result},getSubPatterns:function(){return[]}});ns.PatternLiteral=Class.create(ns.Pattern,{classLabel:"PatternLiteral",initialize:function(expr,aggregatorName){this.expr=expr;this.aggregatorName=aggregatorName},getClassName:function(){return"PatternLiteral"},getExpr:function(){return this.expr},toString:function(){return""+this.expr},getVarsMentioned:function(){var result=this.expr.getVarsMentioned();return result},getSubPatterns:function(){return[]}});ns.PatternObject=Class.create(ns.Pattern,{classLabel:"PatternObject",initialize:function(attrToPattern){this.attrToPattern=attrToPattern},getClassName:function(){return"PatternObject"},getMembers:function(){return this.attrToPattern},getPattern:function(attr){return this.attrToPattern[attr]},toString:function(){var parts=[];_(this.attrToPattern).each(function(v,k){parts.push('"'+k+'": '+v)});var result="{"+parts.join(",")+"}";return result},getVarsMentioned:function(){var result=[];var fnToString=(function(x){return x.toString()});_(this.attrToPattern).each(function(member,k){var vs=member.getVarsMentioned();if(!vs){console.log("[ERROR] Could not retrieve vars for member of pattern",this,member)}else{result=result.concat(vs)}});result=_.uniq(result,false,fnToString);return result},$findPattern:function(attrPath,start){var attr=attrPath.at(start);var pattern=this.attrToPattern[attr];var result;if(pattern){result=pattern.findPattern(attrPath,start+1)}else{result=null}return result},getSubPatterns:function(){var result=[];_.each(this.attrToPattern,function(member,k){result.push(member)});return result}});ns.PatternMap=Class.create(ns.Pattern,{classLabel:"PatternMap",initialize:function(keyExpr,subPattern,isArray){this.keyExpr=keyExpr;this.subPattern=subPattern;this._isArray=isArray},getClassName:function(){return"PatternMap"},getKeyExpr:function(){return this.keyExpr},getSubPattern:function(){return this.subPattern},isArray:function(){return this._isArray},toString:function(){var result="["+this.subPattern+" / "+this.keyExpr+"/"+this.type+"]";return result},getVarsMentioned:function(){var result=this.subPattern.getVarsMentioned();return result},getSubPatterns:function(){return[this.subPattern]},$findPattern:function(attrPath,start){var result=this.subPattern.findPattern(attrPath,start);return result}});ns.PatternRef=Class.create(ns.Pattern,{classLabel:"PatternRef",initialize:function(stub){this.stub=stub;this.refSpec=null},getClassName:function(){return"PatternRef"},getStub:function(){return this.stub},setRefSpec:function(refSpec){this.refSpec=refSpec},getRefSpec:function(){return this.refSpec},toString:function(){return JSON.stringify(this)},getVarsMentioned:function(){var result=[];var stub=this.stub;if(stub.joinColumn!=null){var v=rdf.Node.v(stub.joinColumn.substr(1));result.push(v)}else{console.log("[ERROR] No join column declared; cannot get variable");throw"Bailing out"}return result},getSubPatterns:function(){return[]}});ns.JoinTableRef=Class.create({initialize:function(tableName,sourceColumns,targetColumns){this.tableName=tableName;this.sourceColumns=sourceColumns;this.targetColumns=targetColumns},getTableName:function(){return this.tableName},getSourceColumns:function(){return this.sourceColumns},getTargetColumns:function(){return this.targetColumn},toString:function(){var result="("+this.sourceColumns.join(", ")+") "+this.tableName+" ("+this.targetJoinColumns.join()+")";return result}});ns.TableRef=Class.create({initialize:function(tableName,columnNames){this.tableName=tableName;this.columnNames=columnNames},getTableName:function(){return this.tableName},getColumnNames:function(){return this.columnNames},toString:function(){var result=this.tableName+"("+this.columnNames.join(", ")+")";return result}});ns.MapRef=Class.create({initialize:function(mapName,tableRef,attrPath){this.mapName=mapName;this.tableRef=tableRef},getMapName:function(){return this.mapName},getTableRef:function(){return this.tableRef},getAttrPath:function(){return this.attrPath},toString:function(){var result=this.patternRef+"/"+tableRef+"@"+attrPath;return result}});ns.RefSpec=Class.create({initialize:function(sourceMapRef,targetMapRef,isArray,joinTableRef){this.sourceMapRef=sourceMapRef;this.targetMapRef=targetMapRef;this.isArray=isArray;this.joinTableRef=joinTableRef},getSourceMapRef:function(){return this.sourceMapRef},getTargetMapRef:function(){return this.targetMapRef},isArray:function(){this.isArray},getJoinTableRef:function(){return this.joinTabelRef},toString:function(){var result=this.sourceMapRef+" references "+this.targetMapRef+" via "+this.joinTableRef+" as array? "+this.isArray;return result}});ns.Aggregator=Class.create({classLabel:"Aggregator",getPattern:function(){throw new "override me"},getJson:function(retainRdfNodes){throw"override me"}});ns.AggregatorCustomAgg=Class.create(ns.Aggregator,{classLabel:"AggregatorCustomAgg",initialize:function(patternCustomAgg,customAgg){this.customAgg=customAgg},getPattern:function(){return this.pattenCustomAgg},process:function(binding,context){this.customAgg.processBinding(binding)},getJson:function(retainRdfNodes){var result=this.customAgg.getJson(retainRdfNodes);return result}});ns.AggregatorLiteral=Class.create(ns.Aggregator,{classLabel:"AggregatorLiteral",initialize:function(patternLiteral){this.patternLiteral=patternLiteral;this.node=null},getPattern:function(){return this.patternLiteral},process:function(binding,context){var expr=this.patternLiteral.getExpr();var exprEvaluator=context.exprEvaluator;var ex=exprEvaluator.eval(expr,binding);if(ex.isConstant()){var c=ex.getConstant();var node=c.asNode();this.setNode(node)}else{console.log("[ERROR] Could not evaluate to constant");throw"Bailing out"}},setNode:function(newNode){var oldNode=this.node;if(oldNode==null){this.node=newNode}else{if(!oldNode.equals(newNode)){console.log("[ERROR] Value already set: Attempted to override "+oldNode+" with "+newNode)}}},getJson:function(retainRdfNodes){var result;var node=this.node;if(node){if(retainRdfNodes){result=node}else{if(node.isUri()){result=node.toString()}else{if(node.isLiteral()){result=node.getLiteralValue();if(result instanceof rdf.TypedValue){result=result.getLexicalValue()}}else{if(sparql.NodeValue.nvNothing.asNode().equals(node)){result=null}else{console.log("[ERROR] Unsupported node types: ",node);throw"Unsupported node type"}}}}}return result}});ns.AggregatorObject=Class.create(ns.Aggregator,{classLabel:"AggregatorObject",initialize:function(patternObject,attrToAggr){this.pattersObject=this.patternObject;this.attrToAggr=attrToAggr},process:function(binding,context){_(this.attrToAggr).each(function(aggr,attr){aggr.process(binding,context)})},getJson:function(retainRdfNodes){var result={};_(this.attrToAggr).each(function(aggr,attr){var json=aggr.getJson(retainRdfNodes);result[attr]=json});return result}});ns.AggregatorMap=Class.create(ns.Aggregator,{classLabel:"AggregatorMap",initialize:function(patternMap){this.patternMap=patternMap;this.keyToAggr=new ns.MapList()},getPattern:function(){return this.patternMap},process:function(binding,context){var pattern=this.patternMap;var keyExpr=pattern.getKeyExpr();var subPattern=pattern.getSubPattern();var isArray=pattern.isArray();var exprEvaluator=context.exprEvaluator;var aggregatorFactory=context.aggregatorFactory;var keyEx=exprEvaluator.eval(keyExpr,binding);if(!keyEx.isConstant()){console.log("[ERROR] Could not evaluate key to a constant "+JSON.stringify(keyEx)+" with binding "+binding);throw"Bailing out"}var key=keyEx.getConstant().asNode();var keyStr=""+key;var aggr=this.keyToAggr.get(keyStr);if(aggr==null){aggr=aggregatorFactory.create(subPattern);this.keyToAggr.put(keyStr,aggr)}aggr.process(binding,context)},getJson:function(retainRdfNodes){var result;var isArray=this.patternMap.isArray();if(isArray){result=this.getJsonArray(retainRdfNodes)}else{result=this.getJsonMap(retainRdfNodes)}return result},getJsonArray:function(retainRdfNodes){var result=[];var aggrs=this.keyToAggr.getItems();var result=aggrs.map(function(aggr){var data=aggr.getJson(retainRdfNodes);return data});return result},getJsonMap:function(retainRdfNodes){var result={};var aggrs=this.keyToAggr.getItems();var keyToIndex=this.keyToAggr.getKeyToIndex();_(keyToIndex).each(function(index,aggr){var aggr=items[index];var data=aggr.getJson(retainRdfNodes);result[key]=data});return result}});ns.AggregatorRefCounter=0;ns.AggregatorRef=Class.create(ns.Aggregator,{classLabel:"AggregatorRef",initialize:function(patternRef){this.name=""+(ns.AggregatorRefCounter++);this.patternRef=patternRef;this.json=null;this.bindings=[]},getName:function(){return this.name},process:function(binding,context){this.bindings.push(binding)},getJson:function(retainRdfNodes){return this.json},setJson:function(json){this.json=json}});ns.AggregatorFactory=Class.create({classLabel:"AggregatorFactory",initialize:function(){},create:function(pattern){var fnName="visit"+pattern.getClassName();var fn=this[fnName];if(!fn){console.log('[ERROR] Function with name "'+fnName+'" not found.');throw"Bailing out"}var result=fn.call(this,pattern);return result},visitPatternObject:function(patternObject){var attrToAggr={};var self=this;var members=patternObject.getMembers();_(members).each(function(attrPattern,attr){var aggr=self.create(attrPattern);attrToAggr[attr]=aggr});var result=new ns.AggregatorObject(patternObject,attrToAggr);return result},visitPatternArray:function(pattern){return ns.AggregatorArray(pattern)},visitPatternMap:function(patternMap){return new ns.AggregatorMap(patternMap)},visitPatternLiteral:function(patternLiteral){return new ns.AggregatorLiteral(patternLiteral)},visitPatternRef:function(patternRef){return new ns.AggregatorRef(patternRef)},visitPatternCustomAgg:function(patternCustomAgg){var customAgg=patternCustomAgg.getCustomAggFactory().createAggregator();return new ns.AggregatorCustomAgg(patternCustomAgg,customAgg)}});ns.RegistryRef=Class.create({initialize:function(){},addRef:function(aggergatorRef,binding){}});ns.AggregatorFacade=Class.create({initialize:function(pattern){this.context={exprEvaluator:new sparql.ExprEvaluatorImpl(),aggregatorFactory:new ns.AggregatorFactory(),refRegistry:new ns.RegistryRef()};this.rootAggregator=this.context.aggregatorFactory.create(pattern)},process:function(binding){this.rootAggregator.process(binding,this.context)},getJson:function(retainRdfNodes){var result=this.rootAggregator.getJson(retainRdfNodes);return result}});ns.ParserPattern=Class.create({initialize:function(){this.attrs={id:"id",ref:"ref"}},parseArray:function(val){if(val.length!=1){console.log("[ERROR] Arrays must have exactly one element that is either a string or an object",val);throw"Bailing out"}var config=val[0];var result;if(_(config).isString()){result=this.parseArrayLiteral(config)}else{if(_(config).isObject()){result=this.parseArrayConfig(config)}else{throw"Bailing out"}}return result},parseArrayConfig:function(config){var idAttr=this.attrs.id;var refAttr=this.attrs.ref;var hasId=config[idAttr]!=null;var hasRef=config[refAttr]!=null;if(hasId&&hasRef){console.log("[ERROR] id and ref are mutually exclusive");throw"Bailing out"}var result;if(hasId){var subPattern=this.parseObject(config);var idPattern=subPattern.getPattern(idAttr);var idExpr=idPattern.getExpr();result=new ns.PatternMap(idExpr,subPattern,true)}else{if(hasRef){result=this.parseArrayRef(config)}else{console.log("[ERROR] Not implemented");throw"Bailing out"}}return result},parseArrayRef:function(config){var result=new ns.PatternRef(config);return result},parseArrayLiteral:function(){},parseLiteral:function(val){var expr=this.parseExprString(val);var result=new ns.PatternLiteral(expr);return result},parseObject:function(val){var attrToPattern={};var self=this;_(val).each(function(v,attr){var v=val[attr];var subPattern=self.parsePattern(v);attrToPattern[attr]=subPattern});var result=new ns.PatternObject(attrToPattern);return result},parsePattern:function(val){var result;if(_(val).isString()){result=this.parseLiteral(val)}else{if(_(val).isArray()){result=this.parseArray(val)}else{if(_(val).isFunction()){result=new ns.PatternCustomAgg(new ns.AccumulatorFactoryFn(val))}else{if(val instanceof rdf.Node&&val.isVariable()){var expr=new sparql.ExprVar(val);result=new ns.PatternLiteral(expr)}else{if(val instanceof sparql.Expr){result=new ns.PatternLiteral(expr)}else{if(_(val).isObject()){var fnCustomAggFactory=val.createAggregator;if(fnCustomAggFactory){result=new ns.PatternCustomAgg(val)}else{result=this.parseObject(val)}}else{console.log("[ERROR] Unknown item type: ",val);throw"Unkown item type"}}}}}}return result},parseExpr:function(obj){var result;if(_.isString(obj)){result=this.parseExprString(obj)}return result},parseExprString:function(str){var result;if(_(str).startsWith("?")){var varName=str.substr(1);var v=sparql.Node.v(varName);result=new sparql.ExprVar(v)}else{result=sparql.NodeValue.makeString(str)}return result}});ns.parseExpr=function(str){}})();(function(){var c=Jassa.util;var d=Jassa.rdf;var f=Jassa.sparql;var b=Jassa.service;var g=Jassa.facete;var e=Jassa.sponate;e.QueryConfig=Class.create({initialize:function(m,h,l,k,j){this.criteria=m;this.limit=h;this.offset=l;this.concept=k;this._isLeftJoin=j},getCriteria:function(){return this.criteria},getLimit:function(){return this.limit},getOffset:function(){return this.offset},getConcept:function(){return this.concept},isLeftJoin:function(){return this._isLeftJoin}});e.Cursor=Class.create({hasNext:function(){},next:function(){},forEach:function(j){while(this.hasNext()){var h=this.next();j(h)}}});e.CursorFlow=Class.create({hasNext:function(){},skip:function(h){},limit:function(h){},sort:function(h){}});e.QueryFlow=Class.create({initialize:function(h,j){this.store=h;this.config={};this.config.criteria=j},concept:function(h,j){var k=this.config.join={};k.concept=h;k.isLeftJoin=j;return this},nodes:function(h){},skip:function(h){this.config.offset=h;return this},limit:function(h){this.config.limit=h;return this},asList:function(j){var k=this.execute(j);var h=k.pipe(function(m){var l=[];while(m.hasNext()){l.push(m.next())}return l});return h},hasNext:function(){},next:function(){},execute:function(k){var n=this.config;var m=this.config.join||{};var l=new e.QueryConfig(n.criteria,n.limit,n.offset,m.concept,m.isLeftJoin);var h=this.store.execute(l,k);return h},count:function(){var m=this.config;var l=this.config.join||{};var k=new e.QueryConfig(m.criteria,m.limit,m.offset,l.concept,l.isLeftJoin);var h=this.store.executeCount(k);return h}});e.Store=Class.create({initialize:function(h,j,k,l){this.sparqlService=h;this.context=j;this.mappingName=k;this.cacheFactory=l},find:function(j){var k=this.context.getCriteriaParser();var l=k.parse(j);var h=new e.QueryFlow(this,l);return h},getByIds:function(h){},getByConcept:function(j,h){},createQueries:function(Q){var n=this.context;var s=Q.getCriteria();var N=Q.getLimit();var r=Q.getOffset();var O=Q.getConcept();var B=Q.isLeftJoin();var v=this.context.getMapping(this.mappingName);e.ContextUtils.resolveMappingRefs(this.context,v);console.log("Refs: ",v.getPatternRefs());var m=new e.CriteriaCompilerSparql();var K=m.compile(n,v,s);console.log("Compiled criteria: "+K,K);var o=v.getElementFactory();var l=o.createElement();if(K){}var I=v.getPattern();var E=I.getVarsMentioned();var P;if(I instanceof e.PatternMap){P=I.getKeyExpr()}var u=[];if(P!=null){var h=new f.SortCondition(P,1);u.push(h)}var M;if(!(P instanceof f.ExprVar)){console.log("[ERROR] Currently the idExpr must be a variable. This restriction may be lifted in the future");throw"Bailing out"}M=P.asVar();var p=N!=null||r!=null||(O!=null&&!O.isSubjectConcept())||K.length>0;var L=l;if(p){if(O&&(B||!O.isSubjectConcept())){var G=O.getElement();var H=O.getVar();var D=G;var A=L;var k=D.getVarsMentioned();var j=A.getVarsMentioned();var S=[H];var R=[M];var z=f.ElementUtils.createJoinVarMap(j,k,R,S);var D=f.ElementUtils.createRenamedElement(D,z);O=new g.Concept(D,M);var C=g.ConceptUtils.createQueryList(O);D=new f.ElementSubQuery(C);if(B){A=new f.ElementOptional(A)}L=new f.ElementGroup([D,A])}var J=new f.Query();var y=J.getElements();y.push(L);if(K.length>0){y.push(new f.ElementFilter(K))}var w=new f.ElementSubQuery(J);var F=l;if(B){F=new f.ElementOptional(l)}J.setLimit(N);J.setOffset(r);J.setDistinct(true);J.getProject().add(M);l=new f.ElementGroup([w,F]);L=w}var x={requireSubQuery:p,innerElement:L,outerElement:l,idVar:M,vars:E,sortConditions:u,pattern:I,criteria:s};console.log("innerElement: "+L);console.log("outerElement: "+l);return x},execute:function(l,k){var j=this.createQueries(l);var h=this.executeData(j,k);return h},executeCount:function(h){var o=this.createQueries(h);var l=o.innerElement;var n=o.idVar;var k=new g.Concept(l,n);var q=d.NodeFactory.createVar("_c_");var m=g.ConceptUtils.createQueryCount(k,q);var j=this.sparqlService.createQueryExecution(m);var p=b.ServiceUtils.fetchInt(j,q);return p},executeData:function(v,s){var l=v.outerElement;var r=v.idExpr;var k=v.sortConditions;var m=v.vars;var n=v.pattern;var u=v.criteria;var q=new f.Query();q.getElements().push(l);_(m).each(function(x){q.getProject().add(x)});if(r!=null){var p=new f.SortCondition(r,1);var j=q.getOrderBy();j.push.apply(j,k)}var o=function(y){var x=new e.AggregatorFacade(n);while(y.hasNext()){var A=y.nextBinding();x.process(A)}var D=x.getJson(s);var F;if(_(D).isArray()){var z;if(s){z=D}else{var z=_(D).filter(function(H){var G=u.match(H);return G});var B=D.length;var E=z.length;var C=B-E;console.log("[DEBUG] "+C+" items filtered on the client ("+E+"/"+B+" remaining) using criteria "+JSON.stringify(u))}F=new c.IteratorArray(z)}else{console.log("[ERROR] Implement me");throw"Implement me"}return F};var h=this.sparqlService.createQueryExecution(q);var w=h.execSelect().pipe(o);return w}});e.QueryPlan=Class.create({initialize:function(){}})})();(function(){var c=Jassa.sparql;var b=Jassa.sponate;b.Table=Class.create({initialize:function(d,f,e){this.name=d;this.columnNames=f;this.schema=e},getName:function(){return this.name},getColumnNames:function(){return this.columnNames},getSchema:function(){return schema},toString:function(){return this.name+"("+this.columnNames.join(", ")+")"}});b.SparqlParserFake=Class.create({initialize:function(){this.prefixes={}},parseElement:function(f){var e=c.extractSparqlVars(f);var d=b.ElementString.create(f,e)}});b.Schema=Class.create({initialize:function(){this.nameToTable={}},addTable:function(e){var d=e.getName();this.nameToTable[d]=e},getTable:function(e){var d=this.nameToTable[e];return d}});b.Context=Class.create({initialize:function(d){this.schema=d?d:new b.Schema();this.prefixMapping=new c.PrefixMappingImpl();this.tableNameToElementFactory={};this.nameToMapping={};this.patternParser=new b.ParserPattern();this.criteriaParser=new b.CriteriaParser()},getSchema:function(){return this.schema},getPrefixMapping:function(){return this.prefixMapping},getPatternParser:function(){return this.patternParser},getTableNameToElementFactory:function(){return this.tableNameToElementFactory},getNameToMapping:function(){return this.nameToMapping},mapTableNameToElementFactory:function(e,d){this.tableNameToElementFactory[e]=d},addMapping:function(e,d){this.nameToMapping[e]=d},getMapping:function(e){var d=this.nameToMapping[e];return d},getElementFactory:function(e){var d=this.tableNameToElementFactory[e];return d},getCriteriaParser:function(){return this.criteriaParser}});b.ContextUtils={createTable:function(e,d,f){var g=e.getPrefixMapping().getNsPrefixMap();var j=c.extractSparqlVars(f);var k=c.expandPrefixes(g,f);var h=c.ElementString.create(k,j);var m=j.map(function(n){return n.toString()});var l=new b.Table(d,m);e.getSchema().addTable(l);e.mapTableNameToElement(d,h)},resolveMappingRefs:function(e,d){var f=d.getPatternRefs();_(f).each(function(g){var h=g.getStub();var j=b.ContextUtils.createRefSpec(d,h,e);g.setRefSpec(j)})},createRefSpec:function(e,f,g){var r=g.getSchema();var p=e.getName();var y=f.ref;var w=g.getMapping(y);if(w==null){console.log("[ERROR] Target mapping "+w+" not defined");throw"Bailing out"}var l=e.getTableName();var q=w.getTableName();var u=r.getTable(l);var n=r.getTable(q);var o=f.card==1?false:true;var s;var k;if(f.joinColumn){s=[f.joinColumn]}if(f.refJoinColumn){k=[f.refJoinColumn]}var v=f.joinTable;if(v!=null){console.log("[ERROR] Implement me");throw"Bailing out"}var x=new b.TableRef(l,s);var j=new b.TableRef(q,k);var d=new b.MapRef(p,x,null);var h=new b.MapRef(y,j,null);var m=new b.RefSpec(d,h,o,null);return m}}})();(function(){var d=Jassa.sparql;var b=Jassa.util;var c=Jassa.sponate;c.MapParser=Class.create({initialize:function(f,e){this.prefixMapping=f;this.patternParser=e||new c.ParserPattern()},parseMap:function(f){var e=c.SponateUtils.parseMap(f,this.prefixMapping,this.patternParser);return e}});c.SponateUtils={parseMap:function(s,j,q){var e=s.name;var m=s.template;var r=s.from;var f=this.context;var p;if(_(r).isString()){var g=r;if(j!=null){var l=j.getNsPrefixMap();var o=d.expandPrefixes(l,g)}var k=d.ElementString.create(o);p=new d.ElementFactoryConst(k)}else{if(r instanceof d.Element){p=new d.ElementFactoryConst(r)}else{if(r instanceof d.ElementFactory){p=r}else{console.log('[ERROR] Unknown argument type for "from" attribute',r);throw"Bailing out"}}}var n=q.parsePattern(m);var h=c.PatternUtils.getRefs(n);var u=new c.Mapping(e,n,p,h);return u},defaultPrefLangs:["en",""],prefLabelPropertyUris:["http://www.w3.org/2000/01/rdf-schema#label"],createDefaultLabelMap:function(g,j,n,e,f){g=g||c.SponateUtils.defaultPrefLangs;j=j||c.SponateUtils.prefLabelPropertyUris;n=n||"s";e=e||"p";f=f||"o";var k=new c.MapParser();var h=new c.LabelUtilFactory(j,g);var l=h.createLabelUtil(f,n,e);var m=k.parseMap({name:"labels",template:[{id:"?"+n,displayLabel:l.getAggFactory(),hiddenLabels:[{id:"?"+f}]}],from:l.getElement()});return m}};c.JoinElement=Class.create({initialize:function(e,f){this.element=e}});c.JoinUtils={join:function(j,g,h){var f=eleA.getVarsMentioned();var e=eleB.getVarsMentioned()},createMappingJoin:function(f,m){var l=new d.GenSym("a");var g=l.next();var h={};var p={};h[g]={mapping:m,aggs:[]};var j=[a];while(j.isEmpty()){var k=j.shift();var e=h[k];var o=e.mapping;c.ContextUtils.resolveMappingRefs(this.context,o);var n=mapping.getPatternRefs();_(n).each(function(s){var w=s.getTargetMapRef();var r=l.next();h[r]={mapping:targetMapping};var v=p[k];if(v==null){v=[];p[k]=v}var u={targetAlias:r,isTransient:true};v.push(u)});var q={aliasToState:h,aliasToJoins:p};return q}}};c.GraphItem=Class.create({initialize:function(e,f){this.graph=e;this.id=f},getGraph:function(){return this.graph},getId:function(){return this.id}});c.Node=Class.create(c.GraphItem,{initialize:function($super,e,f){$super(e,f)},getOutgoingEdges:function(){var e=this.graph.getEdges(this.id);return e}});c.Edge=Class.create({initialize:function(f,h,e,g){this.graph=f;this.id=h;this.nodeIdFrom=e;this.nodeIdTo=g},getNodeFrom:function(){var e=this.graph.getNode(this.nodeIdFrom);return e},getNodeTo:function(){var e=this.graph.getNode(this.nodeIdTo);return e}});c.Graph=Class.create({initialize:function(f,e){this.fnCreateNode=f;this.fnCretaeEdge=e;this.idToNode={};this.nodeIdToEdgeIdToEdge={};this.idToEdge={};this.nextNodeId=1;this.nextEdgeId=1},createNode:function(){var h=""+(++this.nextNodeId);var f=Array.prototype.slice.call(arguments,0);var g=[this,h].concat(f);var e=this.fnCreateNode.apply(this,g);this.idToNode[h]=e;return e},createEdge:function(g,j){var k=""+(++this.nextEdgeId);var f=Array.prototype.slice.call(arguments,0);var h=[graph,g,j].concat(f);var e=this.fnEdgeNode.apply(this,h);var l=this.nodeIdToEdgeIdToEdge[edges];if(l==null){l={};this.nodeIdToEdgeIdToEdge=l}l[k]=e;this.idToEdge[k]=e;return e}});c.NodeJoinElement=Class.create(c.Node,{initialize:function($super,g,h,f,e){$super(g,h);http:this.element=f;this.alias=e},getElement:function(){return this.element},getAlias:function(){return this.alias}});c.fnCreateMappingJoinNode=function(e,f){console.log("Node arguments:",arguments);return new c.MappingJoinNode(e,f)};c.fnCreateMappingEdge=function(e,f){return new c.MappingJoinEdge(e,f)};c.JoinGraphElement=Class.create(c.Graph,{initialize:function($super){$super(c.fnCreateMappingJoinNode,c.fnCreateMappingEdge)}});c.RowMapperAlias=Class.create({initialize:function(e){this.aliasToVarMap=e},map:function(g){var f=g.getVars();var e={};_(this.aliasToVarMap).each(function(l,j){var h=new d.Binding();e[j]=h;var m=l.getInverse();var k=m.keyList();_(k).each(function(p){var o=m.get(p);var n=g.get(p);h.put(o,n)})});return e}});c.MappingJoinEdge=Class.create(c.Edge,{initialize:function($super,e,f){$super(e,e,f)}})})();(function(){var c=Jassa.sparql;var b=Jassa.sponate;b.Mapping=Class.create({classLabel:"jassa.sponate.Mapping",initialize:function(e,g,d,f){this.name=e;this.pattern=g;this.elementFactory=d;this.patternRefs=f||[]},getName:function(){return this.name},getPattern:function(){return this.pattern},getElementFactory:function(){return this.elementFactory},getPatternRefs:function(){return this.patternRefs},toString:function(){var d="[pattern: "+this.pattern+", element: "+this.elementFactory.createElement()+"]";return d}});b.StoreFacade=Class.create({initialize:function(d,e){this.service=d;this.context=new b.Context();e=e||{};this.context.getPrefixMapping().setNsPrefixes(e)},addMap:function(f,e){var d=(f instanceof b.Mapping)?this.addMapObj(e,f):this.addMapSpec(f);return d},addMapObj:function(e,f){var d=f.getElementFactory();this.context.mapTableNameToElementFactory(e,d);this.context.addMapping(e,f);this.createStore(e);return this},addMapSpec:function(e){var g=b.SponateUtils.parseMap(e,this.context.getPrefixMapping(),this.context.getPatternParser());var f=e.name;var d=this.addMapObj(f,g);return d},createStore:function(d){if(d in this){console.log("[ERROR] An attribute / store with name "+d+" already exists");throw"Bailing out"}this[d]=new b.Store(this.service,this.context,d)},getSchema:function(){return schema}})})();(function(){var b=Jassa.sponate;b.CriteriaParser=Class.create({parse:function(d){var e=new b.AttrPath();var c=this.parseAny(d,e);return c},parseAny:function(d,e){var c;if(d==null){c=new b.CriteriaTrue()}else{if(_(d).isObject()){c=this.parseObject(d,e)}else{if(_(d).isArray()){throw"Not implemented"}else{c=this.parse_$eq(e,d)}}}return c},parseObject:function(g,h){var d=this;var e=g["$options"];var f=_(g).chain().omit("$options").map(function(n,j){var p;if(_(j).startsWith("$")){var o="parse_"+j;var k=d[o];if(!k){console.log("[ERROR] No criteria implementation for "+j);throw"Bailing out"}p=k.call(d,h,n,e)}else{var l=b.AttrPath.parse(j);var m=h.concat(l);if(!n){console.log("[ERROR] No value for attribute "+j);throw"Bailing out"}p=d.parseAny(n,m)}return p}).value();var c;if(f.length==1){c=f[0]}else{c=new b.CriteriaLogicalAnd(new b.AttrPath(),f)}return c},parse_$eq:function(d,c){return new b.CriteriaEq(d,c)},parse_$gt:function(d,c){return new b.CriteriaGt(d,c)},parse_$gte:function(d,c){return new b.CriteriaGte(d,c)},parse_$lt:function(d,c){return new b.CriteriaLt(d,c)},parse_$lte:function(d,c){return new b.CriteriaLte(d,c)},parse_$ne:function(d,c){return new b.CriteriaNe(d,c)},parse_$regex:function(g,f,d){var e;if(_(f).isString()){e=new RegExp(f,d)}else{if(f instanceof RegExp){e=f}else{console.log("[ERROR] Not a regex: "+f);throw"Bailing out"}}var c=new b.CriteriaRegex(g,e);return c},parse_$elemMatch:function(g,f){var h=this.parse(f);var e;if(h instanceof b.CriteriaLogicalAnd){e=h.getCriterias()}else{e=[h]}var d=new b.CriteriaElemMatch(g,e);return d},parse_$or:function(g,f){if(!_(f).isArray()){console.log("Argument of $or must be an array");throw"Bailing out"}var d=this;var e=f.map(function(j){var h=d.parse(j);return h});var c;if(e.length==1){c=e[0]}else{c=new b.CriteriaLogicalOr(g,e)}return c}});b.Criteria=Class.create({getOpName:function(){throw"Not overridden"},match:function(c){throw"Not overridden"},callVisitor:function(f,d,e){var c=b.callVisitor(f,d,e);return c},accept:function(c){console.log("Not overridden");throw"Not overridden"}});b.CriteriaBase=Class.create(b.Criteria,{initialize:function(c){this.opName=c},getOpName:function(){return this.opName},accept:function(d){var c=b.callVisitor("visitCriteria"+this.opName,this,arguments);return c}});b.CriteriaFalse=Class.create(b.CriteriaBase,{initialize:function($super){$super("$false")},match:function(c){return false}});b.CriteriaTrue=Class.create(b.CriteriaBase,{initialize:function($super){$super("$true")},match:function(c){return true}});b.CriteriaPath=Class.create(b.CriteriaBase,{initialize:function($super,c,d){$super(c);this.attrPath=d;if(!d){throw"npe"}},getAttrPath:function(){return this.attrPath},match:function(d){var e=this.attrPath.find(d);var c=this.$match(d,e);return c},$match:function(c,d){throw"Not overridden"}});b.CriteriaPathValue=Class.create(b.CriteriaPath,{initialize:function($super,c,e,d){$super(c,e);this.value=d},getValue:function(){return this.value},toString:function(){return"("+attrPath+" "+this.opName+" "+this.value+")"}});b.CriteriaEq=Class.create(b.CriteriaPathValue,{initialize:function($super,d,c){$super("$eq",d,c)},$match:function(d,e){var c=e==this.value;return c}});b.CriteriaGt=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$gt",d);this.value=c},$match:function(d,e){var c=e>this.value;return c}});b.CriteriaGte=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$gte",d);this.value=c},$match:function(d,e){var c=e>=this.value;return c}});b.CriteriaLt=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$lt",d);this.value=c},$match:function(d,e){var c=e<this.value;return c}});b.CriteriaLte=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$lte",d);this.value=c},$match:function(d,e){var c=e<=this.value;return c}});b.CriteriaNe=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$ne",d);this.value=c},$match:function(d,e){var c=e!=this.value;return c}});b.CriteriaRegex=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$regex",d);this.regex=c},getRegex:function(){return this.regex},$match:function(d,e){var c=this.regex.test(e);return c}});b.CriteriaPathCollection=Class.create(b.CriteriaPath,{initialize:function($super,c,e,d){$super(c,e);this.criterias=d},getCriterias:function(){return this.criterias},toString:function(){return"["+this.criterias.join(", ")+"]"}});b.CriteriaLogicalAnd=Class.create(b.CriteriaPathCollection,{initialize:function($super,d,c){$super("$and",d,c)},match:function(d){var c=_(this.criterias).every(function(f){var e=f.match(d);return e});return c}});b.CriteriaLogicalOr=Class.create(b.CriteriaPathCollection,{initialize:function($super,d,c){$super("$or",d,c)},$match:function(d,e){var c=_(this.criterias).some(function(g){var f=g.match(e);return f});return c}});b.CriteriaElemMatch=Class.create(b.CriteriaPathCollection,{initialize:function($super,d,c){$super("$elemMatch",d,c)},$match:function(d,e){if(!_(e).isArray()){console.log("[ERROR] Cannon apply $elemMatch to non-array",e);throw"Bailing out"}console.log("$elemMatch "+this.attrPath);var c=this.matchArray(e);return c},matchArray:function(e){var d=this;var c=_(e).some(function(g){var f=_(d.criterias).every(function(j){var h=j.match(g);return h});return f});return c},accept:function(d){var c=this.callVisitor("visitElemMatch",this,arguments);return c}})})();(function(){var c=Jassa.sparql;var b=Jassa.sponate;b.CriteriaCompilerSparql=Class.create({compile:function(h,f,l){var e=f.getElementFactory();var g=e.createElement();var k=c.JoinBuilderElement.create(g);var d=[];console.log("Compile request for criteria: "+l+"; "+JSON.stringify(l));var j=f.getPattern();this.visitCriteria(l,j,h,k,d);return d},visitCriteria:function(k,g,e,h,d){var j="visitCriteria"+k.getOpName();var f=this[j];if(!f){console.log("Member not found: "+j);throw"Bailing out"}var d=f.call(this,k,g,e,h,d);return d},visitCriteria$elemMatch:function(l,k,d,g,n){var h=k.findPattern(l.getAttrPath());var m=this;var e=l.getCriterias();var j=[];_(e).each(function(q){var p=[];m.visitCriteria(q,h,d,g,p);var o=c.andify(p);j.push(o)});var f=c.orify(j);n.push(f)},getExpr:function(d){if(d instanceof b.PatternLiteral){var e=d.getExpr();return e}else{console.log("[ERROR] pattern type not supported yet");throw"Bailing out"}},visitEq:function(m,h,g,l,d){var f=h.findPattern(attrPath);var k=this.getExpr(f);var j=new c.E_Equals(new c.E_Str(k),c.NodeValue.makeString(ap.getValue()));d.push(j)},visitCriteria$and:function(l,j,h,k,d){console.log("Pattern: "+j);var g=j.findPattern(l.getAttrPath());var e=this;var f=l.getCriterias();_(f).each(function(m){e.visitCriteria(m,g,h,k,d)})},visitCriteria$or:function(l,k,d,g,n){var h=k.findPattern(l.getAttrPath());var m=this;var e=l.getCriterias();var j=[];_(e).each(function(q){var p=[];m.visitCriteria(q,h,d,g,p);var o=c.andify(p);j.push(o)});var f=c.orify(j);n.push(f)},visitCriteria$regex:function(n,m,d,h,q){var j=m.findPattern(n.getAttrPath());var k=n.getRegex().toString();var p=k.lastIndexOf("/");var f=k.substring(1,p);var g=k.substring(p+1);var o=this.getExpr(j);var l=new c.E_Regex(new c.E_Str(o),f,g);q.push(l)},visitCriteria$true:function(h,f,e,g,d){},visitRef:function(g,d,e,f){},visitGt:function(){},})})();(function(){var rdf=Jassa.rdf;var sparql=Jassa.sparql;var ns=Jassa.sponate;var compareArray=function(as,bs,op){var zipped=_.zip(as,bs);var result=false;for(var i=0;i<zipped.length;++i){var item=zipped[i];var a=item[0];var b=item[1];if(op(a,b)){if(op(b,a)){continue}result=true;break}else{if(!op(b,a)){continue}result=false;break}}return result};var cmpLessThan=function(a,b){return a<b};ns.extractLabelFromUri=function(str){var a=str.lastIndexOf("#");var b=str.lastIndexOf("/");var i=Math.max(a,b);var result=(i===str.length)?str:str.substring(i+1);if(result===""){result=str}return result};ns.AggregatorFactoryLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.labelExpr=labelExpr;this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr},createAggregator:function(){var result=new ns.AggregatorLabel(this.labelPrios,this.prefLangs,this.labelExpr,this.subjectExpr,this.propertyExpr);return result},getVarsMentioned:function(){var vm=(function(expr){var result=expr?expr.getVarsMentioned():[];return result});var result=_.union(vm(this.labelExpr),vm(this.subjectExpr),vm(this.propertyExpr));return result}});ns.AggregatorLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr;this.labelExpr=labelExpr;this.exprEvaluator=new sparql.ExprEvaluatorImpl();this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.bestMatchNode=null;this.bestMatchScore=[1000,1000]},processBinding:function(binding){var property=this.exprEvaluator.eval(this.propertyExpr,binding);var label=this.exprEvaluator.eval(this.labelExpr,binding);var subject=this.exprEvaluator.eval(this.subjectExpr,binding);if(this.bestMatchNode==null&&subject.isConstant()){this.bestMatchNode=subject.getConstant().asNode()}var propertyScore=-1;var langScore;var l;if(property&&property.isConstant()){var p=property.getConstant().asNode();if(p.isUri()){var propertyUri=p.getUri();propertyScore=this.labelPrios.indexOf(propertyUri)}}if(label&&label.isConstant()){l=label.getConstant().asNode();var lang=l.isLiteral()?l.getLiteralLanguage():"nolang";langScore=this.prefLangs.indexOf(lang)}var score=[propertyScore,langScore];var allNonNegative=_(score).every(function(item){return item>=0});if(allNonNegative){var cmp=compareArray(score,this.bestMatchScore,cmpLessThan);if(cmp===true){this.bestMatchScore=score;this.bestMatchNode=l}}},getNode:function(){return this.bestMatchNode},getJson:function(){var result=null;var bestMatchNode=this.bestMatchNode;if(bestMatchNode){if(bestMatchNode.isUri()){var uri=bestMatchNode.getUri();result=ns.extractLabelFromUri(uri)}else{result=bestMatchNode.getLiteralValue()}}return result}});ns.LabelUtil=Class.create({initialize:function(aggFactory,element){this.aggFactory=aggFactory;this.element=element},getAggFactory:function(){return this.aggFactory},getElement:function(){return this.element}});ns.LabelUtilFactory=Class.create({initialize:function(prefLabelPropertyUris,prefLangs){this.prefLabelPropertyUris=prefLabelPropertyUris;this.prefLangs=prefLangs;this.prefLabelProperties=_(this.prefLabelPropertyUris).map(function(uri){return rdf.NodeFactory.createUri(uri)})},createLabelUtil:function(labelVarName,subjectVarName,propertyVarName){var s=rdf.NodeFactory.createVar(subjectVarName);var p=rdf.NodeFactory.createVar(propertyVarName);var o=rdf.NodeFactory.createVar(labelVarName);var subjectExpr=new sparql.ExprVar(s);var propertyExpr=new sparql.ExprVar(p);var labelExpr=new sparql.ExprVar(o);var aggFactoryLabel=new ns.AggregatorFactoryLabel(this.prefLabelPropertyUris,this.prefLangs,labelExpr,subjectExpr,propertyExpr);var langTmp=_(this.prefLangs).map(function(lang){var r=new sparql.E_LangMatches(new sparql.E_Lang(labelExpr),sparql.NodeValue.makeString(lang));return r});var langConstraint=sparql.orify(langTmp);var propFilter=new sparql.E_OneOf(propertyExpr,this.prefLabelProperties);var els=[];els.push(new sparql.ElementTriplesBlock([new rdf.Triple(s,p,o)]));els.push(new sparql.ElementFilter([propFilter]));els.push(new sparql.ElementFilter([langConstraint]));var langElement=new sparql.ElementGroup(els);var result=new ns.LabelUtil(aggFactoryLabel,langElement);return result}})})();(function(){var rdf=Jassa.rdf;var sparql=Jassa.sparql;var ns=Jassa.sponate;var compareArray=function(as,bs,op){var zipped=_.zip(as,bs);var result=false;for(var i=0;i<zipped.length;++i){var item=zipped[i];var a=item[0];var b=item[1];if(op(a,b)){if(op(b,a)){continue}result=true;break}else{if(!op(b,a)){continue}result=false;break}}return result};var cmpLessThan=function(a,b){return a<b};ns.extractLabelFromUri=function(str){var a=str.lastIndexOf("#");var b=str.lastIndexOf("/");var i=Math.max(a,b);var result=(i===str.length)?str:str.substring(i+1);if(result===""){result=str}return result};ns.AggregatorFactoryLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.labelExpr=labelExpr;this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr},createAggregator:function(){var result=new ns.AggregatorLabel(this.labelPrios,this.prefLangs,this.labelExpr,this.subjectExpr,this.propertyExpr);return result},getVarsMentioned:function(){var vm=(function(expr){var result=expr?expr.getVarsMentioned():[];return result});var result=_.union(vm(this.labelExpr),vm(this.subjectExpr),vm(this.propertyExpr));return result}});ns.AggregatorLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr;this.labelExpr=labelExpr;this.exprEvaluator=new sparql.ExprEvaluatorImpl();this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.bestMatchNode=null;this.bestMatchScore=[1000,1000]},processBinding:function(binding){var property=this.exprEvaluator.eval(this.propertyExpr,binding);var label=this.exprEvaluator.eval(this.labelExpr,binding);var subject=this.exprEvaluator.eval(this.subjectExpr,binding);if(this.bestMatchNode==null&&subject.isConstant()){this.bestMatchNode=subject.getConstant().asNode()}var propertyScore=-1;var langScore;var l;if(property&&property.isConstant()){var p=property.getConstant().asNode();if(p.isUri()){var propertyUri=p.getUri();propertyScore=this.labelPrios.indexOf(propertyUri)}}if(label&&label.isConstant()){l=label.getConstant().asNode();var lang=l.isLiteral()?l.getLiteralLanguage():"nolang";langScore=this.prefLangs.indexOf(lang)}var score=[propertyScore,langScore];var allNonNegative=_(score).every(function(item){return item>=0});if(allNonNegative){var cmp=compareArray(score,this.bestMatchScore,cmpLessThan);if(cmp===true){this.bestMatchScore=score;this.bestMatchNode=l}}},getNode:function(){return this.bestMatchNode},getJson:function(){var result=null;var bestMatchNode=this.bestMatchNode;if(bestMatchNode){if(bestMatchNode.isUri()){var uri=bestMatchNode.getUri();result=ns.extractLabelFromUri(uri)}else{result=bestMatchNode.getLiteralValue()}}return result}});ns.LabelUtil=Class.create({initialize:function(aggFactory,element){this.aggFactory=aggFactory;this.element=element},getAggFactory:function(){return this.aggFactory},getElement:function(){return this.element}});ns.LabelUtilFactory=Class.create({initialize:function(prefLabelPropertyUris,prefLangs){this.prefLabelPropertyUris=prefLabelPropertyUris;this.prefLangs=prefLangs;this.prefLabelProperties=_(this.prefLabelPropertyUris).map(function(uri){return rdf.NodeFactory.createUri(uri)})},createLabelUtil:function(labelVarName,subjectVarName,propertyVarName){var s=rdf.NodeFactory.createVar(subjectVarName);var p=rdf.NodeFactory.createVar(propertyVarName);var o=rdf.NodeFactory.createVar(labelVarName);var subjectExpr=new sparql.ExprVar(s);var propertyExpr=new sparql.ExprVar(p);var labelExpr=new sparql.ExprVar(o);var aggFactoryLabel=new ns.AggregatorFactoryLabel(this.prefLabelPropertyUris,this.prefLangs,labelExpr,subjectExpr,propertyExpr);var langTmp=_(this.prefLangs).map(function(lang){var r=new sparql.E_LangMatches(new sparql.E_Lang(labelExpr),sparql.NodeValue.makeString(lang));return r});var langConstraint=sparql.orify(langTmp);var propFilter=new sparql.E_OneOf(propertyExpr,this.prefLabelProperties);var els=[];els.push(new sparql.ElementTriplesBlock([new rdf.Triple(s,p,o)]));els.push(new sparql.ElementFilter([propFilter]));els.push(new sparql.ElementFilter([langConstraint]));var langElement=new sparql.ElementGroup(els);var result=new ns.LabelUtil(aggFactoryLabel,langElement);return result}})})();(function(){var b=Jassa.sponate;if(!b.angular){b.angular={}}var c=Jassa.sponate.angular;c.bridgePromise=function(f,e,d,g){f.done(function(j){var k=g?g(j):j;e.resolve(k);var h=function(){if(d&&!d.$$phase&&!d.$root.$$phase){d.$apply()}else{setTimeout(h,25)}};h()}).fail(function(h){e.reject(h)});return e.promise}})();(function(){var b=Jassa.sponate;b.GeoMapFactory=Class.create({classLabel:"GeoMapFactory",initialize:function(c,d){this.baseSponateView=c;this.bboxExprFactory=d},createMapForGlobal:function(){var c=this.createMapForBounds(null);return c},createMapForBounds:function(c){var g=this.baseSponateView;var e=this.bboxExprFactory;var j=g.getPattern();var k=g.getElementFactory();var l=k.createElement();var f=l;if(c){var d=e.createExpr(c);var h=new sparql.ElementFilter(d);f=new sparql.ElementGroup([l,h])}var m=new sponate.Mapping(null,j,new sparql.ElementFactoryConst(f));return m}})})();(function(){var c=Jassa.facete;var d=Jassa.sparql;var b=Jassa.rdf;c.Step=Class.create({initialize:function(e,f){this.type="property";this.propertyName=e;this._isInverse=f},toJson:function(){var e={isInverse:this.isInverse,propertyName:this.propertyName};return e},getPropertyName:function(){return this.propertyName},isInverse:function(){return this._isInverse},equals:function(e){return _.isEqual(this,e)},toString:function(){if(this._isInverse){return"<"+this.propertyName}else{return this.propertyName}},createElement:function(f,k,h){var g=d.Node.uri(this.propertyName);var j;if(this._isInverse){j=new b.Triple(k,g,f)}else{j=new b.Triple(f,g,k)}var e=new d.ElementTriplesBlock([j]);return e}});c.Step.classLabel="Step";c.Step.fromJson=function(g){var f=checkNotNull(g.propertyName);var h=g.IsInverse();var e=new c.Step(f,h);return e};c.Step.parse=function(f){var e;if(_(f).startsWith("<")){e=new c.Step(f.substring(1),true)}else{e=new c.Step(f,false)}return e},c.Path=Class.create({initialize:function(e){this.steps=e?e:[]},getLength:function(){return this.steps.length},isEmpty:function(){var e=this.steps.length===0;return e},toString:function(){var e=this.steps.join(" ");return e},concat:function(f){var e=new c.Path(this.steps.concat(f.steps));return e},getLastStep:function(){var f=this.steps;var g=f.length;var e;if(g===0){e=null}else{e=f[g-1]}return e},getSteps:function(){return this.steps},startsWith:function(e){var j=e.steps.length;if(j>this.steps.length){return false}for(var h=0;h<j;++h){var g=this.steps[h];var f=e.steps[h];if(!g.equals(f)){return false}}return true},hashCode:function(){return this.toString()},equals:function(f){var g=this.steps.length;if(g!=f.steps.length){return false}var e=this.startsWith(f);return e},copyAppendStep:function(g){var f=this.steps.slice(0);f.push(g);var e=new c.Path(f);return e},toJson:function(){var f=[];var g=this.steps;for(var h=0;h<g.length;++h){var j=g[h];var e=j.toJson();f.push(e)}return f},getPropertyNames:function(){var e=[];var g=this.steps;for(var h=0;h<g.length;++h){var j=g[h];var f=j.getPropertyName();e.push(f)}return e}});c.Path.classLabel="Path";c.Path.fromJson=function(h){var f=[];for(var g=0;g<h.length;++g){var k=h[g];var j=c.Step.fromJson(k);f.push(j)}var e=new c.Path(f);return e};c.Path.parse=function(h){h=_(h).trim();var g=h.length!==0?h.split(" "):[];var f=_.map(g,function(j){if(j==="<^"){return new c.StepFacet(-1)}else{if(j==="^"||j===">^"){return new c.StepFacet(1)}else{return c.Step.parse(j)}}});var e=new c.Path(f);return e};c.PathHead=Class.create({initialize:function(f,e){this.path=f;this.inverse=e?true:false},getPath:function(){return this.path},isInverse:function(){return this.inverse},equals:function(g){var f=this.path.equals(g.path);var h=this.inverse=g.inverse;var e=f&&h;return e}});c.Path.fromString=c.Path.parse})();(function(){var d=Jassa.sparql;var b=Jassa.rdf;var c=Jassa.facete;c.getElementsDirectTriples=function(h){var e=[];for(var g=0;g<h.length;++g){var f=h[g];if(f instanceof d.ElementTriplesBlock){e.push.apply(e,f.triples)}}return e};c.ConceptUtils={createCombinedConcept:function(n,l){var m=l.getElements();var o=n.getElement();var h=l.hasTriples();var k;if(m.length>0){if(h&&n.isSubjectConcept()){k=l.getElement()}else{var g=n.getElements();var f=[];f.push.apply(f,g);f.push.apply(f,m);k=new d.ElementGroup(f)}}else{k=o}var j=new facets.ConceptInt(k,l.getVariable());return j},createSubjectConcept:function(g){var h=g;var j=d.Node.v("_p_");var k=d.Node.v("_o_");var f=new d.ElementTriplesBlock([new b.Triple(h,j,k)]);var e=new c.Concept(f,h);return e},createQueryList:function(f){var e=new d.Query();e.setDistinct(true);e.getProject().add(f.getVar());var h=e.getElements();var g=f.getElements();h.push.apply(h,g);return e},createQueryCount:function(g,f){var e=c.QueryUtils.createQueryCount(g.getElements(),null,g.getVar(),f,null,true);return e},createQueryCountNotAsConciseAsPossible:function(g,f){var h=c.ConceptUtils.createQueryList(g);var e=new d.Query();e.getProject().add(f,new d.E_Count());e.getElements().push(h);return e},createQueryCountDoesNotWorkWithVirtuoso:function(g,f){var e=new d.Query();e.getProject().add(f,new d.E_Count(new d.ExprVar(g.getVar()),true));var j=e.getElements();var h=g.getElements();j.push.apply(j,h);return e}};c.FacetConcept=Class.create({initialize:function(g,e,f){this.elements=g;this.facetVar=e;this.facetValueVar=f},getElements:function(){return this.elements},getFacetVar:function(){return this.facetVar},getFacetValueVar:function(){return this.facetValueVar},toString:function(){var e="FacetConcept: ({"+this.elements.join(", ")+"}, "+this.facetVar+", "+this.facetValueVar+")";return e}});c.Concept=Class.create({classLabel:"Concept",initialize:function(f,e){this.element=f;this.variable=e},toJson:function(){var e={element:JSON.parse(JSON.stringify(this.element)),variable:this.variable};return e},getElement:function(){return this.element},hasTriples:function(){var f=this.getElements();var g=c.getElementsDirectTriples(f);var e=g.length>0;return e},getElements:function(){var e;if(this.element instanceof d.ElementGroup){e=this.element.elements}else{e=[this.element]}return e},getVar:function(){return this.variable},getVariable:function(){if(!this.warningShown){this.warningShown=true}return this.getVar()},toString:function(){return""+this.element+"; "+this.variable},isSubjectConcept:function(){var f=false;var g=this.variable;var m=this.element;if(m instanceof d.ElementTriplesBlock){var k=m.triples;if(k.length===1){var h=k[0];var j=h.getSubject();var l=h.getProperty();var n=h.getObject();f=g.equals(j)&&l.isVariable()&&n.isVariable()}}return f},combineWith:function(f){var e=c.createCombinedConcept(this,f);return e},createOptimizedConcept:function(){var f=this.getElement();var g=f.flatten();var e=new c.ConceptInt(g,this.variable);return e},getOptimizedElement:function(){}});c.Concept.createFromElements=function(h,f){var g;if(h.length==1){g=h[0]}else{g=new d.ElementGroup(h)}var e=new c.Concept(g,f);return e}})();(function(){var c=Jassa.sparql;var b=Jassa.facete;b.ElementFactoryConceptFactory=Class.create(c.ElementFactory,{initialize:function(d){this.conceptFactory=d},createElement:function(){var e=this.conceptFactory.createConcept();var d=e?e.getElement():null;return d}});b.ConceptFactory=Class.create({createConcept:function(){throw"not overridden"}});b.ConceptFactoryConst=Class.create(b.ConceptFactory,{initialize:function(d){this.concept=d},getConcept:function(){return this.concept},setConcept:function(d){this.concept=d},createConcept:function(){return this.concept}});b.ConceptFactoryFacetConfig=Class.create(b.ConceptFactory,{initialize:function(d,f,e){this.facetConfig=d;this.path=f||new facete.Path();this.excludeSelfConstraints=e},createConcept:function(){var e=b.FaceteUtils.createFacetConceptGenerator(this.facetConfig);var d=e.createConceptResources(this.path,this.excludeSelfConstraints);return d}});b.ConceptFactoryFacetTreeConfig=Class.create(b.ConceptFactory,{initialize:function(f,e,d){this.facetTreeConfig=f;this.path=e||new facete.Path();this.excludeSelfConstraints=d},setPath:function(d){this.path=d},getPath:function(){return this.path},getFacetTreeConfig:function(){return this.facetTreeConfig},setFacetTreeConfig:function(d){this.facetTreeConfig=d},isExcludeSelfConstraints:function(){return this.excludeSelfConstraints},setExcludeSelfConstraints:function(d){this.excludeSelfConstraints=d},createConcept:function(){var f=this.facetTreeConfig.getFacetConfig();var e=b.FaceteUtils.createFacetConceptGenerator(f);var d=e.createConceptResources(this.path,this.excludeSelfConstraints);return d}})})();(function(){var b=Jassa.facete;b.FacetNodeFactory=Class.create({createFacetNode:function(){throw"Override me"}});b.FacetNodeFactoryConst=Class.create(b.FacetNodeFactory,{initialize:function(c){this.facetNode=c},createFacetNode:function(){return this.facetNode}})})();(function(){var b=Jassa.facete;b.QueryFactory=Class.create({createQuery:function(){throw"Not overridden"}});b.QueryFactoryFacets=Class.create(b.QueryFactory,{initialize:function(c,e,d){this.subQueryFactory=c;this.rootFacetNode=e;this.constraintManager=d?d:new b.ConstraintManager()},getRootFacetNode:function(){return this.rootFacetNode},getConstraintManager:function(){return this.constraintManager},createQuery:function(){var f=this.subQueryFactory.createQuery();if(f==null){return null}var d=f.getProject();var c=_.map(d,function(g){return g.value});var e=this.constraintManager.createElements(this.rootFacetNode);f.elements.push.apply(f.elements,e);return f}});b.QueryFactoryFacets.create=function(d,e,g){g=g?g:new facets.GenSym("fv");var f=facets.FacetNode.createRoot(e,g);var c=new b.QueryFactoryFacets(d,f);return c}})();(function(){var b=Jassa.util;var c=Jassa.facete;c.ConstraintSpec=Class.create({getName:function(){console.log("[ERROR] Override me");throw"Override me"},getDeclaredPaths:function(){console.log("[ERROR] Override me");throw"Override me"},equals:function(){console.log("[ERROR] Override me");throw"Override me"},hashCode:function(){console.log("[ERROR] Override me");throw"Override me"}});c.ConstraintSpecSinglePath=Class.create(c.ConstraintSpec,{initialize:function(d,e){this.name=d;this.path=e},getName:function(){return this.name},getDeclaredPaths:function(){return[this.path]},getDeclaredPath:function(){return this.path}});c.ConstraintSpecPath=Class.create(c.ConstraintSpecSinglePath,{initialize:function($super,d,e){$super(d,e)}});c.ConstraintSpecPathValue=Class.create(c.ConstraintSpecSinglePath,{classLabel:"jassa.facete.ConstraintSpecPathValue",initialize:function($super,d,f,e){$super(d,f);this.value=e},getValue:function(){return this.value},equals:function(g){if(!g instanceof c.ConstraintSpecPathValue){return false}var e=this.name==g.name;var d=this.path.equals(g.path);var h=this.value.equals(g.value);var f=e&&d&&h;return f},hashCode:function(){var d=b.ObjectUtils.hashCode(this,true);return d}});c.ConstraintSpecExpr=Class.create(c.ConstraintSpec,{classLabel:"jassa.facete.ConstraintSpecExpr",initialize:function(e,d,f){this.expr=e;this.varToPath=d;this.varToNode=f},getPaths:function(){}})})();(function(){var d=Jassa.vocab;var c=Jassa.sparql;var b=Jassa.facete;b.ConstraintElementFactory=Class.create({createElementsAndExprs:function(f,e){console.log("[ERROR] Override me");throw"Override me"}});b.ConstraintElementFactoryExist=Class.create(b.ConstraintElementFactory,{createElementsAndExprs:function(h,e){var f=h.forPath(e.getDeclaredPath());var g=c.ElementUtils.createElementsTriplesBlock(f.getTriples());var j=new b.ElementsAndExprs(g,[]);return result}});b.ConstraintElementFactoryLang=Class.create(b.ConstraintElementFactory,{createElementsAndExprs:function(k,f){var n=k.forPath(f.getDeclaredPath());var j=n.getVar();var g=new c.ExprVar(j);var e=c.ElementUtils.createElementsTriplesBlock(n.getTriples());var h=f.getValue().getLiteralValue();var l=[new c.E_LangMatches(new c.E_Lang(g),h)];var m=new b.ElementsAndExprs(e,l);return m}});b.ConstraintElementFactoryRegex=Class.create(b.ConstraintElementFactory,{createElementsAndExprs:function(k,f){var n=k.forPath(f.getDeclaredPath());var j=n.getVar();var g=new c.ExprVar(j);var e=c.ElementUtils.createElementsTriplesBlock(n.getTriples());var h=f.getValue().getLiteralValue();var l=[new c.E_Regex(g,h,"i")];var m=new b.ElementsAndExprs(e,l);return m}});b.ConstraintElementFactoryEqual=Class.create(b.ConstraintElementFactory,{createElementsAndExprs:function(j,f){var n=j.forPath(f.getDeclaredPath());var h=n.getVar();var g=new c.ExprVar(h);var e=c.ElementUtils.createElementsTriplesBlock(n.getTriples());var k=c.NodeValue.makeNode(f.getValue());var l=[new c.E_Equals(g,k)];var m=new b.ElementsAndExprs(e,l);return m}});b.ConstraintElementFactoryBBoxRange=Class.create(b.ConstraintElementFactory,{initialize:function(){this.stepX=new b.Step(d.wgs84.str.lon);this.stepY=new b.Step(d.wgs84.str.la)},createElementsAndExprs:function(j,r){var u=j.forPath(r.getPath());var g=r.getValue();var h=u.forStep(this.stepX);var f=u.forStep(this.stepY);var l=h.getTriples();var k=f.getTriples();var q=c.util.mergeTriples(l,k);var p=h.getVar();var n=f.getVar();var o=b.createWgsFilter(vX,vY,this.bounds,xsd.xdouble);var e=[new c.ElementTriplesBlock(q)];var m=[o];var s=new b.ElementsAndExprs(e,m);return s}})})();(function(){var c=Jassa.sparql;var b=Jassa.facete;b.ElementsAndExprs=Class.create({initialize:function(d,e){this.elements=d;this.exprs=e},getElements:function(){return this.elements},getExprs:function(){return this.exprs},toElements:function(){var d=[];var e=c.ElementUtils.createFilterElements(this.exprs);d.push.apply(d,this.elements);d.push.apply(d,e);return d}})})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.facete;c.createDefaultConstraintElementFactories=function(){var e=new b.ObjectMap();e.put("exist",new c.ConstraintElementFactoryExist());e.put("equal",new c.ConstraintElementFactoryEqual());e.put("bbox",new c.ConstraintElementFactoryBBoxRange());e.put("regex",new c.ConstraintElementFactoryRegex());e.put("lang",new c.ConstraintElementFactoryLang());return e};c.ConstraintList=Class.create({classLabel:"jassa.facete.ConstraintList",initialize:function(e){this.list=e||new b.ArrayList()},getConstraintsByPath:function(h){var e=[];var l=this.constraints;for(var f=0;f<l.length;++f){var g=l[f];var k=g.getDeclaredPaths();var j=_.some(k,function(n){var m=n.equals(h);return m});if(j){e.push(g)}}return e},getConstrainedSteps:function(v){var l=[];var n=v.getSteps();var h=this.constraints;for(var m=0;m<h.length;++m){var f=h[m];var u=f.getDeclaredPaths();for(var k=0;k<u.length;++k){var e=u[k];var r=e.getSteps();var q=r.length-n.length;var o=e.startsWith(v);if(q==1&&o){var g=r[r.length-1];l.push(g)}}}var s=_.uniq(l,function(j){return""+j});return s},getConstraints:function(){return this.constraints},addConstraint:function(e){this.constraints.push(e)},removeConstraint:function(h){var e=false;var g=this.constraints;var k=[];for(var f=0;f<g.length;++f){var j=g[f];if(!j.equals(h)){k.push(j)}else{e=true}}this.constraints=k;return e},toggleConstraint:function(f){var e=this.removeConstraint(f);if(!e){this.addConstraint(f)}}});c.ConstraintCompiler=Class.create({initialize:function(e){if(!e){e=c.createDefaultConstraintElementFactories()}this.cefRegistry=e},getCefRegistry:function(){return this.cefRegistry},createElementsAndExprs:function(h,m,n){var e=[];var j=[];var f={};var k=this;var g=h.toArray();_(g).each(function(o){var x=o.getDeclaredPaths();var r=_(x).reduce(function(A,B){return A+" "+B},"");if(n){var v=_(x).some(function(B){var A=n.equals(B);return A});if(v){return}}_(x).each(function(C){var B=m.forPath(C);var A=B.getElements();e.push.apply(e,A)});var p=o.getName();var w=k.cefRegistry.get(p);if(!w){throw"No constraintElementFactory registered for "+p}var z=w.createElementsAndExprs(m,o);var y=z.getElements();var q=z.getExprs();if(y){e.push.apply(e,y)}if(q&&q.length>0){var s=f[r];if(!s){s=[];f[r]=s}var u=d.andify(q);s.push(u)}});_(f).each(function(p){var o=d.orify(p);j.push(o)});var l=new c.ElementsAndExprs(e,j);return l}});c.ConstraintManager=Class.create({initialize:function(e,f){if(!e){e=c.createDefaultConstraintElementFactories()}this.cefRegistry=e;this.constraints=f||[]},shallowClone:function(){var e=new c.ConstraintManager(this.cefRegistry,this.constraints.slice(0));return e},getCefRegistry:function(){return this.cefRegistry},getConstraintsByPath:function(h){var e=[];var l=this.constraints;for(var f=0;f<l.length;++f){var g=l[f];var k=g.getDeclaredPaths();var j=_.some(k,function(n){var m=n.equals(h);return m});if(j){e.push(g)}}return e},getConstrainedSteps:function(v){var l=[];var n=v.getSteps();var h=this.constraints;for(var m=0;m<h.length;++m){var f=h[m];var u=f.getDeclaredPaths();for(var k=0;k<u.length;++k){var e=u[k];var r=e.getSteps();var q=r.length-n.length;var o=e.startsWith(v);if(q==1&&o){var g=r[r.length-1];l.push(g)}}}var s=_.uniq(l,function(j){return""+j});return s},getConstraints:function(){return this.constraints},addConstraint:function(e){this.constraints.push(e)},removeConstraint:function(h){var e=false;var g=this.constraints;var k=[];for(var f=0;f<g.length;++f){var j=g[f];if(!j.equals(h)){k.push(j)}else{e=true}}this.constraints=k;return e},toggleConstraint:function(f){var e=this.removeConstraint(f);if(!e){this.addConstraint(f)}},createElementsAndExprs:function(j,g){var l=[];var k=[];var h={};var f=this;_(this.constraints).each(function(m){var v=m.getDeclaredPaths();var p=_(v).reduce(function(y,z){return y+" "+z},"");if(g){var s=_(v).some(function(z){var y=g.equals(z);return y});if(s){return}}_(v).each(function(A){var z=j.forPath(A);var y=z.getElements();l.push.apply(l,y)});var n=m.getName();var u=f.cefRegistry.get(n);if(!u){throw"No constraintElementFactory registered for "+n}var x=u.createElementsAndExprs(j,m);var w=x.getElements();var o=x.getExprs();if(w){l.push.apply(l,w)}if(o&&o.length>0){var q=h[p];if(!q){q=[];h[p]=q}var r=d.andify(o);q.push(r)}});_(h).each(function(n){var m=d.orify(n);k.push(m)});var e=new c.ElementsAndExprs(l,k);return e}})})();(function(){var b=Jassa.facete;b.ConstraintTaggerFactory=Class.create({initialize:function(c){this.constraintManager=c},createConstraintTagger:function(e){var f=this.constraintManager.getConstraintsByPath(e);var d={};_(f).each(function(j){var g=j.getName();if(g=="equal"){var h=j.getValue();d[h.toString()]=h}});console.log("eqConstraints: ",d);var c=new b.ConstraintTagger(d);return c}});b.ConstraintTagger=Class.create({initialize:function(c){this.equalConstraints=c},getTags:function(d){var c={isConstrainedEqual:this.equalConstraints[d.toString()]?true:false};return c}})})();(function(){var b=Jassa.rdf;var d=Jassa.sparql;var c=Jassa.facete;c.VarNode=Class.create({initialize:function(h,g,j,f,e){this.variableName=h;this.generator=g;this.stepId=j;this.parent=f;this.root=e;if(!this.root){if(this.parent){this.root=f.root}else{this.root=this}}this.idToChild={}},isRoot:function(){var e=this.parent?false:true;return e},getVariableName:function(){return this.variableName},getIdStr:function(){var f=this.parent?this.parent.getIdStr():"";var e=f+this.variableName;return e},getStepId:function(e){return""+JSON.stringify(e)},getSteps:function(){return this.steps},forProperty:function(h,f){var g=new c.Step(h,f);var e=this.forStep(g);return e},forStepId:function(f){var g=this.idToChild[f];if(!g){var e=this.generator.next();g=new c.VarNode(e,this.generator,f,this);this.idToChild[f]=g}return g},findNodeByVarName:function(j){if(this.variableName===j){return this}var g=_.values(this.idToChild);for(var f=0;f<g.length;++f){var h=g[f];var e=h.findNodeByVarName(j);if(e){return e}}return null}});c.FacetNode=Class.create({initialize:function(f,h,g,e){this.parent=g;this.root=e;if(!this.root){if(this.parent){this.root=g.root}else{this.root=this}}this.varNode=f;this.step=h;this._isActive=true;this.idToChild={}},getRootNode:function(){return this.root},isRoot:function(){var e=this.parent?false:true;return e},getVar:function(){var f=this.varNode.getVariableName();var e=b.NodeFactory.createVar(f);return e},getVariable:function(){if(!this.warningShown){this.warningShown=true}return this.getVar()},getStep:function(){return this.step},getParent:function(){return this.parent},getPath:function(){var f=[];var g=this;while(g!=this.root){f.push(g.getStep());g=g.getParent()}f.reverse();var e=new c.Path(f);return e},forPath:function(g){var f=g.getSteps();var e=this;_.each(f,function(h){e=e.forStep(h)});return e},getIdStr:function(){},getSteps:function(){return this.steps},getConstraints:function(){return this.constraints},isActiveDirect:function(){return this._isActive},getElements:function(){var e=[];var g=this.getTriples();if(g.length>0){var f=new d.ElementTriplesBlock(g);e.push(f)}return e},getTriples:function(){var e=[];this.getTriples2(e);return e},getTriples2:function(e){this.createDirectTriples2(e);if(this.parent){this.parent.getTriples2(e)}return e},createDirectTriples:function(){var e=[];this.createDirectTriples2(e);return e},createDirectTriples2:function(e){if(this.step){var g=this.parent.getVariable();var j=this.getVariable();var f=this.step.createElement(g,j,this.generator);var h=f.getTriples();e.push.apply(e,h)}return e},isActive:function(){if(!this._isActive){return false}if(this.parent){return this.parent.isActive()}return true},attachToParent:function(){if(!this.parent){return}this.parent[this.id]=this;this.parent.attachToParent()},forProperty:function(h,f){var g=new c.Step(h,f);var e=this.forStep(g);return e},forStep:function(e){var g=""+JSON.stringify(e);var h=this.idToChild[g];if(!h){var f=this.varNode.forStepId(g);h=new c.FacetNode(f,e,this,this.root);this.idToChild[g]=h}return h},copyTo:function(e){_.each(this.getConstraints(),function(f){e.addConstraint(f)})},copyExclude:function(){var e=new c.FacetNode();console.log("Now root:",e);this.root.copyExcludeRec(e,this);return e},copyExcludeRec:function(f,e){console.log("Copy:",this,f);if(this===e){return}this.copyTo(f);_.each(this.getSteps(),function(k){var j=k.step;var h=k.child;console.log("child:",j,h);if(h===e){return}var g=f.forStep(j);console.log("New child:",g);h.copyExcludeRec(g,e)})}});c.FacetNode.createRoot=function(g,h){var j=g.getName();h=h?h:new d.GenSym("fv");var f=new c.VarNode(j,h);var e=new c.FacetNode(f);return e};c.FacetManager=Class.create({initialize:function(g,f){var e=new c.VarNode(g,f);this.rootNode=new c.FacetNode(e);this.generator=f},getRootNode:function(){return this.rootNode},getGenerator:function(){return this.generator}});c.SimpleFacetFacade=Class.create({initialize:function(f,e){this.constraintManager=f;this.facetNode=e},getFacetNode:function(){return this.facetNode},getVariable:function(){var e=this.facetNode.getVariable();return e},getPath:function(){return this.facetNode.getPath()},forProperty:function(f,h){var g=this.facetNode.forProperty(f,h);var e=this.wrap(g);return e},forStep:function(g){var f=this.facetNode.forStep(g);var e=this.wrap(f);return e},wrap:function(f){var e=new c.SimpleFacetFacade(this.constraintManager,f);return e},forPathStr:function(f){var g=c.Path.fromString(f);var e=this.forPath(g);return e},forPath:function(g){var f=this.facetNode.forPath(g);var e=this.wrap(f);return e},createConstraint:function(g){if(g.type!="equals"){throw"Only equals supported"}var h=g.node;var f=d.NodeValue.makeNode(h);var e=c.ConstraintUtils.createEquals(this.facetNode.getPath(),f);return e},addConstraint:function(e){var f=this.createConstraint(e);this.constraintManager.addConstraint(f)},removeConstraint:function(e){var f=this.createConstraint(e);this.constraintManager.moveConstraint(f)},getConstraints:function(){var e=this.facetNode.getPath();var f=this.constraintManager.getConstraintsByPath(e);return f},createElements:function(j){var f=this.facetNode.getRootNode();var h=j?null:this.facetNode.getPath();var k=this.constraintManager.createElements(f,h);var g=this.facetNode.getElements();k.push.apply(k,g);var e=d.ElementUtils.flatten(k);return e},createConcept:function(g){var h=this.createElements(g);var f=this.getVariable();var e=new c.Concept(h,f);return e},getConstrainedSteps:function(){var f=this.getPath();var e=this.constraintManager.getConstrainedSteps(f);return e}})})();(function(){var b=Jassa.rdf;var e=Jassa.vocab;var d=Jassa.sparql;var c=Jassa.facete;c.QueryUtils={createElementsFacet:function(l,n,m,g){var u=[];if(!l.isSubjectConcept()){var f=l.getElements();u.push.apply(u,f)}var r=l.getVariable();var h=m;var j=g;var q=n?[new b.Triple(j,h,r)]:[new b.Triple(r,h,j)];var k=new d.ElementTriplesBlock(q);u.push(k);return u},createQueryFacetCount:function(m,g,l,k,h){var j=d.Node.v("__o");var n=c.createElementsFacet(m,k,g,j);var f=c.createQueryCount(element,h,j,l,[g],true);return f},createQueryCount:function(g,n,m,w,q,k,v){var j=m?new d.ExprVar(m):null;var s=new d.Query();if(n){var p=new d.Query();var l=p.getElements();l.push.apply(l,g);if(q){for(var o=0;o<q.length;++o){var h=q[o];p.projectVars.add(h)}}if(m){p.projectVars.add(m)}if(p.projectVars.vars.length===0){p.setResultStar(true)}p.limit=n;s.getElements().push(new d.ElementSubQuery(p))}else{var f=s.getElements();f.push.apply(f,g)}if(q){_(q).each(function(x){s.getProject().add(x)})}s.setDistinct(k);if(m){s.getProject().add(m)}else{s.setResultStar(true)}var r=new d.ElementSubQuery(s);var u=new d.Query();if(q){_(q).each(function(x){u.getProject().add(x);u.getGroupBy().push(new d.ExprVar(x))})}u.getProject().add(w,new d.E_Count());u.getElements().push(r);return u},createQueryCountDoesNotWorkWithVirtuoso:function(f,m,l,u,q,j,s){var h=l?new d.ExprVar(l):null;var r=new d.Query();if(m){var p=new d.Query();var k=p.getElements();k.push.apply(k,f);if(q){for(var n=0;n<q.length;++n){var g=q[n];p.projectVars.add(g)}}if(l){p.projectVars.add(l)}if(p.projectVars.vars.length===0){p.setResultStar(true)}p.limit=m;r.getElements().push(new d.ElementSubQuery(p))}else{var o=r.getElements();o.push.apply(o,f)}if(q){_(q).each(function(v){r.getProject().add(v);r.getGroupBy().push(new d.ExprVar(v))})}r.getProject().add(u,new d.E_Count(h,j));return r}}})();(function(){var f=Jassa.vocab;var b=Jassa.util;var e=Jassa.sparql;var c=Jassa.rdf;var d=Jassa.facete;d.NodeSet=Class.create({initialize:function(g,h){this.nodes=g;this.isNegated=h},getNodes:function(){return this.nodes},isNegated:function(){return this.isNegated}});d.FacetConceptItem=Class.create({initialize:function(h,g){this.step=h;this.concept=g},getStep:function(){return this.step},getFacetConcept:function(){return this.concept},toString:function(){return this.step+": "+this.concept}});d.createFilter=function(k,j,l){var h=[];var g=null;if(j.length>0){var m=new e.E_OneOf(new e.ExprVar(k),j);if(l){m=new e.E_LogicalNot(m)}g=new e.ElementFilter([m])}return g};d.itemToArray=function(h){var g=[];if(h!=null){g.push(h)}return g};d.LimitAndOffset=Class.create({initialize:function(g,h){this.limit=g;this.offset=h},getOffset:function(){return this.offset},getLimit:function(){return this.limit},setOffset:function(g){this.offset=g},setLimit:function(g){this.limit=g}});d.FacetState=Class.create({isExpanded:function(){throw"Override me"},getResultRange:function(){throw"Override me"},getAggregationRange:function(){throw"Override me"}});d.FacetStateImpl=Class.create(d.FacetState,{initialize:function(h,j,g){this._isExpanded=h;this.resultRange=j;this.aggregationRange=g},isExpanded:function(){return this._isExpanded},getResultRange:function(){return this.resultRange},getAggregationRange:function(){return this.aggregationRange}});d.FacetStateProvider=Class.create({getFacetState:function(g){throw"Override me"}});d.FacetStateProviderImpl=Class.create({initialize:function(g){this.defaultLimit=g;this.pathToState=new b.HashMap()},getMap:function(){return this.pathToState},getFacetState:function(h){var g=this.pathToState.get(h);if(!g){g=new d.FacetStateImpl(null,new d.LimitAndOffset(this.defaultLimit,0),null);this.pathToState.put(h,g)}return g}});d.FacetConceptGenerator=Class.create({createFacetConcept:function(h,g){throw"Override me"},createFacetValueConcept:function(h,g){throw"Override me"}});d.FacetGeneratorConfig=Class.create({initialize:function(g,j,h){this.baseConcept=g;this.rootFacetNode=j;this.constraintManager=h},getBaseConcept:function(){return this.baseConcept},getRootFacetNode:function(){return this.rootFacetNode},getConstraintManager:function(){return this.constraintManager}});d.FacetGeneratorConfigProvider=Class.create({getConfig:function(){throw"Override me"},});d.FacetGeneratorConfigProviderConst=Class.create(d.FacetGeneratorConfigProvider,{initialize:function(g){this.facetConfig=g},getConfig:function(){return this.facetConfig}});d.FacetGeneratorConfigProviderIndirect=Class.create(d.FacetGeneratorConfigProvider,{initialize:function(h,g,j){this.baseConceptFactory=h;this.rootFacetNodeFactory=g;this.constraintManager=j},getConfig:function(){var h=this.baseConceptFactory.createConcept();var k=this.rootFacetNodeFactory.createFacetNode();var j=this.constraintManager;var g=new d.FacetGeneratorConfig(h,k,j);return g}});d.FacetConceptGeneratorFactory=Class.create({createFacetConceptGenerator:function(){throw"Implement me"}});d.FacetConceptGeneratorFactoryImpl=Class.create(d.FacetConceptGeneratorFactory,{initialize:function(g){this.facetConfigProvider=g},createFacetConceptGenerator:function(){var h=this.facetConfigProvider.getConfig();var g=new d.FacetConceptGeneratorImpl(h);return g}});d.FacetConceptGeneratorImpl=Class.create(d.FacetConceptGenerator,{initialize:function(g){this.facetConfig=g},createConceptResources:function(r,z){var u=this.facetConfig;var v=u.getBaseConcept();var k=u.getRootFacetNode();var m=u.getConstraintManager();var p=z?r:null;var w=m.createElementsAndExprs(k,p);var x=w.getElements();var j=w.getExprs();var o=k.forPath(r);var h=o.getVar();var l=v.getElements();var y=o.getElements();var g=[];g.push.apply(g,y);g.push.apply(g,x);if(v.isSubjectConcept()){if(g.length==0){g=l}}else{g.push.apply(g,l)}var s=_(j).map(function(B){var A=new e.ElementFilter(B);return A});g.push.apply(g,s);var n=e.ElementUtils.flatten(g);n=e.ElementUtils.flattenElements(n);var q=d.Concept.createFromElements(n,h);return q},createConceptFacetsCore:function(E,n,y,F){var H=this.facetConfig;var I=H.getBaseConcept();var k=H.getRootFacetNode();var q=H.getConstraintManager();var P=null;if(F){P=new d.Step(F.getUri(),n)}var u=null;if(P){u=E.copyAppendStep(P)}var J=q.createElementsAndExprs(k,u);var O=J.toElements();var s=k.forPath(E);var h=s.getVar();var p=I.getElements();var g;if(I.isSubjectConcept()){g=O}else{g=p.concat(O)}var D=e.PatternUtils.getVarsMentioned(g);var x=D.map(function(R){return R.getName()});var N=new e.GeneratorBlacklist(e.GenSym.create("p"),x);var L=new e.GeneratorBlacklist(e.GenSym.create("o"),x);var G=c.NodeFactory.createVar(N.next());var M=c.NodeFactory.createVar(L.next());var C=g.length!==0;var K;if(y&&!C&&E.isEmpty()){var B=[f.rdf.Property,f.owl.AnnotationProperty,f.owl.DatatypeProperty,f.owl.ObjectProperty];var A=c.NodeFactory.createVar("_x_");var z=new e.ExprVar(A);var j=_(B).map(function(R){var v=e.NodeValue.makeNode(R);var S=new e.E_Equals(z,v);return S});var o=e.orify(j);var K=new c.Triple(G,f.rdf.type,A);var l=new e.ElementGroup([new e.ElementTriplesBlock([K]),new e.ElementFilter(o)]);g.push(l)}else{if(!n){K=new c.Triple(h,G,M)}else{K=new c.Triple(M,G,h)}g.push(new e.ElementTriplesBlock([K]))}if(P){var z=new e.ExprVar(G);var m=new e.E_Equals(z,e.NodeValue.makeNode(F));g.push(new e.ElementFilter([m]))}var Q=s.getElements();g.push.apply(g,Q);var r=e.ElementUtils.flatten(g);r=e.ElementUtils.flattenElements(r);var w=new d.FacetConcept(r,G,M);return w},createConceptFacets:function(k,j){var h=this.createConceptFacetsCore(k,j,true);var g=new d.Concept.createFromElements(h.getElements(),h.getFacetVar());return g},createConceptFacetValues:function(w,j,m,k){j=j==null?false:j;var q;var y=m.map(function(C){return C.getUri()});var z=this.facetConfig;var A=z.getBaseConcept();var h=z.getRootFacetNode();var n=z.getConstraintManager();var p=h.forPath(w);var s=n.getConstrainedSteps(w);var B=_(s).filter(function(E){var D=E.isInverse()===j;if(!D){return false}var F=_(y).contains(E.getPropertyName());var C=k?!F:F;return C});var l=B.map(function(C){return C.getPropertyName()});var r=[];var x=[];_(m).each(function(C){if(_(l).contains(C.getUri())){x.push(C)}else{r.push(C)}});var q=this.createConceptItems(p,B);var o=this.createConceptFacetsCore(w,j,false);var g=o.getElements();var v=d.createFilter(o.getFacetVar(),r,false);if(v!=null){g.push(v)}if(r.length>0){var u=new d.FacetConceptItem(null,o);q.push(u)}return q},createConceptItems:function(j,k){var h=this;var g=_(k).map(function(m){var l=h.createConceptItem(j,m);return l});return g},createConceptItem:function(j,l){var h=l.getPropertyName();var m=c.NodeFactory.createUri(h);var n=j.getPath();var k=this.createConceptFacetsCore(n,l.isInverse(),false,m);var g=new d.FacetConceptItem(l,k);return g}})})();(function(g){var b=Jassa.service;var d=Jassa.rdf;var j=Jassa.sponate;var c=Jassa.util;var f=Jassa.sparql;var e=Jassa.facete;e.FacetTreeServiceImpl=Class.create({initialize:function(n,l,o,m,k){this.facetService=n;this.expansionSet=l;this.expansionMap=o;this.facetStateProvider=m;this.pathToFilterString=k},fetchFacetTree:function(l){var m;if(l.isEmpty()){m=new e.FacetItem(l,d.NodeFactory.createUri("http://root"),null)}else{m=new e.FacetItem(l,d.NodeFactory.createUri(l.getLastStep().getPropertyName()),null)}var k=this.fetchFacetTreeRec(l,m);k.done(function(n){console.log("FacetTree: ",n)});return k},fetchFavFacets:function(n){var l=this;var m=_(n).map(function(p){var q=new e.FacetItem(p,d.NodeFactory.createUri(p.getLastStep().getPropertyName()),null);var o=l.fetchFacetTreeRec(p,q);return o});var k=g.Deferred();g.when.apply(window,m).done(function(){var o=_(arguments).map(function(p){return p});k.resolve(o)}).fail(k.fail);return k.promise()},fetchFacetTreeChildren:function(z,w){var q={path:z,children:[],limit:null,offset:null};var p=null;var r=null;var l=this.facetStateProvider.getFacetState(z);if(l){var v=l.getResultRange();p=v.getLimit();r=v.getOffset()||0}q.limit=p;q.offset=r;var s=this.pathToFilterString.get(z);var k=this.facetService.createFlow(z,w,s);var m=k.count();var n=k.skip(r).limit(p);var o=this.facetService.fetchFacetsFromFlow(n,z,w);var u=[m,o];var y=g.Deferred();var x=this;g.when.apply(window,u).pipe(function(C,A){q.childFacetCount=C;var D=p?Math.floor((r||0)/p):0;q.pageIndex=1+D;q.pageCount=1+(p?Math.floor(C/p):0);var B=_(A).map(function(E){var F=E.getPath();var G=x.fetchFacetTreeRec(F,E);return G});g.when.apply(window,B).done(function(){_(arguments).each(function(E){q.children.push(E)});y.resolve(q)}).fail(function(){y.fail()})});return y},fetchFacetTreeRec:function(v,m){var k=this.expansionSet.contains(v);var p=this.expansionMap.get(v);var o=(p&1)!=0;var l=(p&2)!=0;var n={item:m,isExpanded:k,expansionState:p,isOutgoingActive:o,isIncomingActive:l,incoming:null,outgoing:null};var r=this;var u=g.Deferred();var q=[];if(k){if(o){var s=this.fetchFacetTreeChildren(v,false).pipe(function(w){n.outgoing=w});q.push(s)}if(l){var s=this.fetchFacetTreeChildren(v,true).pipe(function(w){n.incoming=w});q.push(s)}}g.when.apply(window,q).done(function(){u.resolve(n)});return u.promise()},fetchFacetTreeRecOldWrongChildFacetCounts:function(s){console.log("fetchFacetTreeRec: "+s);var r=this;var u=g.Deferred();var n=null;var o=null;var k=this.facetStateProvider.getFacetState(s);if(k){var q=k.getResultRange();n=q.getLimit();o=q.getOffset()}var l=this.facetService.fetchFacetCount(s,false);var m=this.facetService.fetchFacets(s,false,n,o);var p=[l,m];g.when.apply(window,p).done(function(z,w){var y=[];var x=[];var v=0;_(w).each(function(B){var D=B.getPath();var C=B.getNode().getUri();var E=r.expansionSet.contains(D);var A={item:B,isExpanded:E,children:null,childFacetCount:z,limit:n,offset:o};++v;y.push(A);if(!E){return}console.log("Got a child facet for path "+D+" with "+z+" children");var F=r.fetchFacetTreeRec(D).pipe(function(G){A.children=G});x.push(F)});g.when.apply(window,x).done(function(){u.resolve(y)}).fail(function(){u.fail()})});return u.promise()}});e.FacetService=Class.create({fetchFacets:function(l,k){throw"Override me"}});e.FacetItem=Class.create({initialize:function(o,m,l,k,n){this.path=o;this.node=m;this.distinctValueCount=l;this.tags=k||{};this.doc=n||{}},getNode:function(){return this.node},getPath:function(){return this.path},getDoc:function(){return this.doc},setDoc:function(k){this.doc=k},getDistinctValueCount:function(){return this.distinctValueCount},getTags:function(){return this.tags},setTags:function(k){this.tags=k}});e.FacetFetchingWorkflow=Class.create({execute:function(k,l){}});e.FacetServiceImpl=Class.create(e.FacetService,{initialize:function(l,k,n,m){this.sparqlService=l;this.facetConceptGenerator=k;this.labelMap=n;this.pathTaggerManager=m},createFlow:function(p,l,n){var o=new j.StoreFacade(this.sparqlService,{});o.addMap(this.labelMap,"labels");var m=this.facetConceptGenerator.createConceptFacets(p,l);var q={};if(n){q={$or:[{hiddenLabels:{$elemMatch:{id:{$regex:n,$options:"i"}}}},{id:{$regex:n,$options:"i"}}]}}var k=o.labels.find(q).concept(m,true);return k},fetchFacetCount:function(p,m){var n=this.facetConceptGenerator.createConceptFacets(p,m);var k=d.NodeFactory.createVar("_c_");var o=e.ConceptUtils.createQueryCount(n,k);var l=this.sparqlService.createQueryExecution(o);var q=b.ServiceUtils.fetchInt(l,k);return q},fetchFacets2:function(y,u,n,o){var r=this.facetConceptGenerator.createConceptFacetsCore(y,u,false);var k=r.getElements();var l=r.getFacetVar();var q=r.getFacetValueVar();var x=d.NodeFactory.createVar("_c_");var s=e.QueryUtils.createQueryCount(k,null,q,x,[l],true);var m=s.getProject().getExpr(x);s.getOrderBy().push(new f.SortCondition(m,-1));var w=this.sparqlService.createQueryExecution(s).execSelect();var v=w.pipe(function(C){var z=[];while(C.hasNext()){var F=C.nextBinding();var H=F.get(l);var D=F.get(x);var E=H.getUri();var A=D.getLiteralValue();var B=new e.Step(E,u);var G=y.copyAppendStep(B);var I=new e.FacetItem(G,H,A);z.push(I)}return z});var p=this.pipeTagging(v);return p},pipeTagging:function(m){var l=this;var k=m.pipe(function(n){_(n).each(function(p){var o=l.pathTaggerManager.createTags(p.getPath());p.setTags(o)});return n});return k},fetchFacetsFromFlow:function(m,p,o){var q=m.asList(true);var l=g.Deferred();var k=this;q.done(function(v){var s=c.MapUtils.indexBy(v,"id");var r=_(v).pluck("id");if(r.length===0){l.resolve([]);return}var u=k.fetchFacetValueCounts(p,o,r,false);u.done(function(w){console.log("PropertyCounts",w);_(w).each(function(x){var y=s.get(x.getNode());x.setDoc(y)});l.resolve(w)}).fail(function(){l.fail()})}).fail(function(){l.fail()});var n=this.pipeTagging(l);return n.promise()},fetchFacets:function(u,p,m,n){var l=this.facetConceptGenerator.createConceptFacets(u,p);var o=e.ConceptUtils.createQueryList(l);o.setLimit(m);o.setOffset(n);var k=this.sparqlService.createQueryExecution(o);var s=b.ServiceUtils.fetchList(k,l.getVar());var r=this;var q=g.Deferred();s.done(function(v){var w=r.fetchFacetValueCounts(u,p,v,false);w.done(function(x){console.log("PropertyCounts",x);q.resolve(x)}).fail(function(){q.fail()})}).fail(function(){q.fail()});return q.promise()},fetchFacetValueCountsThresholded:function(v,p,n,l,m,q){m=1000;var o=this.createQuerySpecsFacetValueScanCounts(v,p,n,l,m,q);var u=this.processQuerySpecsFacetValueCounts(v,p,n,o);var s=jQuery.Deferred();var r=this;u.done(function(y){var x=_(y).filter(function(A){return A.getDistinctValueCount()<m});var w=_(x).map(function(A){return A.getNode()});var z=r.fetchFacetValueCountsFull(v,p,w,l,m);z.done(function(B){var A=_(B).indexBy(function(D){return D.getNode().getUri()});var C=_(n).map(function(I){var D=I.getUri();var H=A[D];if(!H){var E=-1;var G=new e.Step(D,p);var F=v.copyAppendStep(G);var H=new e.FacetItem(F,I,E)}return H});s.resolve(C)}).fail(function(){s.fail.apply(this,arguments)})}).fail(function(){s.fail.apply(this,arguments)});var k=this.pipeTagging(s);return k},createQuerySpecsFacetValueScanCounts:function(z,s,q,o,p,u){if(o){console.log("Negated property sets not (yet) supported with thresholded counting strategy");throw"Bailing out"}var A=d.NodeFactory.createVar("_c_");var k=d.NodeFactory.createVar("p_1");var x=this;var m=_(q).map(function(H){var E=x.facetConceptGenerator.createConceptFacetValues(z,s,[H],o);var D=E[0];var B=D.getFacetConcept();var C=B.getFacetVar();var I=B.getFacetValueVar();var G=B.getElements();var F=e.QueryUtils.createQueryCount(G,p,I,A,[C],false);return F});var w;if(m.length>1){var v=_(m).map(function(C){var B=new f.ElementSubQuery(C);return B});var l=new f.ElementUnion(v);w=new f.Query();w.getProject().add(k);w.getProject().add(A);var r=w.getElements();w.getElements().push(l)}else{if(m.length===1){w=m[0]}else{console.log("Should not happen");throw"Should not happen"}}var n={query:w,groupVar:k,outputVar:A};var y=[n];return y},processQuerySpecsFacetValueCounts:function(q,n,m,o){var p={};_(m).each(function(u){var s=u.getUri();p[s]={property:u,distinctValueCount:0}});var k=this;var l=_(o).map(function(x){var w=x.query;var u=x.groupVar;var s=x.outputVar;var v=k.sparqlService.createQueryExecution(w);var y=v.execSelect().pipe(function(A){while(A.hasNext()){var D=A.nextBinding();var C=D.get(u);var z=C.getUri();var B=D.get(s).getLiteralValue();p[z]={property:C,distinctValueCount:B}}});return y});var r=g.Deferred();g.when.apply(window,l).done(function(){var s=_(m).map(function(A){var u=A.getUri();var z=p[u];var w=z.distinctValueCount;var y=new e.Step(u,n);var x=q.copyAppendStep(y);var v=new e.FacetItem(x,A,w);return v});r.resolve(s)}).fail(function(){r.fail()});return r.promise()},fetchFacetValueCounts:function(o,n,m,l){var k=this.fetchFacetValueCountsThresholded(o,n,m,l);return k},fetchFacetValueCountsFull:function(s,q,n,l){var k=this.facetConceptGenerator.createConceptFacetValues(s,q,n,l);var u=d.NodeFactory.createVar("_c_");var o={};_(n).each(function(w){var v=w.getUri();o[v]={property:w,distinctValueCount:0}});var r=this;var p=_(k).map(function(y){var v=y.getFacetConcept();var w=v.getFacetVar();var C=v.getFacetValueVar();var A=v.getElements();var z=e.QueryUtils.createQueryCount(A,null,C,u,[w],true);var x=r.sparqlService.createQueryExecution(z);var B=x.execSelect().pipe(function(E){while(E.hasNext()){var H=E.nextBinding();var G=H.get(w);var D=G.getUri();var F=H.get(u).getLiteralValue();o[D]={property:G,distinctValueCount:F}}});return B});var m=g.Deferred();g.when.apply(window,p).done(function(){var v=_(n).map(function(C){var w=C.getUri();var B=o[w];var y=B.distinctValueCount;var A=new e.Step(w,q);var z=s.copyAppendStep(A);var x=new e.FacetItem(z,C,y);return x});m.resolve(v)}).fail(function(){m.fail()});return m.promise()}});var h={refreshPageCount:function(){var n=this;if(!this.tableExecutor){n.paginatorModel.set({pageCount:1});return}var k=g.Deferred();n.paginatorModel.set({isLoadingPageCount:true});var o=function(q){n.tableModel.set({itemCount:q.count,hasMoreItems:q.more});n.paginatorModel.set({isLoadingPageCount:false});k.resolve()};var m=10000;var p=3000;var l=this.tableExecutor.fetchResultSetSize(null,null,{timeout:p});l.fail(function(){console.log("[WARN] Timeout encountered when retrieving page count - retrying with sample strategy");var q=n.tableExecutor.fetchResultSetSize(m,null,{timeout:p});q.pipe(o);q.fail(function(){console.log("[ERROR] Timout encountered during fallback sampling strategy - returning only 1 page");n.paginatorModel.set({isLoadingPageCount:false});k.resolve({itemCount:1,hasMoreItems:true})})});l.pipe(o)},omfgWhatDidIDo_IWasABadProgrammer:function(){var o=[];for(var n=0;n<conceptItems.length;++n){var p=conceptItems[n];var r=this.fnFetchSubFacets(this.sparqlService,p);o.push(r)}var m=model.get("children");var q=_.map(this.facetProviders,function(v){var s=v.fetchFacets(concept,false,constrainedSteps);var u=s.pipe(function(y){var x=[];for(var A=0;A<y.length;++A){var D=y[A];var z=D.facetUri;var B=D.isInverse;var C={type:"property",property:z,isInverse:B};var w=facetFacadeNode.forProperty(z,B);D.facetFacadeNode=w;D.facetNode=w.getFacetNode();D.step=C;x.push(D)}return x});return u});model.set({isLoading:true});o.push.apply(o,q);var k=g.when.apply(null,o);k.always(function(){model.set({isLoading:false})});var l=g.Deferred();k.pipe(function(){var A=[];for(var x=0;x<arguments.length;++x){var z=arguments[x];A.push.apply(A,z)}var u=[];for(var x=0;x<A.length;++x){var D=A[x];var B=D.id;u.push(B)}var v=m.map(function(F){return F.id});var C=_.difference(v,u);m.remove(C);for(var x=0;x<A.length;++x){var D=A[x];var y=m.get(D.id);if(y){var w=D;D=y;D.set(w)}else{m.add(D)}}var E=[];m.each(function(H){var F=H.get("facetFacadeNode");var G=self.updateFacets(H,F);E.push(G)});var s=g.when.apply(null,E);s.done(function(){l.resolve()}).fail(function(){l.fail()})})}}})(jQuery);(function(){var c=Jassa.sponate;var b=Jassa.facete;b.FacetValueService=Class.create({initialize:function(d,e){this.sparqlService=d;this.facetTreeConfig=e},getFacetTreeConfig:function(){return this.facetTreeConfig},createFacetValueFetcher:function(p,f,g){g=g||true;var e=this.facetTreeConfig.getFacetConfig();var j=b.FaceteUtils.createFacetConceptGenerator(e);var h=j.createConceptResources(p,g);var n=new b.ConstraintTaggerFactory(e.getConstraintManager());var m=new c.StoreFacade(this.sparqlService);var k=c.SponateUtils.createDefaultLabelMap();m.addMap(k,"labels");labelsStore=m.labels;var l={};if(f){l={$or:[{hiddenLabels:{$elemMatch:{id:{$regex:f,$options:"i"}}}},{id:{$regex:f,$options:"i"}}]}}var d=labelsStore.find(l).concept(h,true);var o=new b.FacetValueFetcher(d,this.facetTreeConfig,p);return o}});b.FacetValueFetcher=Class.create({initialize:function(d,f,e){this.baseFlow=d;this.facetTreeConfig=f;this.path=e},fetchCount:function(){var d=this.baseFlow.count();return d},fetchData:function(g,d){var h=this.baseFlow.skip(g).limit(d);var e=this;var f=h.asList(true).pipe(function(n){var m=e.path;var k=e.facetTreeConfig.getFacetConfig();var j=new b.ConstraintTaggerFactory(k.getConstraintManager());var o=j.createConstraintTagger(m);var l=_(n).map(function(s){var r=s.id;var p=s.displayLabel?s.displayLabel:""+s.id;var q={displayLabel:p,path:m,node:r,tags:o.getTags(r)};return q});return l});return f}})})();(function(){var b=Jassa.util;var c=Jassa.rdf;var e=Jassa.sponate;var d=Jassa.facete;d.FacetConfig=Class.create({classLabel:"jassa.facete.FacetConfig",initialize:function(h,k,j,g,f){this.baseConcept=h;this.rootFacetNode=k;this.constraintManager=j;this.labelMap=g||e.SponateUtils.createDefaultLabelMap();this.pathTaggerManager=f||new d.ItemTaggerManager()},getBaseConcept:function(){return this.baseConcept},setBaseConcept:function(f){this.baseConcept=f},getRootFacetNode:function(){return this.rootFacetNode},setRootFacetNode:function(f){this.rootFacetNode=f},getConstraintManager:function(){return this.constraintManager},setConstraintManager:function(f){this.constraintManager=f},getLabelMap:function(){return this.labelMap},setLabelMap:function(){this.labelMap=labelMap},getPathTaggerManager:function(){return this.pathTaggerManager},hashCode:function(){var f=b.ObjectUtils.hashCode(this,true);return f}});d.FacetConfig.createDefaultFacetConfig=function(){var h=c.NodeFactory.createVar("s");var g=d.ConceptUtils.createSubjectConcept(h);var k=d.FacetNode.createRoot(h);var j=new d.ConstraintManager();var f=new d.FacetConfig(g,k,j);return f};d.FacetTreeConfig=Class.create({classLabel:"jassa.facete.FacetTreeConfig",initialize:function(j,k,g,l,h,f){this.facetConfig=j||d.FacetConfig.createDefaultFacetConfig();this.labelMap=k;this.expansionSet=g||new b.HashSet();this.expansionMap=l||new b.HashMap();this.facetStateProvider=h||new d.FacetStateProviderImpl(10);this.pathToFilterString=f||new b.HashMap()},getFacetConfig:function(){return this.facetConfig},getLabelMap:function(){return this.labelMap},getExpansionSet:function(){return this.expansionSet},getExpansionMap:function(){return this.expansionMap},getFacetStateProvider:function(){return this.facetStateProvider},getPathToFilterString:function(){return this.pathToFilterString},hashCode:function(){var f=b.ObjectUtils.hashCode(this,true);return f}});d.FaceteUtils={createFacetConceptGenerator:function(g){var h=g.getBaseConcept();var k=g.getRootFacetNode();var j=g.getConstraintManager();var f=this.createFacetConceptGenerator2(h,k,j);return f},createFacetConceptGenerator2:function(h,l,k){var j=new d.FacetGeneratorConfigProviderIndirect(new d.ConceptFactoryConst(h),new d.FacetNodeFactoryConst(l),k);var g=new d.FacetConceptGeneratorFactoryImpl(j);var f=g.createFacetConceptGenerator();return f},createFacetService:function(g,h){var f=this.createFacetConceptGenerator(h);var j=new d.FacetServiceImpl(g,f,h.getLabelMap(),h.getPathTaggerManager());return j},createFacetTreeService:function(j,m){var k=this.createFacetService(j,m.getFacetConfig());var g=m.getExpansionSet();var n=m.getExpansionMap();var h=m.getFacetStateProvider();var f=m.getPathToFilterString();var l=new d.FacetTreeServiceImpl(k,g,n,h,f);return l},createFacetTreeTagger:function(f){var h=new d.ItemTaggerManager();h.getTaggerMap()["filter"]=new d.ItemTaggerFilterString(f);var g=new d.FacetTreeTagger(h);return g}}})();(function(){var b=Jassa.service;var c=Jassa.rdf;var e=Jassa.facete;var d=Jassa.facete;d.test=function(){var q=new b.SparqlServiceHttp("http://localhost/sparql",[]);var k=new e.ConstraintManager();var h=c.NodeFactory.createVar("s");var o=e.ConceptUtils.createSubjectConcept(h);var f=e.FacetNode.createRoot(h);var j=new e.FacetStateProviderImpl();var p=new e.FacetGeneratorConfigProviderIndirect(new e.ConceptFactoryConst(o),new e.FacetNodeFactoryConst(f),k);var l=new d.FacetConceptGeneratorFactoryImpl(p);var g=l.createFacetConceptGenerator();var m=new e.FacetServiceImpl(q,g);m.fetchFacets(e.Path.parse("")).done(function(r){_(r).each(function(s){console.log("FacetItem: "+JSON.stringify(s))})});var n=m.createConceptFacetValues(e.Path.parse(""));console.log("FacetValues: "+n)};d.testQueryApi=function(){var h=new b.SparqlServiceHttp("http://localhost/sparql",[]);var f=h.createQueryExecution("Select * { ?s ?p ?o } Limit 10");var g=c.NodeFactory.createVar("s");f.execSelect().done(function(j){while(j.hasNext()){console.log(""+j.nextBinding().get(g))}})}})();(function(){var c=Jassa.rdf;var e=Jassa.sparql;var b=Jassa.util;var d=Jassa.facete;d.SortCondition=Class.create({initialize:function(g,f,h){this.columnId=g;this.sortDir=f==null?1:f;this.sortType=h||"data"},getColumnId:function(){return this.columnId},getSortType:function(){return this.sortType},setSortType:function(f){this.sortType=f},getSortDir:function(){return this.sortDir},setSortDir:function(f){this.sortDir=f}});d.FilterString=Class.create({initialize:function(g,f){this.str=g;this.mode=f}});d.ColumnView=Class.create({initialize:function(f,g){this.tableMod=f;this.columnId=g},getId:function(){return this.columnId},getSortConditions:function(){var f={};var g=this.columnId;_(this.tableMod.getSortConditions()).each(function(j){var k=j.getColumnId();if(k===g){var h=j.getSortType();f[h]=j.getSortDir()}});return f},getAggregator:function(){var f=this.tableMod.getAggregator(this.columnId);return f},setAggregator:function(f){this.tableMod.getAggregators()[this.columnId]=f}});d.Aggregator=Class.create({initialize:function(g,f){this.name=g;this.attrs=f},getName:function(){return this.name},getAttrs:function(){return this.attrs}});d.TableMod=Class.create({initialize:function(){this.columnIds=[];this.colIdToColView={};this.sortConditions=[];this.colIdToAgg={};this.limitAndOffset=new d.LimitAndOffset();this._isDistinct=true},isDistinct:function(){return this._isDistinct},setDistinct:function(f){this._isDistinct=f},getColumnIds:function(){return this.columnIds},getColumn:function(f){return this.colIdToColView[f]},getColumns:function(){var g=this;var f=_(this.columnIds).map(function(j){var h=g.colIdToColView[j];return h});return f},getSortConditions:function(){return this.sortConditions},getLimitAndOffset:function(){return this.limitAndOffset},getAggregator:function(g){var f=this.colIdToAgg[g];return f},getAggregators:function(){return this.colIdToAgg},addColumn:function(g,h){var f=this.colIdToColView[g];if(f){throw"Column "+g+" already part of the table"}f=new d.ColumnView(this,g);this.colIdToColView[g]=f;if(!h){this.columnIds.push(g)}return f},removeColumn:function(g){delete this.colIdToColView[g];var f=this;b.ArrayUtils.filter(this.columnIds,function(j){var h=g!=j;return h})}});d.ExprModFactoryAggCount=Class.create({createExpr:function(g){var f=new e.E_Count(g);return f}});d.ExprModFactoryAggMin=Class.create({createExpr:function(g){var f=new e.E_Min(g);return f}});d.ExprModFactoryAggMax=Class.create({createExpr:function(g){var f=new e.E_Min(g);return f}});d.ExprModRegistry={count:new d.ExprModFactoryAggCount,min:new d.ExprModFactoryAggMin,max:new d.ExprModFactoryAggMax};d.ElementFactoryFacetPaths=Class.create({initialize:function(f,g){this.facetConfig=f;this.paths=g||new b.ArrayList()},createElement:function(){var g=facete.FaceteUtils.createFacetConceptGenerator(this.facetConfig);var k=g.createConceptResources(new facete.Path());var m=this.facetConfig.getRootFacetNode();var h=_(this.paths).map(function(s){var n=m.forPath(s);console.log("facetNode: ",n);var q=n.getElements(true);var p=new e.ElementGroup(q);var o;if(q.length!==0){o=new e.ElementOptional(p)}else{o=p}return o});var l=[];l.push.apply(l,k.getElements());l.push.apply(l,h);var j=new e.ElementGroup(l);var f=j.flatten();return f}});d.FacetTableConfig=Class.create({initialize:function(f,g,h){this.facetConfig=f;this.tableMod=g||new d.TableMod();this.paths=h||new b.ArrayList()},getFacetConfig:function(){return this.facetConfig},getTableMod:function(){return this.tableMod},getPaths:function(){return this.paths},togglePath:function(j){var f=b.CollectionUtils.toggleItem(this.paths,j);var h=this.facetConfig.getRootFacetNode();var g=h.forPath(j);var k=g.getVar().getName();if(f){this.tableMod.addColumn(k)}else{this.tableMod.removeColumn(k)}},createDataConcept:function(){var m=new d.Path();var l=this.paths.getArray().slice(0);if(!this.paths.contains(m)){l.push(m)}var h=new d.ElementFactoryFacetPaths(this.facetConfig,l);var g=h.createElement();var k=this.facetConfig.getRootFacetNode();var j=k.getVar();var f=new d.Concept(g,j);return f}});d.QueryFactoryFacetTable=Class.create(d.QueryFactory,{initialize:function(f){this.facetTableConfig=f},createQuery:function(){var j=this.facetTableConfig.getFacetConfig();var l=this.facetTableConfig.getPaths().getArray();var k=this.facetTableConfig.getTableMod();var h=new d.ElementFactoryFacetPaths(j,l);var g=new d.QueryFactoryTableMod(h,k);var f=g.createQuery();return f}});d.TableUtils={createNgGridColumnDefs:function(h){var g=h.getColumns();var f=_(g).each(function(j){var k={field:j.getId(),displayName:j.getId()};return k});return f}};d.QueryFactoryTableMod=Class.create(d.QueryFactory,{initialize:function(f,g){this.elementFactory=f;this.tableMod=g},createQuery:function(){var o=this.tableMod;var k=this.elementFactory.createElement();if(!k){return null}var n=o.isDistinct();var p=new e.Query();p.getElements().push(k);var g=o.getColumns();var f={};var m=[];var j=[];_(g).each(function(z){var x=z.getId();var r=c.NodeFactory.createVar(x);var w=new e.ExprVar(r);var q=z.getAggregator();if(q){m.push(x);var y=q.getName();var u=d.ExprModRegistry[y];if(!u){throw"No aggExprFactory for "+y}var s=u.createExpr(w);w=s;p.getProject().add(r,w)}else{j.push(x);p.getProject().add(r)}f[x]=w});if(m.length>0){_(j).each(function(q){var r=f[q];p.getGroupBy().push(r)});n=false}var l=o.getLimitAndOffset();p.setLimit(l.getLimit());p.setOffset(l.getOffset());var h=o.getSortConditions();_(h).each(function(w){var r=w.getColumnId();var v=f[r];if(!v){console.log("[ERROR] Should not happen");throw"Should not happen"}var q=w.getSortDir();var u=w.getSortType();var s=null;switch(u){case"null":if(_(m).indexOf(r)<0){if(q>0){s=new e.SortCondition(new e.E_LogicalNot(new e.E_Bound(v)),1)}else{if(q<0){s=new e.SortCondition(new e.E_Bound(v),1)}}}break;case"data":s=!q?null:new e.SortCondition(v,q);break;default:console.log("Should not happen");throw"Should not happen"}if(s){p.getOrderBy().push(s)}});p.setDistinct(n);return p}});d.FaceteTable=Class.create({initialize:function(){this.varNode=varNode;this.paths=new b.ArrayList();this.tableMod=tableMod},getPaths:function(){return this.paths},getTableMod:function(){return this.tableMod},togglePath:function(h){var f=b.CollectionUtils.toggleItem(this.paths,h);var g=this.varNode.forPath(h);var j=g.getVarName();if(f){this.tableMode.addColumn(j)}else{this.tableMode.removeColumn(j)}}});d.FaceteTableModOld=Class.create({initialize:function(){this.columnIds=[];this.columnIdToPath=new b.HashBidiMap();this.columnIdToData={};this.tableMod=new d.TableMod()},getTableMod:function(){return this.tableMod},createColumnData:function(){var g=this;var f=_(this.columnIds).map(function(j){var h=g.columnIdToData;if(!h){h={};g.columnIdToData[j]=h}return h})},getColumns:function(){var g=this;var f=_(this.columnIds).map(function(j){var h=g.columnIdToData;return h})},putColumn:function(f,g){this.columnIds.push(g);this.columnIdToPath.put(f,g)},removeColumn:function(g){var f=this.tableMod;this.columnIdToPath.remove(g);f.removeColumn(g);b.ArrayUtils.filter(this.columnIds,function(h){return h!=g})},getPaths:function(){var g=this.columnIdToPath.getInverse().keyList();var f=new b.ArrayList();f.setItems(g);return f},togglePath:function(h){var f=this.columnIdToPath.getInverse();var g=f.get(h);if(g){this.removeColumn(g)}else{var g="col_"+this.columnIds.length;this.putColumn(g,h)}}})})();(function(){var b=Jassa.util;var c=Jassa.facete;c.FacetTreeTagger=Class.create({initialize:function(d){this.pathTagger=d},applyTags:function(d){c.FacetTreeUtils.applyTags(this.pathTagger,d);return d}});c.FacetTreeUtils={applyTags:function(f,d){var e=b.TreeUtils.flattenTree(d,"children");_(e).each(function(h){var j=h.item.getPath();var g=f.createTags(j);_(h).extend(g)});return d}};c.ItemTagger=Class.create({createTags:function(d){throw"Not overidden"}});c.ItemTaggerManager=Class.create(c.ItemTagger,{initialize:function(){this.taggerMap={}},getTaggerMap:function(){return this.taggerMap},createTags:function(e){var d={};_(this.taggerMap).each(function(h,g){var f=h.createTags(e);d[g]=f});return d}});c.ItemTaggerFilterString=Class.create(c.ItemTagger,{initialize:function(d){this.pathToFilterString=d},createTags:function(f){var e=this.pathToFilterString.get(f);var d={filterString:e};return d}});c.ItemTaggerMembership=Class.create(c.ItemTagger,{initialize:function(d){this.collection=d},createTags:function(e){var f=this.collection.contains(e);var d={isContained:f};return d}});c.ItemTaggerMapLinkPath=Class.create(c.ItemTagger,{initialize:function(d,e){this.mapLinkManager=d;this.conceptSpace=e},createTags:function(e){var d={isActive:isContained};return d}})})();(function(){var b=Jassa.geo;b.BBoxExprFactory=Class.create({createExpr:function(c){throw"Not implemented"}});b.BBoxExprFactoryWgs84=Class.create(b.BBoxExprFactory,{initialize:function(c,e,d){this.xVar=c;this.yVar=e;this.castNode=d},createExpr:function(d){var c=b.GeoExprUtils.createExprWgs84Intersects(this.xVar,this.yVar,d,this.castNode);return c}});b.BBoxExprFactoryWkt=Class.create(b.BBoxExprFactory,{initialize:function(c,e,d){this.wktVar=c;this.intersectsFnName=e;this.geomFromTextFnName=d},createExpr:function(d){var c=b.GeoExprUtils.createExprOgcIntersects(this.wktVar,d,this.intersectsFnName,this.geomFromTextFnName);return c}})})();(function(){var b=Jassa.geo;b.Point=Class.create({initialize:function(c,d){this.x=c;this.y=d},getX:function(){return this.x},getY:function(){return this.y}});b.Bounds=Class.create({initialize:function(f,c,d,e){this.left=f;this.right=d;this.bottom=c;this.top=e},containsPoint:function(c){return c.x>=this.left&&c.x<this.right&&c.y>=this.bottom&&c.y<this.top},getCenter:function(){return new b.Point(0.5*(this.left+this.right),0.5*(this.bottom+this.top))},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},contains:function(c){return c.left>=this.left&&c.right<this.right&&c.bottom>=this.bottom&&c.top<this.top},rangeX:function(){return new b.Range(this.left,this.right)},rangeY:function(){return new b.Range(this.bottom,this.top)},overlap:function(e){if(!e.rangeX||!e.rangeY){console.error("Missing range");throw"Error"}var d=this.rangeX().getOverlap(e.rangeX());if(!d){return null}var c=this.rangeY().getOverlap(e.rangeY());if(!c){return null}return new b.Bounds(d.min,c.min,c.max,d.max)},isOverlap:function(d){var c=this.overlap(d);return c!=null},toString:function(){return"["+this.left+" - "+this.right+", "+this.bottom+" - "+this.top+"]"}});b.Bounds.createFromJson=function(d){var c=new b.Bounds(d.left,d.bottom,d.right,d.top);return c};b.Range=Class.create({initialize:function(d,c){this.min=d;this.max=c},getOverlap:function(d){var e=Math.max(this.min,d.min);var c=Math.min(this.max,d.max);return(e>c)?null:new b.Range(e,c)}});b.QuadTree=Class.create({initialize:function(d,e,c){if(c==undefined){c=0.25}this.node=new b.Node(null,d,e,0,c);this.idToNodes=[]},getRootNode:function(){return this.node},aquireNodes:function(c,d){return this.node.aquireNodes(c,d)},query:function(c,d){return this.node.query(c,d)},insert:function(c){}});b.Node=Class.create({initialize:function(d,e,h,f,c,g){this.parent=d;this.parentChildIndex=g;this._bounds=e;this._maxDepth=h;this._depth=f;this._k=c;this.isLoaded=false;this.children=null;this.data={};this._minItemCount=null;this.infMinItemCount=null;this.idToPos={};this._classConstructor=b.Node},getId:function(){var d=this.parent;var f=d?d.getId():"";var e=this.parentChildIndex!=null?this.parentChildIndex:"r";var c=f+e;return c},isLeaf:function(){return !this.children},addItem:function(d,c){this.idToPos[d]=c},addItems:function(c){for(id in c){pos=c[id];this.addItem(id,pos)}},removeItem:function(c){delete this.idToPos[c]},setMinItemCount:function(c){this._minItemCount=c;this.infMinItemCount=c;if(this.parent){this.parent.updateInfMinItemCount()}},getMinItemCount:function(){return this._minItemCount},isCountComplete:function(){if(this.getMinItemCount()!==null){return true}if(this.children){var c=_.reduce(this.children,function(d,e){return d&&e.isCountComplete()},true);return c}return false},updateInfMinItemCount:function(){if(!this.children&&this._minItemCount!==null){return}var c=0;_(this.children).each(function(e,d){if(e._minItemCount!==null){c+=e._minItemCount}else{if(e.infMinItemCount){c+=e.infMinItemCount}}});this.infMinItemCount=c;if(this.parent){this.parent.updateInfMinItemCount()}},getBounds:function(){return this._bounds},getCenter:function(){return this._bounds.getCenter()},subdivide:function(){var f=this._depth+1;var g=this.getCenter();var d=this._k*0.5*this._bounds.getWidth();var e=this._k*0.5*this._bounds.getHeight();this.children=[];this.children[b.Node.TOP_LEFT]=new this._classConstructor(this,new b.Bounds(this._bounds.left,g.y-e,g.x+d,this._bounds.top),this._maxDepth,f,this._k,b.Node.TOP_LEFT);this.children[b.Node.TOP_RIGHT]=new this._classConstructor(this,new b.Bounds(g.x-d,g.y-e,this._bounds.right,this._bounds.top),this._maxDepth,f,this._k,b.Node.TOP_RIGHT);this.children[b.Node.BOTTOM_LEFT]=new this._classConstructor(this,new b.Bounds(this._bounds.left,this._bounds.bottom,g.x+d,g.y+e),this._maxDepth,f,this._k,b.Node.BOTTOM_LEFT);this.children[b.Node.BOTTOM_RIGHT]=new this._classConstructor(this,new b.Bounds(g.x-d,this._bounds.bottom,this._bounds.right,g.y+e),this._maxDepth,f,this._k,b.Node.BOTTOM_RIGHT)},_findIndexPoint:function(d){var c=this.getCenter(bounds);left=d.x<c.x;top=d.y>c.y;var e;if(left){if(top){e=Node.TOP_LEFT}else{e=Node.BOTTOM_LEFT}}else{if(top){e=Node.TOP_RIGHT}else{e=Node.BOTTOM_RIGHT}}return e},_findIndex:function(d){var c=new b.Point(d.left,d.top);return this._findIndexPoint(c)},getOverlaps:function(c){},query:function(d,e){var c=[];this.queryRec(d,c);return c},queryRec:function(g,c){if(!this._bounds.isOverlap(g)){return}var d=g.getWidth()/this._bounds.getWidth();var e=g.getHeight()/this._bounds.getHeight();var f=Math.max(d,e);if(this.isLoaded||!this.children||f>=depth){c.push(this);return}for(i in this.children){var j=this.children[i];j.queryRec(g,depth,c)}},splitFor:function(j,k,c){if(!this._bounds.isOverlap(j)){return}if(this.isLoaded){if(c){c.push(this)}return}var d=j.getWidth()/this._bounds.getWidth();var f=j.getHeight()/this._bounds.getHeight();var g=Math.max(d,f);if(g>=k||this._depth>=this._maxDepth){if(c){c.push(this)}return}if(!this.children){this.subdivide()}for(var e=0;e<this.children.length;++e){var l=this.children[e];l.splitFor(j,k,c)}},aquireNodes:function(d,e){var c=[];this.splitFor(d,e,c);return c},unlink:function(){if(!this.parent){return}for(i in this.parent.children){var c=this.parent.children[i];if(c==this){this.parent.children=new b.Node(this.parent,this._bounds,this._depth,this._k)}}}});b.Node.TOP_LEFT=0;b.Node.TOP_RIGHT=1;b.Node.BOTTOM_LEFT=2;b.Node.BOTTOM_RIGHT=3})();(function(){var b=Jassa.geo;b.GeoExprUtils={createExprWgs84Intersects:function(l,k,c,j){var d=new sparql.ExprVar(l);var h=new sparql.ExprVar(k);if(j){d=new sparql.E_Cast(d,j);h=new sparql.E_Cast(h,j)}var e=sparql.NodeValue.makeDecimal(c.left);var g=sparql.NodeValue.makeDecimal(c.right);var m=sparql.NodeValue.makeDecimal(c.bottom);var f=sparql.NodeValue.makeDecimal(c.top);var n=new sparql.E_LogicalAnd(new sparql.E_LogicalAnd(new sparql.E_GreaterThan(d,e),new sparql.E_LessThan(d,g)),new sparql.E_LogicalAnd(new sparql.E_GreaterThan(h,m),new sparql.E_LessThan(h,f)));return n},createExprOgcIntersects:function(j,c,g,e){var l="http://www.opengis.net/rdf#";g=g||(l+"intersects");e=e||(l+"geomFromText");var d=new sparql.ExprVar(j);var f=this.boundsToWkt(c);var h=sparql.NodeValue.makeString(f);var k=new sparql.E_Function(g,[d,new sparql.E_Function(e,[h])]);return k},boundsToWkt:function(e){var f=e.left;var d=e.bottom;var h=e.right;var g=e.top;var c="POLYGON(("+f+" "+d+","+h+" "+d+","+h+" "+g+","+f+" "+g+","+f+" "+d+"))";return c}}})();(function(f){var c=Jassa.geo;var e=function(k){var j=k.wkt;var h=c.WktUtils.extractPointsFromWkt(j);var g=c.WktUtils.createBBoxFromPoints(h);return g};var d="(\\d+(\\.\\d*)?)";var b="[^\\d]*";c.pointRegexPattern=new RegExp(b+"("+d+"\\s+"+d+b+")");c.WktUtils={extractPointsFromWkt:function(l){var j=[];while(match=c.pointRegexPattern.exec(l)){var k=match[2];var h=match[4];var g=parseFloat(k);var n=parseFloat(h);var m=new c.Point(g,n);j.push(m);l=l.replace(match[0],"")}return j},createBBoxFromPoints:function(j){var h=null;var m=null;var l=null;var k=null;_(j).each(function(o){var n=o.getX();var p=o.getY();h=!h?n:Math.min(h,n);m=!m?p:Math.min(m,p);l=!l?n:Math.max(l,n);k=!k?p:Math.max(k,p)});var g=new c.Bounds(h,m,l,k);return g}};c.QuadTreeCacheService=Class.create({});c.QuadTreeCache=Class.create({initialize:function(j,h,l,m,k){this.sparqlService=j;var g=new geo.Bounds(-180,-90,180,90);this.quadTree=new geo.QuadTree(g,18,0);this.concept=l;if(!k){k={}}this.maxItemsPerTileCount=k.maxItemsPerTileCount||25;this.maxGlobalItemCount=k.maxGlobalItemCount||50;this.geoMapFactory=h;this.fnGetBBox=m||c.defaultDocWktExtractorFn},fetchData:function(h){var g=this.runWorkflow(h);return g},createFlowForBounds:function(j){var h=new sponate.StoreFacade(this.sparqlService);var g=this.geoMapFactory.createMapForBounds(j);h.addMap(g,"geoMap");return h.geoMap},createFlowForGlobal:function(){var h=new sponate.StoreFacade(this.sparqlService);var g=this.geoMapFactory.createMapForGlobal();h.addMap(g,"geoMap");return h.geoMap},runCheckGlobal:function(){var g;var k=this.quadTree.getRootNode();var j=this;if(!k.checkedGlobal){var n=this.createFlowForGlobal().find().concept(this.concept).limit(j.maxGlobalItemCount);var m=n.count();var l=m.pipe(function(o){console.debug("Global check counts",o,j.maxGlobalItemCount);var p=!(o>=j.maxGlobalItemCount);k.canUseGlobal=p;k.checkedGlobal=true;return p});g=l}else{var h=f.Deferred();h.resolve(k.canUseGlobal);g=h.promise()}return g},runWorkflow:function(l){var k=f.Deferred();var j=this.quadTree.getRootNode();var h=this;this.runCheckGlobal().pipe(function(n){console.log("Can use global? ",n);var m;if(n){m=h.runGlobalWorkflow(j)}else{m=h.runTiledWorkflow(l)}m.done(function(o){k.resolve(o)}).fail(function(){k.fail()})}).fail(function(){k.fail()});var g=k.promise();return g},runGlobalWorkflow:function(k){var h=this;var j=this.createFlowForGlobal().find().concept(this.concept);var g=j.asList(true).pipe(function(l){h.loadTaskAction(k,l);return[k]});return g},runTiledWorkflow:function(l){var j=this;console.log("Aquiring nodes for "+l);var h=this.quadTree.aquireNodes(l,2);_(h).each(function(n){if(!n.data){n.data={}}});_(h).each(function(n){if(n.isCountComplete()&&n.infMinItemCount===0){n.isLoaded=true}});var k=_(h).filter(function(n){return j.isCountingNeeded(n)});var g=f.Deferred();var m=this.createCountTasks(k);f.when.apply(window,m).done(function(){nonLoadedNodes=_(h).filter(function(o){return j.isLoadingNeeded(o)});var n=j.createLoadTasks(nonLoadedNodes);f.when.apply(window,n).done(function(){f.when(j.postProcess(h)).then(function(){g.resolve(h)})})}).fail(function(){g.fail()});return g},createCountTask:function(l){var j=this;var h=j.maxItemsPerTileCount?j.maxItemsPerTileCount+1:null;var k=this.createFlowForBounds(l.getBounds()).find().concept(this.concept).limit(h);var g=k.count().pipe(function(m){l.setMinItemCount(m);if(m===0){l.isLoaded=true}});return g},isCountingNeeded:function(g){return !(this.isTooManyGeoms(g)||g.isCountComplete())},isLoadingNeeded:function(g){var h=g.isLoaded||(g.isCountComplete()&&g.infMinItemCount===0)||this.isTooManyGeoms(g);return !h},isTooManyGeoms:function(g){return g.infMinItemCount>=this.maxItemsPerTileCount},createCountTasks:function(j){var h=this;var g=_(j).chain().map(function(k){return h.createCountTask(k)}).compact().value();return g},loadTaskAction:function(g,h){g.data.docs=h;g.isLoaded=true},createLoadTasks:function(j){var h=this;var g=[];_(j).each(function(m){var l=h.createFlowForBounds(m.getBounds()).find().concept(h.concept);var k=l.asList(true).pipe(function(n){h.loadTaskAction(m,n)});g.push(k)});return g},finalizeLoading:function(h){var j=[];f.each(h,function(o,p){if(p.parent){j.push(p.parent)}});j=_.uniq(j);var n=false;do{n=false;for(var l in j){var m=j[l];var k=m.children;var g=c.tryMergeNode(m);if(!g){continue}n=true;f.each(k,function(o,q){var p=_.indexOf(h,q);if(p>=0){h[p]=undefined}});h.push(m);if(m.parent){j.push(m.parent)}break}}while(n==true);_.compact(h)},postProcess:function(j){return;var h=this;var g=f.Deferred();var k=_.map(j,function(p){if(!p.data||!p.data.geomToFeatureCount){return}p.data.graph=f.rdf.databank();var n=_.keys(p.data.geomToFeatureCount);var m=_.map(n,function(r){return sparql.Node.uri(r)});var q=h.geomPosFetcher.fetch(m).pipe(function(r){p.data.geomToPoint=r});var l=p.data.graph;_.each(p.data.geomToFeatureCount,function(v,r){var u=sparql.Node.uri(r);var y=sparql.Node.typedLit(v,xsd.integer);var w=""+u+" "+appvocab.featureCount+" "+y;var x=f.rdf.triple(w);l.add(x)});var o=f.when(q).then(function(){var v=p.data;var u=v.geomToLabel;var s=v.graph;_.each(u,function(w,y){var x=sparql.Node.uri(y);var B=sparql.Node.plainLit(w.value,w.language);var z=""+x+" "+rdfs.label+" "+B;var A=f.rdf.triple(z);s.add(A)});var r=v.geomToPoint;_.each(r,function(w,C){var B=sparql.Node.uri(C);var y=sparql.Node.typedLit(w.x,xsd.xdouble.value);var x=sparql.Node.typedLit(w.y,xsd.xdouble.value);var A=""+B+" "+geo.lon+" "+y;var z=""+B+" "+geo.lat+" "+x;s.add(A);s.add(z)})});return o});f.when.apply(window,k).then(function(){g.resolve()});return g.promise()}});c.tryMergeNode=function(h){return false;if(!h){return}var j=0;for(var g in h.children){var k=h.children[g];if(!k.isLoaded){return false}j+=k.itemCount}if(j>=self.maxItemsPerTileCount){return false}h.isLoaded=true;for(var g in h.children){var k=h.children[g];mergeMapsInPlace(h.idToPos,k.idToPos);mergeMapsInPlace(h.data.idToLabels,k.data.idToLabels);mergeMapsInPlace(h.data.idToTypes,k.data.idToTypes)}h.children=null;console.log("Merged a node");return true}})(jQuery);(function(){var b=Jassa.geo;b.ViewStateUtils={createStateHash:function(e,d,g){var j=e.getStateHash();var f=JSON.stringify(d);var h=""+g;var c=j+f+h;return c},diffObjects:function(c,g,e){var d=_(c).indexBy(e);var j=_(g).indexBy(e);var l=_(d).keys();var h=_(j).keys();var f=_(l).intersection(h);var k={retained:_(j).chain().pick(f).values().value(),added:_(d).chain().omit(h).values().value(),removed:_(j).chain().omit(l).values().value()};return k},diffViewStates:function(d,f){var h=d.getStateHash();var j=f?f.getStateHash():"";var e=d.getNodes();var k=f?f.getNodes():[];var c;if(h!=j){c={retained:[],added:e,removed:k}}else{var g=function(m){var l=m.getId();return l};c=this.diffObjects(e,k,g)}return c}};b.ViewState=Class.create({initialize:function(e,c,g,f,d){this.sparqlService=e;this.geoMap=c;this.concept=g;this.bounds=f;this.nodes=d},getStateHash:function(){return b.ViewStateUtils.createStateHash(this.sparqlService,this.geoMap,this.concept)},getSparqlService:function(){return this.sparqlService},getGeoMap:function(){return this.geoMap},getNodes:function(){return this.nodes},getBounds:function(){return this.bounds}});b.ViewStateFetcher=Class.create({initialize:function(){this.hashToCache={}},fetchViewState:function(d,g,e,c,j){j=j||{};_(j).defaults(b.ViewStateFetcher.defaultQuadTreeConfig);var m=g.createMapForGlobal();var f=b.ViewStateUtils.createStateHash(d,m,e);var l=this.hashToCache[f];if(!l){l=new b.QuadTreeCache(d,g,e,null,j);this.hashToCache[f]=l}var h=l.fetchData(c);var k=h.pipe(function(n){var o=new b.ViewState(d,m,e,c,n);return o});return k}});b.ViewStateFetcher.defaultQuadTreeConfig={maxItemsPerTileCount:1000,maxGlobalItemCount:5000}})();(function(){var b=Jassa.geo.openlayers;b.MapUtils={getExtent:function(g){var d=g.getExtent();var f=d.transform(g.projection,g.displayProjection);var c=new geo.Bounds(f.left,f.bottom,f.right,f.top);return c}}})();(function(){var d=Jassa.rdf;var n=Jassa.sparql;var l=Jassa.sponate;var c=Jassa.facete;var g=Jassa.geo;var m=d.NodeFactory.createVar("s");var h=d.NodeFactory.createVar("x");var e=d.NodeFactory.createVar("y");var k=d.NodeFactory.createVar("w");g.GeoConcepts={conceptWgs84:new c.Concept(n.ElementString.create("?s <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?x ;  <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?y"),m),conceptGeoVocab:new c.Concept(n.ElementString.create("?s <http://www.opengis.net/ont/geosparql#asWKT> ?w"),m)};var j=new l.MapParser();g.GeoMapUtils={wgs84GeoView:j.parseMap({name:"lonlat",template:[{id:g.GeoConcepts.conceptWgs84.getVar(),lon:h,lat:e,wkt:function(p){var o=d.NodeFactory.createTypedLiteralFromString("POINT("+p.get(h).getLiteralValue()+" "+p.get(e).getLiteralValue()+")","http://www.opengis.net/ont/geosparql#wktLiteral");return o}}],from:g.GeoConcepts.conceptWgs84.getElement()}),ogcGeoView:j.parseMap({name:"lonlat",template:[{id:g.GeoConcepts.conceptGeoVocab.getVar(),wkt:k}],from:g.GeoConcepts.conceptGeoVocab.getElement()})};var f="bif:st_intersects";var b="bif:st_geomFromText";g.GeoMapFactoryUtils={wgs84MapFactory:new l.GeoMapFactory(g.GeoMapUtils.wgs84GeoView,new g.BBoxExprFactoryWgs84(h,e)),ogcVirtMapFactory:new l.GeoMapFactory(g.GeoMapUtils.ogcGeoView,new g.BBoxExprFactoryWkt(k,f,b))}})();